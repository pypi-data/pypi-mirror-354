"use strict";(self.webpackChunkpackage_edit=self.webpackChunkpackage_edit||[]).push([[775],{8368:(t,e,i)=>{i.r(e),i.d(e,{default:()=>I});var n=function(){var t=this,e=t._self._c;return e("div",{staticClass:"agent-edit-block agent-detail",class:"agent-"+t.edits.agent_type.toLowerCase()},[t.showErrors?e("Errors",{attrs:{errors:t.errors}}):t._e(),t._v(" "),e("div",{staticClass:"agent-header"},[e("AgentTypeField",{model:{value:t.edits.agent_type,callback:function(e){t.$set(t.edits,"agent_type",e)},expression:"edits.agent_type"}}),t._v(" "),e("span",{staticClass:"display-name"},[e("em",[t._v(t._s(t.displayName))])]),t._v(" "),e("div",{staticClass:"edit-icons"},[t.edits.external_id?e("span",{staticClass:"edit-icon",attrs:{title:"Download contributor details from external source"},on:{click:t.syncAgent}},[e("i",{staticClass:"fas",class:t.loading.externalId?"fa-spinner fa-spin":"fa-arrow-alt-circle-down"})]):t._e(),t._v(" "),t.contributor.meta.is_temporary?t._e():e("span",{staticClass:"edit-icon",attrs:{title:"Remove this contributor"},on:{click:function(){return t.eventBus.$emit(t.events.removeContributor,t.contributorId)}}},[e("i",{staticClass:"fas fa-minus-circle"})])])],1),t._v(" "),e("div",{staticClass:"agent-id-edit attribution-row"},[e("select-field",{class:["wrap-small"],attrs:{options:Object.entries(t.controlledLists.agentIdSchemes),"opt-label":function(t){return t[1].label},"opt-value":function(t){return t[0]}},model:{value:t.edits.external_id_scheme,callback:function(e){t.$set(t.edits,"external_id_scheme",e)},expression:"edits.external_id_scheme"}},[t._v("\n            External ID scheme\n        ")]),t._v(" "),e("ValidatedField",{ref:"externalId",class:["wrap-small"],attrs:{validator:t.validateExternalId,placeholder:t.controlledLists.agentIdSchemes[t.edits.external_id_scheme].label},on:{validated:function(e){return t.$set(t.valid,"externalId",e)}},model:{value:t.edits.external_id,callback:function(e){t.$set(t.edits,"external_id",e)},expression:"edits.external_id"}},[e("i",{class:t.controlledLists.agentIdSchemes[t.edits.external_id_scheme].fa_icon}),t._v("\n            "+t._s(t.controlledLists.agentIdSchemes[t.edits.external_id_scheme].label)+"\n        ")])],1),t._v(" "),e("div",{staticClass:"expand-bar",attrs:{title:"Expand"},on:{click:function(){t.expand=!t.expand}}},[e("i",{staticClass:"fas",class:t.expand?"fa-caret-up":"fa-caret-down"}),t._v(" "),e("small",[t._v("Show all edit options")]),t._v(" "),e("i",{staticClass:"fas",class:t.expand?"fa-caret-up":"fa-caret-down"})]),t._v(" "),t.expand?[e("div",{staticClass:"agent-name-edit attribution-row"},["person"===t.edits.agent_type?[e("text-field",{attrs:{cls:["wrap-small"]},on:{leave:t.checkDuplicates},model:{value:t.edits.family_name,callback:function(e){t.$set(t.edits,"family_name",e)},expression:"edits.family_name"}},[t._v("\n                    Family name\n                ")]),t._v(" "),e("text-field",{attrs:{cls:["wrap-small"]},on:{leave:t.checkDuplicates},model:{value:t.edits.given_names,callback:function(e){t.$set(t.edits,"given_names",e)},expression:"edits.given_names"}},[t._v("\n                    Given name(s)\n                ")]),t._v(" "),t._l(t.idGen,(function(i){return e("div",{staticClass:"attribution-field one-line"},[e("label",{attrs:{for:i}},[t._v("\n                        Given names first\n                    ")]),t._v(" "),e("input",{directives:[{name:"model",rawName:"v-model",value:t.edits.given_names_first,expression:"edits.given_names_first"}],attrs:{id:i,type:"checkbox"},domProps:{checked:Array.isArray(t.edits.given_names_first)?-1<t._i(t.edits.given_names_first,null):t.edits.given_names_first},on:{change:function(e){var i=t.edits.given_names_first,n=e.target,s=!!n.checked;if(Array.isArray(i)){var a=t._i(i,null);n.checked?0>a&&t.$set(t.edits,"given_names_first",i.concat([null])):-1<a&&t.$set(t.edits,"given_names_first",i.slice(0,a).concat(i.slice(a+1)))}else t.$set(t.edits,"given_names_first",s)}}})])})),t._v(" "),e("help-tooltip",[t._v("\n                    Does this person's culture or language typically place given or family\n                    names first? (this does not affect sorting)\n                ")])]:t._e(),t._v(" "),"person"===t.edits.agent_type?t._e():[e("text-field",{on:{leave:t.checkDuplicates},model:{value:t.edits.name,callback:function(e){t.$set(t.edits,"name",e)},expression:"edits.name"}},[t._v("\n                    Name\n                ")]),t._v(" "),e("text-field",{on:{leave:t.checkDuplicates},model:{value:t.edits.location,callback:function(e){t.$set(t.edits,"location",e)},expression:"edits.location"}},[t._v("\n                    Location\n                ")])],t._v(" "),0<t.probableDuplicates.length?e("div",{staticStyle:{"grid-column":"span 2"}},[t._m(0),t._v(" "),e("div",{staticClass:"flex"},t._l(t.probableDuplicates,(function(i){return e("span",{staticStyle:{"margin-right":"5px"}},[t._v(t._s(i.label))])})),0)]):t._e()],2),t._v(" "),"person"===t.edits.agent_type?e("div",{staticClass:"agent-user-edit attribution-row"},[t.edits.user_id?t._e():e("autocomplete-field",{attrs:{options:t.userOptions,label:"Linked user account","item-id":"agent-user-"+t.contributorId},on:{typing:t.updateUserOptions},model:{value:t.edits.user_id,callback:function(e){t.$set(t.edits,"user_id",e)},expression:"edits.user_id"}}),t._v(" "),t.user?e("div",{staticClass:"attribution-field user-display"},[e("label",[t._v("Linked user account")]),t._v(" "),e("a",{attrs:{href:"/user/"+t.edits.user_id,target:"_blank"}},[t._v("\n                    "+t._s(t.user)+"\n                ")]),t._v(" "),e("i",{staticClass:"fas fa-times",on:{click:function(){t.edits.user_id=null}}})]):t._e(),t._v(" "),e("help-tooltip",[t._v("\n                If this contributor has a user account registered on this site, associate it\n                here\n            ")])],1):t._e(),t._v(" "),"person"===t.edits.agent_type?e("div",{staticClass:"agent-affiliations-edit attribution-row"},[e("autocomplete-list",{attrs:{options:t.affiliationOptions,label:"Add affiliation","item-id":"agent-affiliation-"+t.contributorId},on:{typing:t.updateAffiliationOptions},model:{value:t.affiliations,callback:function(e){t.affiliations=e},expression:"affiliations"}}),t._v(" "),e("help-tooltip",[t._v("\n                For affiliations that are associated with "),e("em",[t._v("this package only")]),t._v(". Only\n                includes contributors that have already been added to this page.\n            ")])],1):t._e()]:t._e(),t._v(" "),t.contributor.meta.is_temporary?t._e():e("div",{staticClass:"attribution-save"},[e("span",{staticClass:"btn",class:t.isValid?"btn-primary":"btn-disabled",on:{click:t.saveEdit}},[e("i",{staticClass:"fas fa-save"}),t._v("\n            Save changes\n        ")]),t._v(" "),e("span",{staticClass:"btn btn-primary",on:{click:t.stopEdit}},[e("i",{staticClass:"fas fa-times"}),t._v("\n            Cancel\n        ")])])],2)};n._withStripped=!0;var s=i(3851),a=i(7248),r=i(2942),o=i(3397),l=function(){var t=this,e=t._self._c;return e("div",{staticClass:"agent-type-edit",class:t.classes},t._l(t.options,(function(i,n){return e("span",{staticClass:"agent-type-option"},[e("input",{attrs:{type:"radio",id:t.optionId(n)},domProps:{value:n,checked:t.value===n},on:{change:t.setValue}}),t._v(" "),e("label",{attrs:{for:t.optionId(n),title:n}},[e("i",{class:i.fa_icon})])])})),0)};function d(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function c(t){for(var e,i=1;i<arguments.length;i++)e=null==arguments[i]?{}:arguments[i],i%2?d(Object(e),!0).forEach((function(i){u(t,i,e[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(e)):d(Object(e)).forEach((function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(e,i))}));return t}function u(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}l._withStripped=!0;const f={name:"AgentTypeField",extends:i(2599).Z,computed:c(c({},(0,s.rn)(["controlledLists"])),{},{options:function(){return this.controlledLists.agentTypes}}),methods:{optionId:function(t){return"agent-type-option-"+t+this.fieldId}}};var h=i(1900);const p=(0,h.Z)(f,l,[],!1,null,null,null).exports;var _=function(){var t=this,e=t._self._c;return e("div",{staticClass:"attribution-field-validated",class:t.classes},[e("label",{attrs:{for:t.fieldId}},[t._t("default")],2),t._v(" "),t.showHelpText?e("help-tooltip",[t._t("help")],2):t._e(),t._v(" "),e("input",{directives:[{name:"model",rawName:"v-model",value:t.textValue,expression:"textValue"}],staticClass:"form-control",class:{"form-control-invalid":t.failed},attrs:{type:"text",id:t.fieldId,placeholder:t.placeholder},domProps:{value:t.textValue},on:{input:[function(e){e.target.composing||(t.textValue=e.target.value)},t.debouncedSetValue],focusout:t.debouncedSetValue.flush}}),t._v(" "),e("i",{staticClass:"box-status-icon fas",class:t.boxIcon,attrs:{title:t.failed},on:{click:function(){return t.$emit("cancel")}}})],1)};_._withStripped=!0;var v=i(968),m=i(2834),b=i.n(m);const g={name:"ValidatedField",extends:v.Z,props:{validator:Function},data:function(){return{failed:!1,loading:!1,typing:!1,textValue:null}},computed:{boxIcon:function(){return this.failed?"fa-times":this.loading?"fa-spinner fa-spin":this.typing?"fa-xs fa-ellipsis-h":"fa-check"}},methods:{validate:function(){var t=this;this.loading=!0,this.failed=null,this.validator(this.textValue).then((function(e){t.$emit("input",e),t.textValue=e})).catch((function(e){t.failed=e,t.$emit("input",t.textValue)})).finally((function(){t.loading=!1,t.$emit("validated",!t.failed)}))}},created:function(){this.debouncedSetValue=b()(this.validate,500,{maxWait:500}),this.textValue=this.value,this.validate()},watch:{value:function(t){t&&!this.loading&&(this.textValue=t)},loading:function(t){!t&&this.value!==this.textValue&&this.value&&(this.textValue=this.value)}}};const y=(0,h.Z)(g,_,[],!1,null,null,null).exports;var x=i(1283);function w(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function O(t){for(var e,i=1;i<arguments.length;i++)e=null==arguments[i]?{}:arguments[i],i%2?w(Object(e),!0).forEach((function(i){k(t,i,e[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(e)):w(Object(e)).forEach((function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(e,i))}));return t}function k(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}const C={name:"EditAgent",extends:r.Z,components:{AgentTypeField:p,ValidatedField:y,Errors:function(){return i.e(555).then(i.bind(i,5555))}},data:function(){return{affiliations:[],userOptions:[],affiliationOptions:[],user:null,probableDuplicates:[]}},computed:{contributor:function(){return o.Py.query().with("meta").with("affiliations.other_agent").with("affiliations.meta").find(this.contributorId)},displayName:function(){return"person"===this.edits.agent_type?this.edits.given_names_first?[this.edits.given_names,this.edits.family_name].join(" "):[this.edits.family_name,this.edits.given_names].join(" "):this.edits.name},isValid:function(){this.errors=[];var t=!1,e=function(t){return null==t||""===t.trim()};if("person"!==this.edits.agent_type)(t=!e(this.edits.name))||this.errors.push("Name not provided.");else{var i=!e(this.edits.family_name);i||this.errors.push("Family name not provided.");var n=!e(this.edits.given_names);n||this.errors.push("Given names not provided."),t=n&&i}var s,a=this.valid.externalId||e(this.edits.external_id);if(!a){try{s=this.controlledLists.agentIdSchemes[this.edits.external_id_scheme].label}catch(t){s=this.edits.external_id_scheme}this.errors.push("".concat(s," is not valid."))}return t&&a}},methods:O(O({},(0,s.nv)(["removeContributor"])),{},{checkDuplicates:function(){var t=this;return this.isValid?void(0,a.U2)("agent_list",{q:this.displayName,mode:"duplicates"}).then((function(e){t.$set(t,"probableDuplicates",e.map((function(t){var e=t.display_name;return t.external_id&&(e+=" (".concat(t.external_id,")")),{label:e,value:t}})).filter((function(e){return!t.contributorId||t.contributorId!==e.value.id})))})):void this.$set(this,"probableDuplicates",[])},refresh:function(){var t=this;if(this.edits=this.contributor.getCopy(),this.affiliations=this.contributor.affiliations.filter((function(t){return!t.meta.to_delete})).map((function(t){return{label:t.other_agent.displayName,value:t.other_agent_id,record:t.other_agent}})),this.edits.agent_type||this.edits.external_id_scheme||this.$set(this.edits,"agent_type",Object.keys(this.controlledLists.agentTypes)[0]),!this.edits.agent_type&&this.edits.external_id_scheme){var e=Object.entries(this.controlledLists.agentTypes).filter((function(e){return e[1].default===t.edits.external_id_scheme}));0<e.length&&this.$set(this.edits,"agent_type",e[0][0])}this.edits.external_id_scheme||this.$set(this.edits,"external_id_scheme",this.controlledLists.agentTypes[this.edits.agent_type].default_scheme),void 0===this.edits.given_names_first&&this.$set(this.edits,"given_names_first",!0),this.edits.user_id&&(0,a.U2)("user_show",{id:this.edits.user_id}).then((function(e){t.user=e.display_name})),this.$emit("validated",this.isValid)},saveEdit:function(){var t=this,e=this.isValid&&this.canSave;if(this.showErrors=!e,e){var i=[];this.settings.canEdit&&!this.contributor.meta.is_new&&Object.entries(this.edits).every((function(e){return t.contributor[e[0]]===e[1]||(i.push(o.Py.updateMeta(t.contributorId,{is_dirty:!0})),!1)}));var n=this.affiliations.filter((function(e){return-1===t.contributor.affiliations.findIndex((function(t){return t.other_agent_id===e.value}))})).map((function(e){var n={agent_id:t.contributorId,other_agent_id:e.value,package_id:t.settings.packageId,meta:{is_new:!0,is_temporary:t.contributor.is_temporary}};return o.Py.query().where("id",e.value).exists()||(e.record.meta={is_new:!0},i.push(o.Py.insert({data:e.record}))),n}));return i.push(o.n$.insert({data:n})),this.contributor.affiliations.filter((function(e){return-1===t.affiliations.findIndex((function(t){return t.value===e.other_agent_id}))})).forEach((function(t){i.push(o.n$.updateMeta(t.id,{to_delete:!0}))})),i.push(o.Py.update({where:this.contributorId,data:this.edits})),Promise.all(i).then((function(){t.$emit(t.events.editsSaved)})).catch((function(t){return x.error(t)})).finally((function(){t.stopEdit()}))}},stopEdit:function(){var t=this;o.Py.updateMeta(this.contributorId,{is_editing:!1}).then((function(){t.$emit(t.events.editsDone)}))},syncAgent:function(){var t=this;this.loading.externalId=!0,(0,a.U2)("agent_external_read",{external_id:this.edits.external_id,external_id_scheme:this.edits.external_id_scheme}).then((function(e){Object.entries(e).forEach((function(e){t.edits[e[0]]=e[1]}))})).finally((function(){t.loading.externalId=!1}))},updateAffiliationOptions:function(t){var e=this,i=o.Py.query().where("isActive",!0).where((function(t){return t.id!==e.contributorId})).where((function(t){return-1===e.affiliations.findIndex((function(e){return e.value===t.id}))}));t&&""!==t&&(i=i.where((function(e){var i=t.toLowerCase(),n=!!e.family_name&&e.family_name.toLowerCase().startsWith(i),s=!!e.given_names&&e.given_names.toLowerCase().startsWith(i),a=!!e.name&&e.name.toLowerCase().startsWith(i);return n||s||a}))),this.affiliationOptions=i.get().map((function(t){return{label:t.displayName,value:t.id,record:t}}))},updateUserOptions:function(t){var e=this;return""===t||null===t?void(this.userOptions=[]):void(0,a.U2)("user_list",{q:t}).then((function(t){e.userOptions=t.map((function(t){return{label:t.display_name,value:t.id}}))}))},validateExternalId:function(t){return t?(0,a.v_)("validate_external_id",{external_id:t,external_id_scheme:this.edits.external_id_scheme},"validateExternalId").then((function(t){if(t.id)return t.id;throw new Error(t.error||"Not valid")})):new Promise((function(t){t(null)}))}}),created:function(){var t=this;this.refresh(),this.expand=!this.isValid,this.eventBus.$on(this.events.saveAgent,(function(e){e===t.contributorId&&t.saveEdit()}))},watch:{"edits.user_id":function(){var t=this;this.edits.user_id?(0,a.U2)("user_show",{id:this.edits.user_id}).then((function(e){t.user=e.display_name})):this.user=null}}};const I=(0,h.Z)(C,n,[function(){var t=this._self._c;return t("small",[t("b",[this._v("Please ensure this contributor is not duplicating any of these\n                       existing contributors:")])])}],!1,null,null,null).exports},2942:(t,e,i)=>{i.d(e,{Z:()=>o});var n=function(){return(0,this._self._c)("div")};n._withStripped=!0;var s=i(5170),a=i(7570);const r={name:"EditBase",extends:s.Z,abstract:!0,props:{canSave:{default:function(){return!0}}},data:function(){return{edits:{},errors:[],showErrors:!1,loading:{},expand:!1,valid:{}}},computed:{idGen:function(){return[(0,a.x0)(8)]}},methods:{saveEdit:function(){this.isValid||this.errors.push(["Not valid"])},stopEdit:function(){this.$emit(this.events.editsDone)}},watch:{errors:function(t){0===t.length&&(this.showErrors=!1)}}};const o=(0,i(1900).Z)(r,n,[],!1,null,null,null).exports}}]);
