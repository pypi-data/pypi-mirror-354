import{u as V,r as a,n as He,I as Z,w as ye,a as Qe,b as We,c as ve,s as Ue,j as e,B as P,d as H,e as Ge,T as L,_ as R,i as A,f as Ze,p as Xe,g as G,h as Q,k as X,l as U,m as q,o as Re,q as de,S as ke,D as Ye,t as Je,v as et,x as je,L as tt,y as we,z as st,A as nt,C as at}from"./index-DLrGop_Z.js";import{R as $e,S as he,D as rt,T as ot,F as Ce,a as ct,b as it,c as lt,d as Oe,g as ut,e as Y,L as ee,B as dt}from"./index-B-2OoAFc.js";import{R as te,A as Te,S as Be,u as _e,M as se}from"./keychain.query-o8ku5fpt.js";import{R as ht,S as pt,P as mt}from"./CloseOutlined-CJElw7vb.js";import{S as ft,F as E,I as K}from"./index-Hs0TOhp_.js";var gt={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M862 465.3h-81c-4.6 0-9 2-12.1 5.5L550 723.1V160c0-4.4-3.6-8-8-8h-60c-4.4 0-8 3.6-8 8v563.1L255.1 470.8c-3-3.5-7.4-5.5-12.1-5.5h-81c-6.8 0-10.5 8.1-6 13.2L487.9 861a31.96 31.96 0 0048.3 0L868 478.5c4.5-5.2.8-13.2-6-13.2z"}}]},name:"arrow-down",theme:"outlined"},xt={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M257.7 752c2 0 4-.2 6-.5L431.9 722c2-.4 3.9-1.3 5.3-2.8l423.9-423.9a9.96 9.96 0 000-14.1L694.9 114.9c-1.9-1.9-4.4-2.9-7.1-2.9s-5.2 1-7.1 2.9L256.8 538.8c-1.5 1.5-2.4 3.3-2.8 5.3l-29.5 168.2a33.5 33.5 0 009.4 29.8c6.6 6.4 14.9 9.9 23.8 9.9zm67.4-174.4L687.8 215l73.3 73.3-362.7 362.6-88.9 15.7 15.6-89zM880 836H144c-17.7 0-32 14.3-32 32v36c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-36c0-17.7-14.3-32-32-32z"}}]},name:"edit",theme:"outlined"},bt={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M608 112c-167.9 0-304 136.1-304 304 0 70.3 23.9 135 63.9 186.5l-41.1 41.1-62.3-62.3a8.15 8.15 0 00-11.4 0l-39.8 39.8a8.15 8.15 0 000 11.4l62.3 62.3-44.9 44.9-62.3-62.3a8.15 8.15 0 00-11.4 0l-39.8 39.8a8.15 8.15 0 000 11.4l62.3 62.3-65.3 65.3a8.03 8.03 0 000 11.3l42.3 42.3c3.1 3.1 8.2 3.1 11.3 0l253.6-253.6A304.06 304.06 0 00608 720c167.9 0 304-136.1 304-304S775.9 112 608 112zm161.2 465.2C726.2 620.3 668.9 644 608 644c-60.9 0-118.2-23.7-161.2-66.8-43.1-43-66.8-100.3-66.8-161.2 0-60.9 23.7-118.2 66.8-161.2 43-43.1 100.3-66.8 161.2-66.8 60.9 0 118.2 23.7 161.2 66.8 43.1 43 66.8 100.3 66.8 161.2 0 60.9-23.7 118.2-66.8 161.2z"}}]},name:"key",theme:"outlined"},yt={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M909.1 209.3l-56.4 44.1C775.8 155.1 656.2 92 521.9 92 290 92 102.3 279.5 102 511.5 101.7 743.7 289.8 932 521.9 932c181.3 0 335.8-115 394.6-276.1 1.5-4.2-.7-8.9-4.9-10.3l-56.7-19.5a8 8 0 00-10.1 4.8c-1.8 5-3.8 10-5.9 14.9-17.3 41-42.1 77.8-73.7 109.4A344.77 344.77 0 01655.9 829c-42.3 17.9-87.4 27-133.8 27-46.5 0-91.5-9.1-133.8-27A341.5 341.5 0 01279 755.2a342.16 342.16 0 01-73.7-109.4c-17.9-42.4-27-87.4-27-133.9s9.1-91.5 27-133.9c17.3-41 42.1-77.8 73.7-109.4 31.6-31.6 68.4-56.4 109.3-73.8 42.3-17.9 87.4-27 133.8-27 46.5 0 91.5 9.1 133.8 27a341.5 341.5 0 01109.3 73.8c9.9 9.9 19.2 20.4 27.8 31.4l-60.2 47a8 8 0 003 14.1l175.6 43c5 1.2 9.9-2.6 9.9-7.7l.8-180.9c-.1-6.6-7.8-10.3-13-6.2z"}}]},name:"reload",theme:"outlined"};function Me(s,t){const n=V(),r=n.getQueryCache();return a.useSyncExternalStore(a.useCallback(l=>r.subscribe(He.batchCalls(l)),[r]),()=>n.isFetching(s),()=>n.isFetching(s))}function ne(){return ne=Object.assign?Object.assign.bind():function(s){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(s[r]=n[r])}return s},ne.apply(this,arguments)}const vt=(s,t)=>a.createElement(Z,ne({},s,{ref:t,icon:gt})),kt=a.forwardRef(vt);function ae(){return ae=Object.assign?Object.assign.bind():function(s){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(s[r]=n[r])}return s},ae.apply(this,arguments)}const jt=(s,t)=>a.createElement(Z,ae({},s,{ref:t,icon:xt})),wt=a.forwardRef(jt);function re(){return re=Object.assign?Object.assign.bind():function(s){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(s[r]=n[r])}return s},re.apply(this,arguments)}const Ct=(s,t)=>a.createElement(Z,re({},s,{ref:t,icon:bt})),Ft=a.forwardRef(Ct);function oe(){return oe=Object.assign?Object.assign.bind():function(s){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(s[r]=n[r])}return s},oe.apply(this,arguments)}const Nt=(s,t)=>a.createElement(Z,oe({},s,{ref:t,icon:yt})),qe=a.forwardRef(Nt);function ce(){return ce=Object.assign?Object.assign.bind():function(s){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(s[r]=n[r])}return s},ce.apply(this,arguments)}const Pt=(s,t)=>a.createElement(Z,ce({},s,{ref:t,icon:ft})),Et=a.forwardRef(Pt);function It(s,t,n){const r=a.useRef({});return(!("value"in r.current)||n(r.current.condition,t))&&(r.current.value=s(),r.current.condition=t),r.current.value}Number(a.version.split(".")[0]);const St=(s,t)=>{typeof s=="function"?s(t):typeof s=="object"&&s&&"current"in s&&(s.current=t)},Rt=(...s)=>{const t=s.filter(Boolean);return t.length<=1?t[0]:n=>{s.forEach(r=>{St(r,n)})}},$t=(...s)=>It(()=>Rt(...s),s,(t,n)=>t.length!==n.length||t.every((r,l)=>r!==n[l]));function J(){return J=Object.assign?Object.assign.bind():function(s){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(s[r]=n[r])}return s},J.apply(this,arguments)}const Le=a.forwardRef((s,t)=>{const{className:n,component:r,viewBox:l,spin:d,rotate:o,tabIndex:c,onClick:p,children:f,...j}=s,m=a.useRef(),x=$t(m,t);ye(!!(r||f),"Should have `component` prop or `children`."),Qe(m);const{prefixCls:I="anticon",rootClassName:k}=a.useContext(We),h=ve(k,I,{[`${I}-spin`]:!!d&&!!r},n),O=ve({[`${I}-spin`]:!!d}),y=o?{msTransform:`rotate(${o}deg)`,transform:`rotate(${o}deg)`}:void 0,S={...Ue,className:O,style:y,viewBox:l};l||delete S.viewBox;const B=()=>r?a.createElement(r,S,f):f?(ye(!!l||a.Children.count(f)===1&&a.isValidElement(f)&&a.Children.only(f).type==="use","Make sure that you provide correct `viewBox` prop (default `0 0 1024 1024`) to the icon."),a.createElement("svg",J({},S,{viewBox:l}),f)):null;let g=c;return g===void 0&&p&&(g=-1),a.createElement("span",J({role:"img"},j,{ref:x,tabIndex:g,onClick:p,className:h}),B())});Le.displayName="AntdIcon";function Ot({isOpen:s,onClose:t,children:n,title:r,width:l=400,offset:d={right:24,top:0,bottom:0},footer:o}){const[c,p]=a.useState(!1),[f,j]=a.useState(!1),m={right:d.right??24,top:d.top??0,bottom:d.bottom??0};return a.useEffect(()=>{if(s)p(!0),requestAnimationFrame(()=>{requestAnimationFrame(()=>{j(!0)})});else{j(!1);const x=setTimeout(()=>{p(!1)},300);return()=>clearTimeout(x)}},[s]),c?e.jsxs("div",{className:"fixed inset-0 z-50",children:[e.jsx("div",{className:"absolute inset-0 bg-opacity-25 transition-opacity duration-300",style:{opacity:f?1:0}}),e.jsxs("div",{className:"absolute right-0 bg-white shadow-lg rounded-lg flex flex-col",style:{width:typeof l=="number"?`${l}px`:l,transform:f?"translateX(0) scale(1)":"translateX(100%) scale(0.9)",transformOrigin:"right center",right:`${m.right}px`,top:m.top>0?m.top:0,bottom:m.bottom>0?m.bottom:0,height:m.top>0||m.bottom>0?"auto":"100%",pointerEvents:"auto",overflowY:"auto",maxHeight:`calc(100vh - ${m.top+m.bottom}px)`,boxShadow:"-4px 0 15px rgba(0, 0, 0, 0.1)",transition:"transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)"},children:[e.jsxs("div",{className:"flex justify-between items-center p-4 border-b border-gray-200",children:[e.jsx("h3",{className:"text-lg font-medium",children:r}),e.jsx(P,{onClick:t,type:"text",size:"small",icon:e.jsx(ht,{})})]}),e.jsx("div",{className:"p-6 flex-1 min-h-0 overflow-y-auto",children:n}),o&&e.jsx("div",{className:"p-4 border-t border-gray-200",children:o})]})]}):null}function pe(s){return t=>({validator:async(n,r)=>{const l=t.getFieldsValue(),d=R.get(l,n.field.replace("path","endpoint")),o=R.get(l,n.field.replace("path","keychain_id"));if(!o)return Promise.reject(new Error(A.t("bucketForm.keychainIdRequired")));if(!d)return Promise.reject(new Error(A.t("bucketForm.endpointRequired")));if(!r)return Promise.reject(new Error(A.t("bucketForm.pathRequired")));if(!r.startsWith("s3://"))return Promise.reject(new Error(A.t("bucketForm.pathValidMessage")));try{const c=R.find(s,f=>f.value===o);if(!c)return Promise.reject(new Error(A.t("bucketForm.keychainIdRequired")));const p=await Ze({endpoint:d,keychain_id:c.value,path:r});return R.get(p,"data")?Promise.resolve():Promise.reject(new Error(A.t("bucketForm.noPermission")))}catch(c){return Promise.reject(new Error(R.get(c,"message")))}}})}const ie="open-bucket-manager";function Tt(s){const t=new CustomEvent(ie,{detail:s});document.dispatchEvent(t)}function me(){return{async validator(s,t){if(!t)return Promise.reject(new Error(A.t("bucketForm.endpointRequired")));const n=await Xe(t);return R.get(n,"data",!1)?Promise.resolve(A.t("bucketForm.endpointAccessible")):Promise.reject(new Error(A.t("bucketForm.endpointInvalid")))}}}function ze(){const{data:s,isLoading:t,...n}=_e();return{keyOptions:a.useMemo(()=>R.map(s,l=>({label:l.name,value:l.id,access_key_id:l.access_key_id})),[s]),isLoading:t,keyChainQuery:n}}function Bt({modalRef:s,className:t,showTrigger:n=!0}){const[r,l]=a.useState(!1),[d]=E.useForm(),{t:o}=H(),{keyOptions:c,isLoading:p,keyChainQuery:f}=ze(),{mutateAsync:j,isPending:m}=Ge(),x=V();a.useEffect(()=>{const y=S=>{d.resetFields(),S.detail&&setTimeout(()=>{d.setFieldsValue(S.detail)}),l(!0)};return document.addEventListener(ie,y),()=>{document.removeEventListener(ie,y)}},[d,r]),a.useImperativeHandle(s,()=>({open:y=>{d.resetFields(),y&&setTimeout(()=>{d.setFieldsValue(y)}),l(!0)},close:()=>{d.resetFields(),l(!1)}}));const I=()=>{d.resetFields(),l(!1)},k=async y=>{if(R.size(y==null?void 0:y.buckets)===0){G.error(o("bucketForm.atLeastOnePath"));return}await j(y.buckets),G.success(o("bucketForm.pathAdded")),I(),x.invalidateQueries({queryKey:["bucket"]})},h=()=>{d.submit()},O=a.useMemo(()=>{var y;return{buckets:[{keychain_id:(y=c[0])==null?void 0:y.value,endpoint:"",path:""}]}},[c]);return e.jsxs(e.Fragment,{children:[n&&e.jsx(L,{title:o("bucketForm.triggerTooltipMessage"),placement:"bottomLeft",children:e.jsx(P,{className:t,onClick:()=>l(!0),type:"primary",icon:e.jsx(te,{}),children:o("bucketForm.addBucket")})}),e.jsx(Ot,{isOpen:r,onClose:I,title:o("bucketForm.addBucket"),width:600,offset:{right:16,top:72,bottom:16},footer:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(P,{type:"primary",loading:m,onClick:h,children:o("bucketForm.save")}),e.jsx(P,{type:"default",onClick:I,children:o("bucketForm.cancel")})]}),children:e.jsx("div",{className:"",children:e.jsxs(E,{form:d,layout:"vertical",onFinish:k,initialValues:O,children:[e.jsx(Te,{className:"!mb-4",type:"info",showIcon:!0,message:e.jsxs("div",{children:[o("bucketForm.alertMessage")," → ",e.jsxs(P,{type:"link",target:"_blank",size:"small",className:"!px-0",href:"/keychain",children:[o("bucketForm.AS&SKManagement"),e.jsx($e,{})]})]})}),e.jsx(E.List,{name:"buckets",children:(y,{add:S,remove:B})=>e.jsxs(e.Fragment,{children:[y.map((g,v)=>e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("span",{className:"font-bold text-black",children:[o("bucketForm.path"),"  ",v+1]}),e.jsx(L,{title:o("bucketForm.remove"),children:e.jsx(P,{size:"small",type:"text",danger:!0,icon:e.jsx(Le,{component:Be}),onClick:()=>B(v)})})]}),e.jsx(E.Item,{className:"!mb-0",label:e.jsxs("div",{className:"flex items-center gap-2",children:["AK&SK",e.jsx(L,{title:o("bucketForm.refresh"),children:e.jsx(P,{type:"text",size:"small",icon:e.jsx(qe,{}),loading:f.isFetching,onClick:()=>f.refetch()})})]}),required:!0,name:[v,"keychain_id"],rules:[{required:!0,message:o("bucketForm.keychainIdRequired")}],children:e.jsx(he,{className:"w-full",loading:p,options:c,placeholder:o("bucketForm.keychainIdRequired"),optionRender:C=>e.jsxs("div",{className:"flex flex-col gap-1",children:[C.label,e.jsx("span",{className:"text-gray-400",children:C.data.access_key_id})]})})}),e.jsx(E.Item,{label:"Endpoint",required:!0,hasFeedback:!0,className:"!mb-0",name:[v,"endpoint"],validateDebounce:1e3,rules:[{type:"url",message:o("bucketForm.endpointValidMessage")},me],children:e.jsx(K,{placeholder:o("bucketForm.endpointPlaceholder")})}),e.jsx(E.Item,{label:o("bucketForm.path"),tooltip:o("bucketForm.pathTooltip"),required:!0,hasFeedback:!0,className:"!mb-0",name:[v,"path"],validateDebounce:1e3,rules:[pe(c)],children:e.jsx(K,{placeholder:o("bucketForm.pathPlaceholder")})}),y.length>1&&v<y.length-1&&e.jsx(rt,{})]},g.key)),e.jsx(P,{className:"mt-6",block:!0,icon:e.jsx(te,{}),onClick:()=>S(),children:o("bucketForm.add")})]})})]})})})]})}const _t="_tree_1b5hq_2",Fe={tree:_t},Mt=s=>a.createElement("svg",{stroke:"currentColor",fill:"currentColor",strokeWidth:0,viewBox:"0 0 24 24",height:"1em",width:"1em",xmlns:"http://www.w3.org/2000/svg",...s},a.createElement("path",{d:"M4 6h2v12H4zm4 7h8.586l-4.293 4.293 1.414 1.414L20.414 12l-6.707-6.707-1.414 1.414L16.586 11H8z"})),qt=s=>a.createElement("svg",{stroke:"currentColor",fill:"currentColor",strokeWidth:0,viewBox:"0 0 24 24",height:"1em",width:"1em",xmlns:"http://www.w3.org/2000/svg",...s},a.createElement("path",{d:"M18 6h2v12h-2zm-2 5H7.414l4.293-4.293-1.414-1.414L3.586 12l6.707 6.707 1.414-1.414L7.414 13H16z"})),Lt=s=>a.createElement("svg",{width:"1em",height:"1em",viewBox:"0 0 20 20",fill:"none",xmlns:"http://www.w3.org/2000/svg",...s},a.createElement("path",{d:"M8.03243 3.33325C8.25344 3.33325 8.4654 3.42105 8.62168 3.57733L9.80019 4.75584C9.95647 4.91212 10.1684 4.99992 10.3894 4.99992H17.5443C18.0045 4.99992 18.3776 5.37301 18.3776 5.83325V15.8333C18.3776 16.2935 18.0045 16.6666 17.5443 16.6666H2.54427C2.08403 16.6666 1.71094 16.2935 1.71094 15.8333V4.16659C1.71094 3.70635 2.08403 3.33325 2.54427 3.33325H8.03243Z",fill:"#3477EB"}),a.createElement("path",{d:"M3.37695 8.75C3.37695 8.05964 3.9366 7.5 4.62695 7.5H15.4603C16.1506 7.5 16.7103 8.05964 16.7103 8.75H3.37695Z",fill:"white"}));function Ne(s){const t=s.replace(/^s3:\/\//,"").split("/");return t.map((n,r)=>{const l=t.slice(0,r+1).join("/");return{fragment:n,path:l,fullPath:`s3://${l}/`}})}function zt(){const{open:s,setOpen:t}=Ae(),{t:n}=H(),r=a.useCallback(()=>{document.dispatchEvent(new CustomEvent("toggleDirectoryTree",{detail:{open:!s}}))},[s,t]);return e.jsx(L,{title:n(s?"directoryTree.hide":"directoryTree.show"),placement:"bottomLeft",children:e.jsx(P,{icon:s?e.jsx(qt,{}):e.jsx(Mt,{}),onClick:r})})}const De=a.createContext({open:!1,setOpen:()=>{}});function Ae(){const s=a.useContext(De);if(!s)throw new Error("useTreeContext must be used within a DirectoryTreeProvider");return s}function Dt({children:s}){const[t,n]=a.useState(!1),r=a.useMemo(()=>({open:t,setOpen:n}),[t]);return e.jsx(De.Provider,{value:r,children:s})}function At({treeRef:s,className:t}){const[n,r]=a.useState({}),l=a.useRef(!1),o=Q().search,c=o.path||"",p=c==null?void 0:c.split("?")[0],[f,j]=a.useState([`${o.id}-${p}`]),[m,x]=a.useState([c]),{open:I,setOpen:k}=Ae(),[h,O]=a.useState(!1),y=V(),S=X(),B=Number(o.page_size)||50,{t:g}=H(),v=a.useCallback((i,u,F)=>i?["bucket",{path:i,pageNo:u??R.get(n,[i,"pageNo"],1),pageSize:B,id:F??o.id}]:["bucket"],[n,o.id]);a.useEffect(()=>{j([`${o.id}-${p}`])},[p]),a.useEffect(()=>{const i=Ne(c).slice(0,-1);c&&x(i.map(u=>`${o.id}-${u.fullPath}`))},[c]);const C=a.useCallback(async i=>{if(k(i),l.current)return;l.current=!0;const u=Ne(c).slice(0,-1);O(!0);const $=(await Promise.all([y.fetchQuery({queryKey:v(),staleTime:1e4,queryFn:()=>U({path:"/"})}),...u.map(N=>y.fetchQuery({queryKey:v(N.fullPath),staleTime:1e4,queryFn:()=>U({path:N.fullPath,id:Number(o.id)})}))]).finally(()=>{O(!1)})).reduce((N,w,M)=>(M===0?N["s3://"]={total:w.total??0,data:w.data,pageNo:w.page_no??1}:N[`${w.data[0].id}-${u[M-1].fullPath}`]={total:w.total??0,data:w.data,pageNo:w.page_no??1},N),{});r($)},[c,o.id]);a.useEffect(()=>{const i=u=>{C(u.detail.open)};return document.addEventListener("toggleDirectoryTree",i),()=>{document.removeEventListener("toggleDirectoryTree",i)}},[C]),a.useImperativeHandle(s,()=>({toggle:C}));const T=a.useCallback(async(i,u,F)=>{let $=u;if(i==="file")return;u.startsWith("s3://")||($=`${c}${u}`),["bucket","dir"].includes(i)&&!$.endsWith("/")&&($=`${$}/`);const N=await y.fetchQuery({queryKey:v($,F),staleTime:1e4,queryFn:()=>U({path:$,id:F})});r(w=>{const M=`${F}-${$}`;return w[M]?w:{...w,[M]:{total:N.total??0,data:N.data,pageNo:N.page_no??1}}})},[c]),b=a.useCallback(async({key:i,raw:u})=>{if(i.endsWith("///load-more")){const F=R.get(n,[u.path,"pageNo"],1)+1,$=await y.fetchQuery({queryKey:v(u.path,F),staleTime:1e4,queryFn:()=>U({path:u.path,id:u.id,pageNo:F})});r(N=>{const w=`${u.id}-${u.path}`,M=N[w];return{...N,[w]:{total:$.total+((M==null?void 0:M.total)??0),data:[...(M==null?void 0:M.data)??[],...$.data],pageNo:F}}});return}S({to:"/",search:{...o,path:u.path,id:u.id}})},[o,n]),z=a.useCallback(i=>{const u=i.raw.path,F=`${i.raw.id}-${u}`;return n[F]?Promise.resolve():T(R.get(i,"raw.type"),u,i.raw.id)},[T,n]),_=a.useMemo(()=>{var u;const i=(F,$=0,N="")=>R.map(F,w=>{var ge,xe,be;const M=w.path.replace(N,"").replace(/\/$/,""),W=`${w.id}-${w.path}`,Ve={title:e.jsx("span",{className:"whitespace-nowrap",children:g("directoryTree.loadMore")}),key:`${W}///load-more`,isLeaf:!0,icon:e.jsx(kt,{}),raw:w},fe=i(((ge=n[W])==null?void 0:ge.data)||[],$+1,w.path);return((xe=n[W])==null?void 0:xe.total)%B===0&&((be=n[W])==null?void 0:be.total)>0&&fe.push(Ve),{title:e.jsx("span",{className:"whitespace-nowrap",children:M}),key:W,children:fe,isLeaf:w.type==="file",icon:e.jsx("div",{className:"text-lg w-4 h-4",children:w.path.endsWith("/")?e.jsx(Ce,{type:"folder"}):e.jsx(Ce,{path:w.path})}),raw:w}});return i(((u=n["s3://"])==null?void 0:u.data)||[],0,"s3://")},[c,n]);return h?e.jsx(pt,{className:Fe.tree,active:!0}):e.jsx("div",{className:q(Fe.tree,t,{hidden:!I||!c}),children:e.jsx(ot.DirectoryTree,{expandedKeys:m,onExpand:i=>x(i),loadData:z,icon:e.jsx(Lt,{className:"text-lg"}),blockNode:!0,selectedKeys:f,onSelect:(i,{node:u})=>b(u),treeData:_})})}const Kt="_shortcutPathDropdown_1klmh_7",Vt="_listItem_1klmh_14",le={shortcutPathDropdown:Kt,listItem:Vt},ue=e.jsx(Oe,{className:"text-gray-300 text-[12px]"});function Pe({fragment:s,hideArrow:t,clickable:n=!0,onClick:r,className:l}){const d=V(),o=X(),p=Q().search,f=p.path||"",j=a.useCallback(m=>{m.stopPropagation(),m.preventDefault();const x=`s3://${f}${f.endsWith("/")?"":"/"}`;d.invalidateQueries(),o({to:"/",search:{...p,id:f?p.id:void 0,path:x,page_no:1}})},[f,p,o]);return e.jsxs("div",{className:q("flex items-center whitespace-nowrap",l),children:[!t&&ue,e.jsx("div",{className:q({"cursor-pointer duration-100 hover:bg-(--ant-color-primary-bg) hover:text-(--ant-color-primary) rounded":n,"cursor-text":!n},"px-1 py-0.5"),onClick:n?r??j:void 0,children:s})]})}function Ee(s){const t=s.replace(/^s3:\/\//,"").split("/");return t.map((n,r)=>({fragment:n,path:t.slice(0,r+1).join("/")}))}function Ht(s){document.dispatchEvent(new CustomEvent("correct-path",{detail:s}))}function Qt({containerRef:s}){const t=a.useRef(null),n=a.useRef(null),[r,l]=a.useState(!1),d=X(),o=a.useRef(null),[c,p]=a.useState([]),[f,j]=a.useState([]),{t:m}=H(),[x]=E.useForm(),k=Q().search,h=k.path||"",O=V();a.useEffect(()=>{j(Ee(h))},[h]),a.useImperativeHandle(s,()=>({toggleFocus:i=>{l(i)},form:x})),a.useEffect(()=>{const i=u=>{setTimeout(()=>{x.setFieldValue("path",u.detail),j(Ee(u.detail))})};return document.addEventListener("correct-path",i),()=>{document.removeEventListener("correct-path",i)}},[]),a.useLayoutEffect(()=>{if(!t.current||!o.current)return;o.current.style.width=`${t.current.offsetWidth}px`,o.current.style.height=`${t.current.offsetHeight}px`;let i=0;o.current.innerHTML="";const u=[],F=[{fragment:"s3",path:""},...f];for(let $=0;$<F.length;$++){const N=document.createElement("div");N.style.display="flex",N.style.alignItems="center",N.style.whiteSpace="nowrap",N.innerHTML=`
        <div style="display: flex;align-items: center;white-space: nowrap;">
          <div style="width: 14px;height: 14px;background-color: #000;"></div>
          <div style="padding-left: 0.25rem;padding-right: 0.25rem;">${F[$].fragment}</div>
        </div>
      `,u.push(N)}for(o.current.append(...u);o.current.scrollWidth-o.current.offsetWidth>0;)o.current.childNodes[0].remove(),i+=1;p(f.slice(0,i))},[f,r]),a.useEffect(()=>{x.setFieldValue("path",h??"")},[h]);const y=i=>{i.key==="Enter"&&x.submit()},S=i=>{var u;(u=document.querySelector(".shortcut-path-dropdown"))!=null&&u.contains(i.target)||(l(!0),setTimeout(()=>{var F;(F=n.current)==null||F.focus()},100))},B=async()=>{const i=await x.validateFields(),u=x.getFieldValue("path");i&&u.split("?")[0]===h.split("?")[0]&&l(!1)},g=i=>{i.stopPropagation(),i.preventDefault(),d({to:"/",search:{page_no:1}})},v=a.useCallback(i=>u=>{u.stopPropagation(),u.preventDefault();const F=`s3://${i}${i.endsWith("/")?"":"/"}`;O.invalidateQueries(),d({to:"/",search:{...k,id:h?k.id:void 0,path:F,page_no:1}})},[h,k,d]),C=i=>{const u=i.path.trim();O.invalidateQueries(),d({to:"/",search:{...k,id:h?k.id:void 0,path:u}}),setTimeout(()=>{l(!1)},1e3)},T=i=>{x.setFieldValue("path",i.path.trim())},b=a.useMemo(()=>({onClick:({key:i,domEvent:u})=>{v(i)(u)},items:c.map(i=>({key:i.path,label:i.fragment}))}),[v,c]),z=a.useMemo(()=>({path:h}),[h]),_=r||!h;return e.jsxs(e.Fragment,{children:[e.jsx(E,{layout:"inline",form:x,className:q({"w-full":_,visible:_,absolute:!_,invisible:!_,"z-[-1]":!_,"left-8":!_}),onFinish:C,initialValues:z,onValuesChange:T,children:e.jsx(E.Item,{label:"",name:"path",className:"!flex-1 !m-0",rules:[{pattern:/^s3:\/\//,message:m("bucket.pathMustStartWithS3")}],children:e.jsx(K,{className:q("w-full rounded-none !shadow-none"),ref:n,allowClear:!0,placeholder:m("bucket.searchPlaceholder"),onKeyDown:y,onBlur:B})})}),e.jsxs("div",{id:"path-container",ref:t,className:q({visible:!r,invisible:r||!h,"z-[-1]":r||!h,absolute:r||!h},"flex items-center flex-1 cursor-text overflow-auto w-0 border-t border-b border-gray-300 bg-white"),onClick:S,children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(Pe,{fragment:"s3",path:"",className:"ml-1",hideArrow:!0,onClick:g}),ue]}),c.length>0&&e.jsx(Ye,{rootClassName:le.shortcutPathDropdown,menu:b,children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"hover:bg-(--ant-color-primary-bg) hover:text-(--ant-color-primary) px-1 cursor-pointer rounded duration-100",children:"..."}),ue]})}),e.jsx("div",{className:"flex items-center",children:f.slice(c.length).map((i,u)=>e.jsx(Pe,{hideArrow:u===0,clickable:u+c.length!==f.length-1,onClick:v(i.path),fragment:i.fragment,path:i.path},u))})]}),e.jsx("div",{id:"path-contaner-shadow",className:"absolute top-0 left-0 flex items-center flex-1 overflow-auto min-w-0 invisible z-[-1]",ref:o})]})}function Wt(){const{t:s}=H(),t=a.useRef(null),n=Me(),l=Q().search,d=X(),[,o,c,p]=Re(),f=de(),j=()=>{let h=o;o.endsWith("/")?h=o.replace(/[^/]+\/$/,""):h=o.replace(/[^/]+$/,""),h==="s3://"&&(h=""),d({to:"/",search:{...l,id:h?l.id:void 0,path:h}})},m=R.get(f,"data.total",0),x=()=>{navigator.clipboard.writeText(o),G.success(s("copied"))},I=o.split("?")[0],k=o&&I.endsWith("/");return e.jsxs("div",{className:q("bucket-header"," flex items-center gap-2"),children:[o&&e.jsx(zt,{}),e.jsxs(ke.Compact,{className:"flex flex-1 text-sm relative",children:[e.jsx(L,{title:s("bucket.returnToParent"),placement:"bottomLeft",children:e.jsx(P,{disabled:!o||o==="s3://",icon:e.jsx(ct,{}),onClick:j})}),e.jsx(Qt,{containerRef:t}),e.jsx(L,{title:s("bucket.searchPath"),children:e.jsx(P,{disabled:n>0,icon:e.jsx(Et,{}),onClick:()=>{var h;return(h=t.current)==null?void 0:h.form.submit()}})}),e.jsx(L,{title:s("bucket.copyPath"),children:e.jsx(P,{disabled:!o,icon:e.jsx(it,{}),onClick:x})})]}),e.jsxs(e.Fragment,{children:[k&&e.jsxs(ke.Compact,{children:[e.jsx(L,{title:s("bucket.prevPage"),children:e.jsx(P,{disabled:!c||c===1,onClick:()=>d({to:"/",search:{...l,page_no:c-1}}),icon:e.jsx(lt,{})})}),e.jsx(K,{className:"!w-16 text-center",min:1,readOnly:!0,value:c??"1"}),e.jsx(L,{title:s("bucket.nextPage"),children:e.jsx(P,{onClick:()=>d({to:"/",search:{...l,page_no:c+1}}),icon:e.jsx(Oe,{}),disabled:m<c*p})})]}),e.jsx(L,{title:s("bucketForm.addBucket"),placement:"topLeft",children:e.jsx(P,{type:"primary",icon:e.jsx(te,{}),onClick:()=>{Tt()}})})]})]})}const Ie=s=>a.createElement("svg",{width:"1em",height:"1em",viewBox:"0 0 20 20",fill:"none",xmlns:"http://www.w3.org/2000/svg",...s},a.createElement("path",{d:"M8.03243 3.33325C8.25344 3.33325 8.4654 3.42105 8.62168 3.57733L9.80019 4.75584C9.95647 4.91212 10.1684 4.99992 10.3894 4.99992H17.5443C18.0045 4.99992 18.3776 5.37301 18.3776 5.83325V15.8333C18.3776 16.2935 18.0045 16.6666 17.5443 16.6666H2.54427C2.08403 16.6666 1.71094 16.2935 1.71094 15.8333V4.16659C1.71094 3.70635 2.08403 3.33325 2.54427 3.33325H8.03243Z",fill:"#FFBA52"}),a.createElement("path",{d:"M3.37793 8.75C3.37793 8.05964 3.93757 7.5 4.62793 7.5H15.4613C16.1516 7.5 16.7113 8.05964 16.7113 8.75H3.37793Z",fill:"white"})),D="ORIGIN";function Se(){return Math.random().toString(36).substring(2,15)}function Ut(s,t){const n=document.createElement("a");n.href=s,t&&n.setAttribute("download",t),document.body.appendChild(n),n.click(),setTimeout(()=>{document.body.removeChild(n)})}async function Gt(s){if(!s.startsWith("s3://"))throw new Error("s3路径必须以s3://开头");const t=s.split("/").pop();try{const n={path:s},l=`/api/v1/bucket/download?${new URLSearchParams(n).toString()}`;Ut(l,t)}catch{throw new Error("下载失败")}}function Ke({modalRef:s}){const[t,n]=a.useState(null),[r,l]=a.useState(!1),{data:d,isLoading:o}=_e(typeof t=="number"),[c]=E.useForm(),{t:p}=H(),{mutateAsync:f}=Je(),j=V(),m=d==null?void 0:d.map(h=>({label:h.name,value:h.id}));a.useImperativeHandle(s,()=>({open:h=>{n(h),l(!0)}}));const{data:x}=et(t);a.useEffect(()=>{x&&c.setFieldsValue(x)},[x]);const I=()=>{l(!1),n(null)},k=async()=>{l(!1),n(null);const h=c.getFieldsValue(),O=R.get(h,"endpoint"),y=R.get(h,"keychain_id"),S=R.get(h,"path"),B=R.get(h,"name");await f({id:t,body:{endpoint:O,keychain_id:y,path:S,name:B}}),j.invalidateQueries({queryKey:["bucket"]}),G.success(p("bucketUpdated"))};return e.jsx(se,{title:p("editBucket"),open:r,onCancel:I,onOk:k,loading:o,children:e.jsxs(E,{form:c,layout:"vertical",name:"bucket",initialValues:x,onFinish:k,children:[e.jsx(E.Item,{label:p("bucketForm.path"),hasFeedback:!0,name:"path",required:!0,validateDebounce:1e3,rules:[pe(m)],children:e.jsx(K,{placeholder:p("bucketForm.pathPlaceholder")})}),e.jsx(E.Item,{label:p("bucketForm.endpoint"),name:"endpoint",required:!0,hasFeedback:!0,validateDebounce:1e3,rules:[{type:"url",message:p("bucketForm.endpointValidMessage")},me],children:e.jsx(K,{placeholder:p("bucketForm.endpointPlaceholder")})}),e.jsx(E.Item,{label:p("bucketForm.keychainId"),name:"keychain_id",rules:[{required:!0,message:p("bucketForm.keychainIdRequired")}],children:e.jsx(he,{options:m})})]})})}function Zt({block:s,onClose:t,pageSize:n=50,pageNo:r=1,updateBlock:l,...d}){const{path:o,id:c,bucketId:p}=s,[f,j]=a.useState(n),[m,x]=a.useState(r),I=X(),h=Q().search,O=a.useMemo(()=>o?["bucket",{path:o,pageSize:f,pageNo:m,id:p}]:["bucket"],[o,f,m,p]);console.log("bucketQueryKey",O),a.useEffect(()=>{c===D&&x(r)},[r]),a.useEffect(()=>{c===D&&j(n)},[n]);const y=a.useMemo(()=>({staleTime:o?1e4:0,queryKey:O,queryFn:()=>U({path:o,pageSize:f,pageNo:m,id:c===D&&p?Number(p):void 0}).then(z=>z),select:b=>b.data}),[O]),{data:S,isLoading:B}=nt(y),g=a.useCallback(b=>{c===D&&Ht(b)},[c]),v=a.useCallback(b=>{if(c===D){const{path:z,..._}=b,i={};typeof b.path=="string"&&(i.path=z),_.pageNo&&(i.page_no=_.pageNo),_.pageSize&&(i.page_size=_.pageSize),I({to:"/",search:{...h,...i,id:!i.path&&Object.keys(_).length===0?void 0:h.id}})}else b.pageSize&&j(b.pageSize),b.pageNo&&x(b.pageNo);l==null||l(c,{path:b.path,pathType:Y(b.path??"")})},[c,h,l]),C=a.useCallback(b=>{window.open(`${window.location.origin}${window.location.pathname}?path=${encodeURIComponent(b)}&pageSize=${f}&pageNo=${m}`,"_blank","noopener,noreferrer")},[f,m,p]),T=c===D;return e.jsx(dt,{block:s,loading:B,dataSource:S,onClose:t,onPathCorrection:g,onDownload:Gt,previewUrl:"/api/v1/bucket/preview",showGoParent:!T&&!!o,showPagination:!T&&s.pathType==="folder",onChange:v,closeable:!T,onOpenInNewTab:C,showOpenInNewTab:!T,...d})}function Xt({className:s}){const t=a.useRef(null),n=a.useRef(null),r=Q(),l=V(),{t:d}=H(),o=r.search,c=o.id,p=o.path||"",f=ut(p),j=Number(o.page_size)||50,m=Number(o.page_no)||1,x=Y(f)||"txt",[I,k]=a.useState([{id:D,path:p,pathType:x,bucketId:c}]);a.useEffect(()=>{k(g=>[{...g[0],bucketId:c},...g.slice(1)])},[c]);const h=a.useCallback((g,v)=>{k(C=>C.map(T=>T.id===g?{...T,...v}:T))},[]);a.useEffect(()=>{k(g=>[{...g[0],path:p,pathType:x}])},[p,x]),a.useEffect(()=>{const g=async v=>{const C=v.detail.path,T=await st(C);if(T.data.length>1){se.info({title:d("bucket.duplicatedBuckets"),content:e.jsx(ee,{size:"small",bordered:!0,dataSource:T.data.map(b=>({name:b.name,path:b.path,id:b.id})),renderItem:b=>e.jsx(ee.Item,{className:q(le.listItem,"!flex !items-center"),children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ie,{}),e.jsx("a",{href:"javascript:void(0)",className:"!hover:underline",onClick:()=>{k(z=>[...z.slice(0,1),...z.slice(1),{id:Se(),path:b.path,pathType:Y(b.path),bucketId:b.id}]),se.destroyAll()},children:`${b.path}/`}),b.name&&e.jsx(we,{children:b.name})]})})})});return}else k(b=>[...b.slice(0,1),...b.slice(1),{id:Se(),path:C,pathType:Y(C),bucketId:T.data[0].id}]);setTimeout(()=>{t.current&&t.current.scrollTo({left:t.current.scrollWidth,behavior:"smooth"})})};return document.addEventListener("s3-path-click",g),()=>{document.removeEventListener("s3-path-click",g)}},[d]);const O=a.useCallback(g=>{k(v=>v.filter(C=>C.id!==g))},[]),y=a.useCallback(g=>je(g).then(()=>{G.success(d("upload.deleteSuccess")),l.invalidateQueries({queryKey:["bucket"]})}),[je,l]),S=de(),B=a.useCallback(g=>R.get(S,"data.data",[]).filter(C=>C.path===g).length>1,[S]);return e.jsxs("div",{ref:t,className:q(s,"block-previewer","flex","items-start","gap-4","overflow-x-auto","h-full relative"),children:[I.map(g=>e.jsx(Zt,{block:g,updateBlock:h,onClose:()=>O(g.id),pageSize:g.id===D?j:void 0,pageNo:g.id===D?m:void 0,style:{width:`calc(100% / ${I.length})`},renderBucketItem:g.id===D?v=>e.jsxs(ee.Item,{className:q(le.listItem,"!flex !items-center"),children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ie,{}),e.jsx(tt,{className:"hover:!underline",to:"/",search:{path:`${v.path}/`,id:v.id},children:`${v.path}/`}),B(v.path)&&e.jsxs(we,{color:"blue",children:[e.jsx(Ft,{})," ",v.keychain_name]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(P,{type:"text",size:"small",icon:e.jsx(wt,{}),onClick:()=>{var C;return(C=n.current)==null?void 0:C.open(v.id)}}),e.jsx(mt,{title:d("bucketForm.deleteConfirm"),onConfirm:()=>y(v.id),okText:d("ok"),cancelText:d("cancel"),children:e.jsx(P,{danger:!0,type:"text",size:"small",icon:e.jsx(Be,{})})})]})]}):void 0},g.id)),e.jsx(Ke,{modalRef:n})]})}function Yt({className:s}){const{t}=H(),[n]=E.useForm(),{keyOptions:r,isLoading:l,keyChainQuery:d}=ze(),{mutateAsync:o,isPending:c}=at(),p=V(),f=async m=>{await o(m),p.invalidateQueries({queryKey:["bucket"]}),n.resetFields()},j=[{name:t("supportedCloudPlatforms.huawei"),icon:"/huawei.png"},{name:t("supportedCloudPlatforms.tencent"),icon:"/tencent.png"},{name:t("supportedCloudPlatforms.sensetime"),icon:"/sensetime.png"},{name:t("supportedCloudPlatforms.aws"),icon:"/aws.png"},{name:t("supportedCloudPlatforms.aliyun"),icon:"/aliyun.png"},{name:t("supportedCloudPlatforms.inspur"),icon:"/inspur.png"},{name:t("supportedCloudPlatforms.microsoft"),icon:"/microsoft.png"}];return e.jsxs("div",{className:q("flex flex-col items-center justify-center bg-[url(/bg.png)] bg-cover bg-center fixed inset-0 z-10",s),children:[e.jsx("div",{className:"text-center mb-12",children:e.jsx("h1",{className:"text-4xl font-bold mb-4",children:t("addFirstBucket")})}),e.jsxs(E,{form:n,className:"max-w-2xl",layout:"vertical",onFinish:f,children:[e.jsx(Te,{className:"!mb-4",type:"info",showIcon:!0,message:e.jsxs("div",{children:[t("bucketForm.alertMessage")," → ",e.jsxs(P,{type:"link",target:"_blank",size:"small",className:"!px-0",href:"/keychain",children:[t("bucketForm.AS&SKManagement")," ",e.jsx($e,{})]})]})}),e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsx(E.Item,{className:"!mb-0",label:e.jsxs("div",{className:"flex items-center gap-2",children:["AK&SK",e.jsx(L,{title:t("bucketForm.refresh"),children:e.jsx(P,{type:"text",size:"small",icon:e.jsx(qe,{}),loading:d.isFetching,onClick:()=>d.refetch()})})]}),required:!0,name:"keychain_id",rules:[{required:!0,message:t("bucketForm.keychainIdRequired")}],children:e.jsx(he,{className:"w-full",loading:l,options:r,placeholder:t("bucketForm.keychainIdRequired"),optionRender:m=>e.jsxs("div",{className:"flex flex-col gap-1",children:[m.label,e.jsx("span",{className:"text-gray-400",children:m.data.access_key_id})]})})}),e.jsx(E.Item,{label:"Endpoint",required:!0,hasFeedback:!0,className:"!mb-0",name:"endpoint",validateDebounce:1e3,rules:[{type:"url",message:t("bucketForm.endpointValidMessage")},me],children:e.jsx(K,{placeholder:t("bucketForm.endpointPlaceholder")})}),e.jsx(E.Item,{label:t("bucketForm.path"),tooltip:t("bucketForm.pathTooltip"),required:!0,hasFeedback:!0,className:"!mb-0",name:"path",validateDebounce:1e3,rules:[pe(r)],children:e.jsx(K,{placeholder:t("bucketForm.pathPlaceholder")})}),e.jsx(E.Item,{children:e.jsx(P,{block:!0,type:"primary",size:"large",loading:c,onClick:n.submit,children:t("bucketForm.add")})})]})]}),e.jsxs("div",{className:"text-center text-gray-600 mt-4",children:[e.jsx("p",{children:t("currentSupport")}),e.jsx("div",{className:"flex justify-center items-center space-x-6 mt-4",children:j.map(m=>e.jsx("div",{className:"bg-white rounded-md w-8 h-8 p-1",title:m.name,children:e.jsx("img",{src:m.icon,alt:m.name,className:"w-full h-full object-contain"})},m.name))})]})]})}const as=function(){const t=a.useRef(null),n=a.useRef(null),[,r]=Re(),l=de(),d=Me({queryKey:["bucket"]}),o=R.get(l,"data.total",0),c=d===0&&!r&&o===0;return console.log("cachedBucket",l),console.log("isFetching",c,d),e.jsxs("div",{className:q("p-4",{"flex flex-1 flex-col":!c}),ref:t,children:[e.jsx(Yt,{className:q({block:c,hidden:!c})}),e.jsx(Dt,{children:e.jsxs("div",{className:q("flex-col gap-4 h-[calc(100vh-88px)]",{hidden:c,flex:!c}),children:[e.jsx(Wt,{}),e.jsxs("div",{className:"flex flex-1 min-h-0 overflow-y-auto relative gap-4",children:[e.jsx(At,{}),e.jsx(Xt,{className:"flex-1"})]})]})}),e.jsx(Bt,{showTrigger:!1}),e.jsx(Ke,{modalRef:n})]})};export{as as component};
