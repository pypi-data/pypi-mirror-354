import{u as A,r as a,n as Qe,I as ee,w as ke,a as We,b as Ue,c as ve,s as Ge,d as V,e as W,f as de,g as $e,j as e,B as I,h as H,T as L,_ as B,i as K,k as Z,l as X,m as q,S as je,D as Ze,L as Xe}from"./index-C_Y0Hfb9.js";import{R as Ye,S as he,D as Je,T as et,F as we,a as tt,b as nt,c as st,d as Be,g as at,e as Y,L as te,f as Ce,B as rt}from"./index-9AaA19mf.js";import{R as ne,A as Te,S as Oe,u as _e,M as se}from"./keychain.query-BTp0wfwY.js";import{R as ot,S as ct,P as it}from"./CloseOutlined-CGOnhWv9.js";import{S as lt,F as P,I as D}from"./index-BCn6KkX9.js";var ut={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M862 465.3h-81c-4.6 0-9 2-12.1 5.5L550 723.1V160c0-4.4-3.6-8-8-8h-60c-4.4 0-8 3.6-8 8v563.1L255.1 470.8c-3-3.5-7.4-5.5-12.1-5.5h-81c-6.8 0-10.5 8.1-6 13.2L487.9 861a31.96 31.96 0 0048.3 0L868 478.5c4.5-5.2.8-13.2-6-13.2z"}}]},name:"arrow-down",theme:"outlined"},dt={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M257.7 752c2 0 4-.2 6-.5L431.9 722c2-.4 3.9-1.3 5.3-2.8l423.9-423.9a9.96 9.96 0 000-14.1L694.9 114.9c-1.9-1.9-4.4-2.9-7.1-2.9s-5.2 1-7.1 2.9L256.8 538.8c-1.5 1.5-2.4 3.3-2.8 5.3l-29.5 168.2a33.5 33.5 0 009.4 29.8c6.6 6.4 14.9 9.9 23.8 9.9zm67.4-174.4L687.8 215l73.3 73.3-362.7 362.6-88.9 15.7 15.6-89zM880 836H144c-17.7 0-32 14.3-32 32v36c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-36c0-17.7-14.3-32-32-32z"}}]},name:"edit",theme:"outlined"},ht={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M909.1 209.3l-56.4 44.1C775.8 155.1 656.2 92 521.9 92 290 92 102.3 279.5 102 511.5 101.7 743.7 289.8 932 521.9 932c181.3 0 335.8-115 394.6-276.1 1.5-4.2-.7-8.9-4.9-10.3l-56.7-19.5a8 8 0 00-10.1 4.8c-1.8 5-3.8 10-5.9 14.9-17.3 41-42.1 77.8-73.7 109.4A344.77 344.77 0 01655.9 829c-42.3 17.9-87.4 27-133.8 27-46.5 0-91.5-9.1-133.8-27A341.5 341.5 0 01279 755.2a342.16 342.16 0 01-73.7-109.4c-17.9-42.4-27-87.4-27-133.9s9.1-91.5 27-133.9c17.3-41 42.1-77.8 73.7-109.4 31.6-31.6 68.4-56.4 109.3-73.8 42.3-17.9 87.4-27 133.8-27 46.5 0 91.5 9.1 133.8 27a341.5 341.5 0 01109.3 73.8c9.9 9.9 19.2 20.4 27.8 31.4l-60.2 47a8 8 0 003 14.1l175.6 43c5 1.2 9.9-2.6 9.9-7.7l.8-180.9c-.1-6.6-7.8-10.3-13-6.2z"}}]},name:"reload",theme:"outlined"};function qe(t,n){const s=A(),r=s.getQueryCache();return a.useSyncExternalStore(a.useCallback(c=>r.subscribe(Qe.batchCalls(c)),[r]),()=>s.isFetching(t),()=>s.isFetching(t))}function ae(){return ae=Object.assign?Object.assign.bind():function(t){for(var n=1;n<arguments.length;n++){var s=arguments[n];for(var r in s)Object.prototype.hasOwnProperty.call(s,r)&&(t[r]=s[r])}return t},ae.apply(this,arguments)}const pt=(t,n)=>a.createElement(ee,ae({},t,{ref:n,icon:ut})),mt=a.forwardRef(pt);function re(){return re=Object.assign?Object.assign.bind():function(t){for(var n=1;n<arguments.length;n++){var s=arguments[n];for(var r in s)Object.prototype.hasOwnProperty.call(s,r)&&(t[r]=s[r])}return t},re.apply(this,arguments)}const ft=(t,n)=>a.createElement(ee,re({},t,{ref:n,icon:dt})),gt=a.forwardRef(ft);function oe(){return oe=Object.assign?Object.assign.bind():function(t){for(var n=1;n<arguments.length;n++){var s=arguments[n];for(var r in s)Object.prototype.hasOwnProperty.call(s,r)&&(t[r]=s[r])}return t},oe.apply(this,arguments)}const xt=(t,n)=>a.createElement(ee,oe({},t,{ref:n,icon:ht})),Me=a.forwardRef(xt);function ce(){return ce=Object.assign?Object.assign.bind():function(t){for(var n=1;n<arguments.length;n++){var s=arguments[n];for(var r in s)Object.prototype.hasOwnProperty.call(s,r)&&(t[r]=s[r])}return t},ce.apply(this,arguments)}const bt=(t,n)=>a.createElement(ee,ce({},t,{ref:n,icon:lt})),yt=a.forwardRef(bt);function kt(t,n,s){const r=a.useRef({});return(!("value"in r.current)||s(r.current.condition,n))&&(r.current.value=t(),r.current.condition=n),r.current.value}Number(a.version.split(".")[0]);const vt=(t,n)=>{typeof t=="function"?t(n):typeof t=="object"&&t&&"current"in t&&(t.current=n)},jt=(...t)=>{const n=t.filter(Boolean);return n.length<=1?n[0]:s=>{t.forEach(r=>{vt(r,s)})}},wt=(...t)=>kt(()=>jt(...t),t,(n,s)=>n.length!==s.length||n.every((r,c)=>r!==s[c]));function J(){return J=Object.assign?Object.assign.bind():function(t){for(var n=1;n<arguments.length;n++){var s=arguments[n];for(var r in s)Object.prototype.hasOwnProperty.call(s,r)&&(t[r]=s[r])}return t},J.apply(this,arguments)}const Le=a.forwardRef((t,n)=>{const{className:s,component:r,viewBox:c,spin:u,rotate:o,tabIndex:i,onClick:h,children:f,...j}=t,m=a.useRef(),x=wt(m,n);ke(!!(r||f),"Should have `component` prop or `children`."),We(m);const{prefixCls:S="anticon",rootClassName:k}=a.useContext(Ue),p=ve(k,S,{[`${S}-spin`]:!!u&&!!r},s),T=ve({[`${S}-spin`]:!!u}),b=o?{msTransform:`rotate(${o}deg)`,transform:`rotate(${o}deg)`}:void 0,g={...Ge,className:T,style:b,viewBox:c};c||delete g.viewBox;const y=()=>r?a.createElement(r,g,f):f?(ke(!!c||a.Children.count(f)===1&&a.isValidElement(f)&&a.Children.only(f).type==="use","Make sure that you provide correct `viewBox` prop (default `0 0 1024 1024`) to the icon."),a.createElement("svg",J({},g,{viewBox:c}),f)):null;let F=i;return F===void 0&&h&&(F=-1),a.createElement("span",J({role:"img"},j,{ref:x,tabIndex:F,onClick:h,className:p}),y())});Le.displayName="AntdIcon";async function G({pageNo:t,pageSize:n,path:s,id:r}={},c){const u={path:s||"",id:r};return s&&s.endsWith("/")&&(u.page_no=t||1,u.page_size=n||50),V("/bucket",{params:u,...c})}async function Ct(t){return V(`/bucket/${t}`)}async function Ft(t,n){return V.patch(`/bucket/${t}`,n)}async function Nt(t){return V.post("/bucket",t)}async function Pt(t){return V.post("/bucket/batch",t)}async function Et(t){return V.get("/bucket/filter",{params:{path:t}})}async function Fe(t){return V.delete(`/bucket/${t}`)}async function It(t){return V("/bucket/accessible",{params:t})}async function St(t){return V("/bucket/ping",{params:{url:t}})}function Rt(t){return $e({enabled:typeof t=="number",queryKey:["bucket",t],queryFn:()=>Ct(t)})}function $t(){return de({mutationFn:t=>Nt(t)})}function Bt(){return de({mutationFn:t=>Pt(t)})}function Tt(){return de({mutationFn:({id:t,body:n})=>Ft(t,n)})}function pe(){const n=W().search,s=n.path||"",r=Number(n.page_no)||1,c=Number(n.page_size)||50,u=Number(n.id)||0;return[a.useMemo(()=>s?["bucket",{path:s,pageSize:c,pageNo:r,id:u}]:["bucket"],[s,c,r,u]),s,r,c,u]}function ze(){const[t]=pe(),n=A();return console.log("queryKey",t),n.getQueryState(t)}function Ot({isOpen:t,onClose:n,children:s,title:r,width:c=400,offset:u={right:24,top:0,bottom:0},footer:o}){const[i,h]=a.useState(!1),[f,j]=a.useState(!1),m={right:u.right??24,top:u.top??0,bottom:u.bottom??0};return a.useEffect(()=>{if(t)h(!0),requestAnimationFrame(()=>{requestAnimationFrame(()=>{j(!0)})});else{j(!1);const x=setTimeout(()=>{h(!1)},300);return()=>clearTimeout(x)}},[t]),i?e.jsxs("div",{className:"fixed inset-0 z-50",children:[e.jsx("div",{className:"absolute inset-0 bg-opacity-25 transition-opacity duration-300",style:{opacity:f?1:0}}),e.jsxs("div",{className:"absolute right-0 bg-white shadow-lg rounded-lg flex flex-col",style:{width:typeof c=="number"?`${c}px`:c,transform:f?"translateX(0) scale(1)":"translateX(100%) scale(0.9)",transformOrigin:"right center",right:`${m.right}px`,top:m.top>0?m.top:0,bottom:m.bottom>0?m.bottom:0,height:m.top>0||m.bottom>0?"auto":"100%",pointerEvents:"auto",overflowY:"auto",maxHeight:`calc(100vh - ${m.top+m.bottom}px)`,boxShadow:"-4px 0 15px rgba(0, 0, 0, 0.1)",transition:"transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)"},children:[e.jsxs("div",{className:"flex justify-between items-center p-4 border-b border-gray-200",children:[e.jsx("h3",{className:"text-lg font-medium",children:r}),e.jsx(I,{onClick:n,type:"text",size:"small",icon:e.jsx(ot,{})})]}),e.jsx("div",{className:"p-6 flex-1 min-h-0 overflow-y-auto",children:s}),o&&e.jsx("div",{className:"p-4 border-t border-gray-200",children:o})]})]}):null}function me(t){return n=>({validator:async(s,r)=>{const c=n.getFieldsValue(),u=B.get(c,s.field.replace("path","endpoint")),o=B.get(c,s.field.replace("path","keychain_id"));if(!o)return Promise.reject(new Error(K.t("bucketForm.keychainIdRequired")));if(!u)return Promise.reject(new Error(K.t("bucketForm.endpointRequired")));if(!r)return Promise.reject(new Error(K.t("bucketForm.pathRequired")));if(!r.startsWith("s3://"))return Promise.reject(new Error(K.t("bucketForm.pathValidMessage")));try{const i=B.find(t,f=>f.value===o);if(!i)return Promise.reject(new Error(K.t("bucketForm.keychainIdRequired")));const h=await It({endpoint:u,keychain_id:i.value,path:r});return B.get(h,"data")?Promise.resolve():Promise.reject(new Error(K.t("bucketForm.noPermission")))}catch(i){return Promise.reject(new Error(B.get(i,"message")))}}})}const ie="open-bucket-manager";function _t(t){const n=new CustomEvent(ie,{detail:t});document.dispatchEvent(n)}function fe(){return{async validator(t,n){if(!n)return Promise.reject(new Error(K.t("bucketForm.endpointRequired")));const s=await St(n);return B.get(s,"data",!1)?Promise.resolve(K.t("bucketForm.endpointAccessible")):Promise.reject(new Error(K.t("bucketForm.endpointInvalid")))}}}function De(){const{data:t,isLoading:n,...s}=_e();return{keyOptions:a.useMemo(()=>B.map(t,c=>({label:c.name,value:c.id,access_key_id:c.access_key_id})),[t]),isLoading:n,keyChainQuery:s}}function qt({modalRef:t,className:n,showTrigger:s=!0}){const[r,c]=a.useState(!1),[u]=P.useForm(),{t:o}=H(),{keyOptions:i,isLoading:h,keyChainQuery:f}=De(),{mutateAsync:j,isPending:m}=Bt(),x=A();a.useEffect(()=>{const b=g=>{u.resetFields(),g.detail&&setTimeout(()=>{u.setFieldsValue(g.detail)}),c(!0)};return document.addEventListener(ie,b),()=>{document.removeEventListener(ie,b)}},[u,r]),a.useImperativeHandle(t,()=>({open:b=>{u.resetFields(),b&&setTimeout(()=>{u.setFieldsValue(b)}),c(!0)},close:()=>{u.resetFields(),c(!1)}}));const S=()=>{u.resetFields(),c(!1)},k=async b=>{if(B.size(b==null?void 0:b.buckets)===0){Z.error(o("bucketForm.atLeastOnePath"));return}await j(b.buckets),Z.success(o("bucketForm.pathAdded")),S(),x.invalidateQueries({queryKey:["bucket"]})},p=()=>{u.submit()},T=a.useMemo(()=>{var b;return{buckets:[{keychain_id:(b=i[0])==null?void 0:b.value,endpoint:"",path:""}]}},[i]);return e.jsxs(e.Fragment,{children:[s&&e.jsx(L,{title:o("bucketForm.triggerTooltipMessage"),placement:"bottomLeft",children:e.jsx(I,{className:n,onClick:()=>c(!0),type:"primary",icon:e.jsx(ne,{}),children:o("bucketForm.addBucket")})}),e.jsx(Ot,{isOpen:r,onClose:S,title:o("bucketForm.addBucket"),width:600,offset:{right:16,top:72,bottom:16},footer:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(I,{type:"primary",loading:m,onClick:p,children:o("bucketForm.save")}),e.jsx(I,{type:"default",onClick:S,children:o("bucketForm.cancel")})]}),children:e.jsx("div",{className:"",children:e.jsxs(P,{form:u,layout:"vertical",onFinish:k,initialValues:T,children:[e.jsx(Te,{className:"!mb-4",type:"info",showIcon:!0,message:e.jsxs("div",{children:[o("bucketForm.alertMessage")," → ",e.jsxs(I,{type:"link",target:"_blank",size:"small",className:"!px-0",href:"/keychain",children:[o("bucketForm.AS&SKManagement"),e.jsx(Ye,{})]})]})}),e.jsx(P.List,{name:"buckets",children:(b,{add:g,remove:y})=>e.jsxs(e.Fragment,{children:[b.map((F,v)=>e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("span",{className:"font-bold text-black",children:[o("bucketForm.path"),"  ",v+1]}),e.jsx(L,{title:o("bucketForm.remove"),children:e.jsx(I,{size:"small",type:"text",danger:!0,icon:e.jsx(Le,{component:Oe}),onClick:()=>y(v)})})]}),e.jsx(P.Item,{className:"!mb-0",label:e.jsxs("div",{className:"flex items-center gap-2",children:["AK&SK",e.jsx(L,{title:o("bucketForm.refresh"),children:e.jsx(I,{type:"text",size:"small",icon:e.jsx(Me,{}),loading:f.isFetching,onClick:()=>f.refetch()})})]}),required:!0,name:[v,"keychain_id"],rules:[{required:!0,message:o("bucketForm.keychainIdRequired")}],children:e.jsx(he,{className:"w-full",loading:h,options:i,placeholder:o("bucketForm.keychainIdRequired"),optionRender:w=>e.jsxs("div",{className:"flex flex-col gap-1",children:[w.label,e.jsx("span",{className:"text-gray-400",children:w.data.access_key_id})]})})}),e.jsx(P.Item,{label:"Endpoint",required:!0,hasFeedback:!0,className:"!mb-0",name:[v,"endpoint"],validateDebounce:1e3,rules:[{type:"url",message:o("bucketForm.endpointValidMessage")},fe],children:e.jsx(D,{placeholder:o("bucketForm.endpointPlaceholder")})}),e.jsx(P.Item,{label:o("bucketForm.path"),tooltip:o("bucketForm.pathTooltip"),required:!0,hasFeedback:!0,className:"!mb-0",name:[v,"path"],validateDebounce:1e3,rules:[me(i)],children:e.jsx(D,{placeholder:o("bucketForm.pathPlaceholder")})}),b.length>1&&v<b.length-1&&e.jsx(Je,{})]},F.key)),e.jsx(I,{className:"mt-6",block:!0,icon:e.jsx(ne,{}),onClick:()=>g(),children:o("bucketForm.add")})]})})]})})})]})}const Mt="_tree_1b5hq_2",Ne={tree:Mt},Lt=t=>a.createElement("svg",{stroke:"currentColor",fill:"currentColor",strokeWidth:0,viewBox:"0 0 24 24",height:"1em",width:"1em",xmlns:"http://www.w3.org/2000/svg",...t},a.createElement("path",{d:"M4 6h2v12H4zm4 7h8.586l-4.293 4.293 1.414 1.414L20.414 12l-6.707-6.707-1.414 1.414L16.586 11H8z"})),zt=t=>a.createElement("svg",{stroke:"currentColor",fill:"currentColor",strokeWidth:0,viewBox:"0 0 24 24",height:"1em",width:"1em",xmlns:"http://www.w3.org/2000/svg",...t},a.createElement("path",{d:"M18 6h2v12h-2zm-2 5H7.414l4.293-4.293-1.414-1.414L3.586 12l6.707 6.707 1.414-1.414L7.414 13H16z"})),Dt=t=>a.createElement("svg",{width:"1em",height:"1em",viewBox:"0 0 20 20",fill:"none",xmlns:"http://www.w3.org/2000/svg",...t},a.createElement("path",{d:"M8.03243 3.33325C8.25344 3.33325 8.4654 3.42105 8.62168 3.57733L9.80019 4.75584C9.95647 4.91212 10.1684 4.99992 10.3894 4.99992H17.5443C18.0045 4.99992 18.3776 5.37301 18.3776 5.83325V15.8333C18.3776 16.2935 18.0045 16.6666 17.5443 16.6666H2.54427C2.08403 16.6666 1.71094 16.2935 1.71094 15.8333V4.16659C1.71094 3.70635 2.08403 3.33325 2.54427 3.33325H8.03243Z",fill:"#3477EB"}),a.createElement("path",{d:"M3.37695 8.75C3.37695 8.05964 3.9366 7.5 4.62695 7.5H15.4603C16.1506 7.5 16.7103 8.05964 16.7103 8.75H3.37695Z",fill:"white"}));function Pe(t){const n=t.replace(/^s3:\/\//,"").split("/");return n.map((s,r)=>{const c=n.slice(0,r+1).join("/");return{fragment:s,path:c,fullPath:`s3://${c}/`}})}function Kt(){const{open:t,setOpen:n}=Ae(),{t:s}=H(),r=a.useCallback(()=>{document.dispatchEvent(new CustomEvent("toggleDirectoryTree",{detail:{open:!t}}))},[t,n]);return e.jsx(L,{title:s(t?"directoryTree.hide":"directoryTree.show"),placement:"bottomLeft",children:e.jsx(I,{icon:t?e.jsx(zt,{}):e.jsx(Lt,{}),onClick:r})})}const Ke=a.createContext({open:!1,setOpen:()=>{}});function Ae(){const t=a.useContext(Ke);if(!t)throw new Error("useTreeContext must be used within a DirectoryTreeProvider");return t}function At({children:t}){const[n,s]=a.useState(!1),r=a.useMemo(()=>({open:n,setOpen:s}),[n]);return e.jsx(Ke.Provider,{value:r,children:t})}function Vt({treeRef:t,className:n}){const[s,r]=a.useState({}),c=a.useRef(!1),o=W().search,i=o.path||"",h=i==null?void 0:i.split("?")[0],[f,j]=a.useState([`${o.id}-${h}`]),[m,x]=a.useState([i]),{open:S,setOpen:k}=Ae(),[p,T]=a.useState(!1),b=A(),g=X(),y=Number(o.page_size)||50,{t:F}=H(),v=a.useCallback((l,d,N)=>l?["bucket",{path:l,pageNo:d??B.get(s,[l,"pageNo"],1),pageSize:y,id:N??o.id}]:["bucket"],[s,o.id]);a.useEffect(()=>{j([`${o.id}-${h}`])},[h]),a.useEffect(()=>{const l=Pe(i).slice(0,-1);i&&x(l.map(d=>`${o.id}-${d.fullPath}`))},[i]);const w=a.useCallback(async l=>{if(k(l),c.current)return;c.current=!0;const d=Pe(i).slice(0,-1);T(!0);const $=(await Promise.all([b.fetchQuery({queryKey:v(),staleTime:1e4,queryFn:()=>G({path:"/"})}),...d.map(E=>b.fetchQuery({queryKey:v(E.fullPath),staleTime:1e4,queryFn:()=>G({path:E.fullPath,id:Number(o.id)})}))]).finally(()=>{T(!1)})).reduce((E,C,_)=>(_===0?E["s3://"]={total:C.total??0,data:C.data,pageNo:C.page_no??1}:E[`${C.data[0].id}-${d[_-1].fullPath}`]={total:C.total??0,data:C.data,pageNo:C.page_no??1},E),{});r($)},[i,o.id]);a.useEffect(()=>{const l=d=>{w(d.detail.open)};return document.addEventListener("toggleDirectoryTree",l),()=>{document.removeEventListener("toggleDirectoryTree",l)}},[w]),a.useImperativeHandle(t,()=>({toggle:w}));const M=a.useCallback(async(l,d,N)=>{let $=d;if(l==="file")return;d.startsWith("s3://")||($=`${i}${d}`),["bucket","dir"].includes(l)&&!$.endsWith("/")&&($=`${$}/`);const E=await b.fetchQuery({queryKey:v($,N),staleTime:1e4,queryFn:()=>G({path:$,id:N})});r(C=>{const _=`${N}-${$}`;return C[_]?C:{...C,[_]:{total:E.total??0,data:E.data,pageNo:E.page_no??1}}})},[i]),R=a.useCallback(async({key:l,raw:d})=>{if(l.endsWith("///load-more")){const N=B.get(s,[d.path,"pageNo"],1)+1,$=await b.fetchQuery({queryKey:v(d.path,N),staleTime:1e4,queryFn:()=>G({path:d.path,id:d.id,pageNo:N})});r(E=>{const C=`${d.id}-${d.path}`,_=E[C];return{...E,[C]:{total:$.total+((_==null?void 0:_.total)??0),data:[...(_==null?void 0:_.data)??[],...$.data],pageNo:N}}});return}g({to:"/",search:{...o,path:d.path,id:d.id}})},[o,s]),Q=a.useCallback(l=>{const d=l.raw.path,N=`${l.raw.id}-${d}`;return s[N]?Promise.resolve():M(B.get(l,"raw.type"),d,l.raw.id)},[M,s]),O=a.useMemo(()=>{var d;const l=(N,$=0,E="")=>B.map(N,C=>{var xe,be,ye;const _=C.path.replace(E,"").replace(/\/$/,""),U=`${C.id}-${C.path}`,He={title:e.jsx("span",{className:"whitespace-nowrap",children:F("directoryTree.loadMore")}),key:`${U}///load-more`,isLeaf:!0,icon:e.jsx(mt,{}),raw:C},ge=l(((xe=s[U])==null?void 0:xe.data)||[],$+1,C.path);return((be=s[U])==null?void 0:be.total)%y===0&&((ye=s[U])==null?void 0:ye.total)>0&&ge.push(He),{title:e.jsx("span",{className:"whitespace-nowrap",children:_}),key:U,children:ge,isLeaf:C.type==="file",icon:e.jsx("div",{className:"text-lg w-4 h-4",children:C.path.endsWith("/")?e.jsx(we,{type:"folder"}):e.jsx(we,{path:C.path})}),raw:C}});return l(((d=s["s3://"])==null?void 0:d.data)||[],0,"s3://")},[i,s]);return p?e.jsx(ct,{className:Ne.tree,active:!0}):e.jsx("div",{className:q(Ne.tree,n,{hidden:!S||!i}),children:e.jsx(et.DirectoryTree,{expandedKeys:m,onExpand:l=>x(l),loadData:Q,icon:e.jsx(Dt,{className:"text-lg"}),blockNode:!0,selectedKeys:f,onSelect:(l,{node:d})=>R(d),treeData:O})})}const Ht="_shortcutPathDropdown_1klmh_7",Qt="_listItem_1klmh_14",le={shortcutPathDropdown:Ht,listItem:Qt},ue=e.jsx(Be,{className:"text-gray-300 text-[12px]"});function Ee({fragment:t,hideArrow:n,clickable:s=!0,onClick:r,className:c}){const u=A(),o=X(),h=W().search,f=h.path||"",j=a.useCallback(m=>{m.stopPropagation(),m.preventDefault();const x=`s3://${f}${f.endsWith("/")?"":"/"}`;u.invalidateQueries(),o({to:"/",search:{...h,id:f?h.id:void 0,path:x,page_no:1}})},[f,h,o]);return e.jsxs("div",{className:q("flex items-center whitespace-nowrap",c),children:[!n&&ue,e.jsx("div",{className:q({"cursor-pointer duration-100 hover:bg-(--ant-color-primary-bg) hover:text-(--ant-color-primary) rounded":s,"cursor-text":!s},"px-1 py-0.5"),onClick:s?r??j:void 0,children:t})]})}function Ie(t){const n=t.replace(/^s3:\/\//,"").split("/");return n.map((s,r)=>({fragment:s,path:n.slice(0,r+1).join("/")}))}function Wt(t){document.dispatchEvent(new CustomEvent("correct-path",{detail:t}))}function Ut({containerRef:t}){const n=a.useRef(null),s=a.useRef(null),[r,c]=a.useState(!1),u=X(),o=a.useRef(null),[i,h]=a.useState([]),[f,j]=a.useState([]),{t:m}=H(),[x]=P.useForm(),k=W().search,p=k.path||"",T=A();a.useEffect(()=>{j(Ie(p))},[p]),a.useImperativeHandle(t,()=>({toggleFocus:l=>{c(l)},form:x})),a.useEffect(()=>{const l=d=>{setTimeout(()=>{x.setFieldValue("path",d.detail),j(Ie(d.detail))})};return document.addEventListener("correct-path",l),()=>{document.removeEventListener("correct-path",l)}},[]),a.useLayoutEffect(()=>{if(!n.current||!o.current)return;o.current.style.width=`${n.current.offsetWidth}px`,o.current.style.height=`${n.current.offsetHeight}px`;let l=0;o.current.innerHTML="";const d=[],N=[{fragment:"s3",path:""},...f];for(let $=0;$<N.length;$++){const E=document.createElement("div");E.style.display="flex",E.style.alignItems="center",E.style.whiteSpace="nowrap",E.innerHTML=`
        <div style="display: flex;align-items: center;white-space: nowrap;">
          <div style="width: 14px;height: 14px;background-color: #000;"></div>
          <div style="padding-left: 0.25rem;padding-right: 0.25rem;">${N[$].fragment}</div>
        </div>
      `,d.push(E)}for(o.current.append(...d);o.current.scrollWidth-o.current.offsetWidth>0;)o.current.childNodes[0].remove(),l+=1;h(f.slice(0,l))},[f,r]),a.useEffect(()=>{x.setFieldValue("path",p??"")},[p]);const b=l=>{l.key==="Enter"&&x.submit()},g=l=>{var d;(d=document.querySelector(".shortcut-path-dropdown"))!=null&&d.contains(l.target)||(c(!0),setTimeout(()=>{var N;(N=s.current)==null||N.focus()},100))},y=async()=>{const l=await x.validateFields(),d=x.getFieldValue("path");l&&d.split("?")[0]===p.split("?")[0]&&c(!1)},F=l=>{l.stopPropagation(),l.preventDefault(),u({to:"/",search:{page_no:1}})},v=a.useCallback(l=>d=>{d.stopPropagation(),d.preventDefault();const N=`s3://${l}${l.endsWith("/")?"":"/"}`;T.invalidateQueries(),u({to:"/",search:{...k,id:p?k.id:void 0,path:N,page_no:1}})},[p,k,u]),w=l=>{const d=l.path.trim();T.invalidateQueries(),u({to:"/",search:{...k,id:p?k.id:void 0,path:d}}),setTimeout(()=>{c(!1)},1e3)},M=l=>{x.setFieldValue("path",l.path.trim())},R=a.useMemo(()=>({onClick:({key:l,domEvent:d})=>{v(l)(d)},items:i.map(l=>({key:l.path,label:l.fragment}))}),[v,i]),Q=a.useMemo(()=>({path:p}),[p]),O=r||!p;return e.jsxs(e.Fragment,{children:[e.jsx(P,{layout:"inline",form:x,className:q({"w-full":O,visible:O,absolute:!O,invisible:!O,"z-[-1]":!O,"left-8":!O}),onFinish:w,initialValues:Q,onValuesChange:M,children:e.jsx(P.Item,{label:"",name:"path",className:"!flex-1 !m-0",rules:[{pattern:/^s3:\/\//,message:m("bucket.pathMustStartWithS3")}],children:e.jsx(D,{className:q("w-full rounded-none !shadow-none"),ref:s,allowClear:!0,placeholder:m("bucket.searchPlaceholder"),onKeyDown:b,onBlur:y})})}),e.jsxs("div",{id:"path-container",ref:n,className:q({visible:!r,invisible:r||!p,"z-[-1]":r||!p,absolute:r||!p},"flex items-center flex-1 cursor-text overflow-auto w-0 border-t border-b border-gray-300 bg-white"),onClick:g,children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(Ee,{fragment:"s3",path:"",className:"ml-1",hideArrow:!0,onClick:F}),ue]}),i.length>0&&e.jsx(Ze,{rootClassName:le.shortcutPathDropdown,menu:R,children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"hover:bg-(--ant-color-primary-bg) hover:text-(--ant-color-primary) px-1 cursor-pointer rounded duration-100",children:"..."}),ue]})}),e.jsx("div",{className:"flex items-center",children:f.slice(i.length).map((l,d)=>e.jsx(Ee,{hideArrow:d===0,clickable:d+i.length!==f.length-1,onClick:v(l.path),fragment:l.fragment,path:l.path},d))})]}),e.jsx("div",{id:"path-contaner-shadow",className:"absolute top-0 left-0 flex items-center flex-1 overflow-auto min-w-0 invisible z-[-1]",ref:o})]})}function Gt(){const{t}=H(),n=a.useRef(null),s=qe(),c=W().search,u=X(),[,o,i,h]=pe(),f=ze(),j=()=>{let p=o;o.endsWith("/")?p=o.replace(/[^/]+\/$/,""):p=o.replace(/[^/]+$/,""),p==="s3://"&&(p=""),u({to:"/",search:{...c,id:p?c.id:void 0,path:p}})},m=B.get(f,"data.total",0),x=()=>{navigator.clipboard.writeText(o),Z.success(t("copied"))},S=o.split("?")[0],k=o&&S.endsWith("/");return e.jsxs("div",{className:q("bucket-header"," flex items-center gap-2"),children:[o&&e.jsx(Kt,{}),e.jsxs(je.Compact,{className:"flex flex-1 text-sm relative",children:[e.jsx(L,{title:t("bucket.returnToParent"),placement:"bottomLeft",children:e.jsx(I,{disabled:!o||o==="s3://",icon:e.jsx(tt,{}),onClick:j})}),e.jsx(Ut,{containerRef:n}),e.jsx(L,{title:t("bucket.searchPath"),children:e.jsx(I,{disabled:s>0,icon:e.jsx(yt,{}),onClick:()=>{var p;return(p=n.current)==null?void 0:p.form.submit()}})}),e.jsx(L,{title:t("bucket.copyPath"),children:e.jsx(I,{disabled:!o,icon:e.jsx(nt,{}),onClick:x})})]}),e.jsxs(e.Fragment,{children:[k&&e.jsxs(je.Compact,{children:[e.jsx(L,{title:t("bucket.prevPage"),children:e.jsx(I,{disabled:!i||i===1,onClick:()=>u({to:"/",search:{...c,page_no:i-1}}),icon:e.jsx(st,{})})}),e.jsx(D,{className:"!w-16 text-center",min:1,readOnly:!0,value:i??"1"}),e.jsx(L,{title:t("bucket.nextPage"),children:e.jsx(I,{onClick:()=>u({to:"/",search:{...c,page_no:i+1}}),icon:e.jsx(Be,{}),disabled:m<i*h})})]}),e.jsx(L,{title:t("bucketForm.addBucket"),placement:"topLeft",children:e.jsx(I,{type:"primary",icon:e.jsx(ne,{}),onClick:()=>{_t()}})})]})]})}const Se=t=>a.createElement("svg",{width:"1em",height:"1em",viewBox:"0 0 20 20",fill:"none",xmlns:"http://www.w3.org/2000/svg",...t},a.createElement("path",{d:"M8.03243 3.33325C8.25344 3.33325 8.4654 3.42105 8.62168 3.57733L9.80019 4.75584C9.95647 4.91212 10.1684 4.99992 10.3894 4.99992H17.5443C18.0045 4.99992 18.3776 5.37301 18.3776 5.83325V15.8333C18.3776 16.2935 18.0045 16.6666 17.5443 16.6666H2.54427C2.08403 16.6666 1.71094 16.2935 1.71094 15.8333V4.16659C1.71094 3.70635 2.08403 3.33325 2.54427 3.33325H8.03243Z",fill:"#FFBA52"}),a.createElement("path",{d:"M3.37793 8.75C3.37793 8.05964 3.93757 7.5 4.62793 7.5H15.4613C16.1516 7.5 16.7113 8.05964 16.7113 8.75H3.37793Z",fill:"white"})),z="ORIGIN";function Re(){return Math.random().toString(36).substring(2,15)}function Zt(t,n){const s=document.createElement("a");s.href=t,n&&s.setAttribute("download",n),document.body.appendChild(s),s.click(),setTimeout(()=>{document.body.removeChild(s)})}async function Xt(t){if(!t.startsWith("s3://"))throw new Error("s3路径必须以s3://开头");const n=t.split("/").pop();try{const s={path:t},c=`/api/v1/bucket/download?${new URLSearchParams(s).toString()}`;Zt(c,n)}catch{throw new Error("下载失败")}}function Ve({modalRef:t}){const[n,s]=a.useState(null),[r,c]=a.useState(!1),{data:u,isLoading:o}=_e(typeof n=="number"),[i]=P.useForm(),{t:h}=H(),{mutateAsync:f}=Tt(),j=A(),m=u==null?void 0:u.map(p=>({label:p.name,value:p.id}));a.useImperativeHandle(t,()=>({open:p=>{s(p),c(!0)}}));const{data:x}=Rt(n);a.useEffect(()=>{x&&i.setFieldsValue(x)},[x]);const S=()=>{c(!1),s(null)},k=async()=>{c(!1),s(null);const p=i.getFieldsValue(),T=B.get(p,"endpoint"),b=B.get(p,"keychain_id"),g=B.get(p,"path"),y=B.get(p,"name");await f({id:n,body:{endpoint:T,keychain_id:b,path:g,name:y}}),j.invalidateQueries({queryKey:["bucket"]}),Z.success(h("bucketUpdated"))};return e.jsx(se,{title:h("editBucket"),open:r,onCancel:S,onOk:k,loading:o,children:e.jsxs(P,{form:i,layout:"vertical",name:"bucket",initialValues:x,onFinish:k,children:[e.jsx(P.Item,{label:h("bucketForm.name"),name:"name",children:e.jsx(D,{placeholder:h("bucketForm.namePlaceholder")})}),e.jsx(P.Item,{label:h("bucketForm.path"),hasFeedback:!0,name:"path",required:!0,validateDebounce:1e3,rules:[me(m)],children:e.jsx(D,{placeholder:h("bucketForm.pathPlaceholder")})}),e.jsx(P.Item,{label:h("bucketForm.endpoint"),name:"endpoint",required:!0,hasFeedback:!0,validateDebounce:1e3,rules:[{type:"url",message:h("bucketForm.endpointValidMessage")},fe],children:e.jsx(D,{placeholder:h("bucketForm.endpointPlaceholder")})}),e.jsx(P.Item,{label:h("bucketForm.keychainId"),name:"keychain_id",rules:[{required:!0,message:h("bucketForm.keychainIdRequired")}],children:e.jsx(he,{options:m})})]})})}function Yt({block:t,onClose:n,pageSize:s=50,pageNo:r=1,updateBlock:c,...u}){const{path:o,id:i,bucketId:h}=t,[f,j]=a.useState(s),[m,x]=a.useState(r),S=X(),p=W().search,T=a.useMemo(()=>o?["bucket",{path:o,pageSize:f,pageNo:m,id:h}]:["bucket"],[o,f,m,h]);console.log("bucketQueryKey",T),a.useEffect(()=>{i===z&&x(r)},[r]),a.useEffect(()=>{i===z&&j(s)},[s]);const b=a.useMemo(()=>({staleTime:o?1e4:0,queryKey:T,queryFn:()=>G({path:o,pageSize:f,pageNo:m,id:i===z&&h?Number(h):void 0}).then(Q=>Q),select:R=>R.data}),[T]),{data:g,isLoading:y}=$e(b),F=a.useCallback(R=>{i===z&&Wt(R)},[i]),v=a.useCallback(R=>{if(i===z){const{path:Q,...O}=R,l={};typeof R.path=="string"&&(l.path=Q),O.pageNo&&(l.page_no=O.pageNo),O.pageSize&&(l.page_size=O.pageSize),S({to:"/",search:{...p,...l,id:!l.path&&Object.keys(O).length===0?void 0:p.id}})}else R.pageSize&&j(R.pageSize),R.pageNo&&x(R.pageNo);c==null||c(i,{path:R.path,pathType:Y(R.path??"")})},[i,p,c]),w=a.useCallback(R=>{window.open(`${window.location.origin}${window.location.pathname}?path=${encodeURIComponent(R)}&pageSize=${f}&pageNo=${m}`,"_blank","noopener,noreferrer")},[f,m,h]),M=i===z;return e.jsx(rt,{block:t,loading:y,dataSource:g,onClose:n,onPathCorrection:F,onDownload:Xt,previewUrl:"/api/v1/bucket/preview",showGoParent:!M&&!!o,showPagination:!M&&t.pathType==="folder",onChange:v,closeable:!M,onOpenInNewTab:w,showOpenInNewTab:!M,...u})}function Jt({className:t}){const n=a.useRef(null),s=a.useRef(null),r=W(),c=A(),{t:u}=H(),o=r.search,i=o.id,h=o.path||"",f=at(h),j=Number(o.page_size)||50,m=Number(o.page_no)||1,x=Y(f)||"txt",[S,k]=a.useState([{id:z,path:h,pathType:x,bucketId:i}]);a.useEffect(()=>{k(g=>[{...g[0],bucketId:i},...g.slice(1)])},[i]);const p=a.useCallback((g,y)=>{k(F=>F.map(v=>v.id===g?{...v,...y}:v))},[]);a.useEffect(()=>{k(g=>[{...g[0],path:h,pathType:x}])},[h,x]),a.useEffect(()=>{const g=async y=>{const F=y.detail.path,v=await Et(F);if(v.data.length>1){se.info({title:u("bucket.duplicatedBuckets"),content:e.jsx(te,{size:"small",bordered:!0,dataSource:v.data.map(w=>({name:w.name,path:w.path,id:w.id})),renderItem:w=>e.jsx(te.Item,{className:q(le.listItem,"!flex !items-center"),children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Se,{}),e.jsx("a",{href:"javascript:void(0)",className:"!hover:underline",onClick:()=>{k(M=>[...M.slice(0,1),...M.slice(1),{id:Re(),path:w.path,pathType:Y(w.path),bucketId:w.id}]),se.destroyAll()},children:`${w.path}/`}),w.name&&e.jsx(Ce,{children:w.name})]})})})});return}else k(w=>[...w.slice(0,1),...w.slice(1),{id:Re(),path:F,pathType:Y(F),bucketId:v.data[0].id}]);setTimeout(()=>{n.current&&n.current.scrollTo({left:n.current.scrollWidth,behavior:"smooth"})})};return document.addEventListener("s3-path-click",g),()=>{document.removeEventListener("s3-path-click",g)}},[u]);const T=a.useCallback(g=>{k(y=>y.filter(F=>F.id!==g))},[]),b=a.useCallback(g=>Fe(g).then(()=>{Z.success(u("upload.deleteSuccess")),c.invalidateQueries({queryKey:["bucket"]})}),[Fe,c]);return e.jsxs("div",{ref:n,className:q(t,"block-previewer","flex","items-start","gap-4","overflow-x-auto","h-full relative"),children:[S.map(g=>e.jsx(Yt,{block:g,updateBlock:p,onClose:()=>T(g.id),pageSize:g.id===z?j:void 0,pageNo:g.id===z?m:void 0,style:{width:`calc(100% / ${S.length})`},renderBucketItem:g.id===z?y=>e.jsxs(te.Item,{className:q(le.listItem,"!flex !items-center"),children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Se,{}),e.jsx(Xe,{className:"hover:!underline",to:"/",search:{path:`${y.path}/`,id:y.id},children:`${y.path}/`}),y.name&&e.jsx(Ce,{children:y.name})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(I,{type:"text",size:"small",icon:e.jsx(gt,{}),onClick:()=>{var F;return(F=s.current)==null?void 0:F.open(y.id)}}),e.jsx(it,{title:u("bucketForm.deleteConfirm"),onConfirm:()=>b(y.id),okText:u("ok"),cancelText:u("cancel"),children:e.jsx(I,{danger:!0,type:"text",size:"small",icon:e.jsx(Oe,{})})})]})]}):void 0},g.id)),e.jsx(Ve,{modalRef:s})]})}function en({className:t}){const{t:n}=H(),[s]=P.useForm(),{keyOptions:r,isLoading:c,keyChainQuery:u}=De(),{mutateAsync:o,isPending:i}=$t(),h=A(),f=async m=>{await o(m),h.invalidateQueries({queryKey:["bucket"]}),s.resetFields()},j=[{name:n("supportedCloudPlatforms.huawei"),icon:"/huawei.png"},{name:n("supportedCloudPlatforms.tencent"),icon:"/tencent.png"},{name:n("supportedCloudPlatforms.sensetime"),icon:"/sensetime.png"},{name:n("supportedCloudPlatforms.aws"),icon:"/aws.png"},{name:n("supportedCloudPlatforms.aliyun"),icon:"/aliyun.png"},{name:n("supportedCloudPlatforms.inspur"),icon:"/inspur.png"},{name:n("supportedCloudPlatforms.microsoft"),icon:"/microsoft.png"}];return e.jsxs("div",{className:q("container mx-auto mt-18 flex flex-col items-center",t),children:[e.jsx("div",{className:"text-center mb-12",children:e.jsx("h1",{className:"text-4xl font-bold mb-4",children:n("addFirstBucket")})}),e.jsxs(P,{form:s,className:"max-w-2xl",layout:"vertical",onFinish:f,children:[e.jsx(Te,{className:"!mb-4",type:"info",showIcon:!0,message:e.jsxs("div",{children:[n("bucketForm.alertMessage")," → ",e.jsx(I,{type:"link",target:"_blank",size:"small",className:"!px-0",href:"/keychain",children:n("bucketForm.AS&SKManagement")})]})}),e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsx(P.Item,{label:n("bucketForm.name"),className:"!mb-0",name:"name",children:e.jsx(D,{placeholder:n("bucketForm.namePlaceholder")})}),e.jsx(P.Item,{className:"!mb-0",label:e.jsxs("div",{className:"flex items-center gap-2",children:["AK&SK",e.jsx(L,{title:n("bucketForm.refresh"),children:e.jsx(I,{type:"text",size:"small",icon:e.jsx(Me,{}),loading:u.isFetching,onClick:()=>u.refetch()})})]}),required:!0,name:"keychain_id",rules:[{required:!0,message:n("bucketForm.keychainIdRequired")}],children:e.jsx(he,{className:"w-full",loading:c,options:r,placeholder:n("bucketForm.keychainIdRequired"),optionRender:m=>e.jsxs("div",{className:"flex flex-col gap-1",children:[m.label,e.jsx("span",{className:"text-gray-400",children:m.data.access_key_id})]})})}),e.jsx(P.Item,{label:"Endpoint",required:!0,hasFeedback:!0,className:"!mb-0",name:"endpoint",validateDebounce:1e3,rules:[{type:"url",message:n("bucketForm.endpointValidMessage")},fe],children:e.jsx(D,{placeholder:n("bucketForm.endpointPlaceholder")})}),e.jsx(P.Item,{label:n("bucketForm.path"),tooltip:n("bucketForm.pathTooltip"),required:!0,hasFeedback:!0,className:"!mb-0",name:"path",validateDebounce:1e3,rules:[me(r)],children:e.jsx(D,{placeholder:n("bucketForm.pathPlaceholder")})}),e.jsx(P.Item,{children:e.jsx(I,{block:!0,type:"primary",size:"large",loading:i,onClick:s.submit,children:n("bucketForm.add")})})]})]}),e.jsxs("div",{className:"text-center text-gray-600 mt-4",children:[e.jsx("p",{children:n("currentSupport")}),e.jsx("div",{className:"flex justify-center items-center space-x-6 mt-4",children:j.map(m=>e.jsx("div",{className:"bg-white rounded-md w-8 h-8 p-1",title:m.name,children:e.jsx("img",{src:m.icon,alt:m.name,className:"w-full h-full object-contain"})},m.name))})]})]})}const on=function(){const n=a.useRef(null),s=a.useRef(null),[,r]=pe(),c=ze(),u=qe({queryKey:["bucket"]}),o=B.get(c,"data.total",0),i=u===0&&!r&&o===0;return console.log("cachedBucket",c),console.log("isFetching",i,u),e.jsxs("div",{className:q("p-4",{"flex flex-1 flex-col":!i}),ref:n,children:[e.jsx(en,{className:q({block:i,hidden:!i})}),e.jsx(At,{children:e.jsxs("div",{className:q("flex-col gap-4 h-[calc(100vh-88px)]",{hidden:i,flex:!i}),children:[e.jsx(Gt,{}),e.jsxs("div",{className:"flex flex-1 min-h-0 overflow-y-auto relative gap-4",children:[e.jsx(Vt,{}),e.jsx(Jt,{className:"flex-1"})]})]})}),e.jsx(qt,{showTrigger:!1}),e.jsx(Ve,{modalRef:s})]})};export{on as component};
