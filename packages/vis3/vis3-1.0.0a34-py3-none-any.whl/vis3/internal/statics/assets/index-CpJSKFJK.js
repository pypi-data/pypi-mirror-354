import{r as n,I as Y,S as Qe,w as ve,u as We,a as Ue,c as ke,s as Ge,j as e,B as I,R as Ze,F as R,b as Q,d as Xe,e as W,T as A,f as Se,g as he,h as H,D as Ye,_ as T,i as V,k as Je,p as et,l as X,m as U,n as J,o as Z,q as tt,t as z,v as st,x as je,y as nt,z as at,A as Oe,C as pe,E as we,G as rt,H as ot,J as ct,K as Te,L as it,M as lt,N as dt,O as ut,P as Be,Q as Ce,U as te,V as ht,W as Ne,X as pt,Y as mt,Z as ft,$ as gt}from"./index-Dtme-Iep.js";import{R as se,A as _e,S as Me,u as Le,M as ne}from"./keychain.query-DcP-HCIh.js";import{P as xt}from"./index-B7gCA80I.js";var bt={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M862 465.3h-81c-4.6 0-9 2-12.1 5.5L550 723.1V160c0-4.4-3.6-8-8-8h-60c-4.4 0-8 3.6-8 8v563.1L255.1 470.8c-3-3.5-7.4-5.5-12.1-5.5h-81c-6.8 0-10.5 8.1-6 13.2L487.9 861a31.96 31.96 0 0048.3 0L868 478.5c4.5-5.2.8-13.2-6-13.2z"}}]},name:"arrow-down",theme:"outlined"};function ae(){return ae=Object.assign?Object.assign.bind():function(s){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var o in a)Object.prototype.hasOwnProperty.call(a,o)&&(s[o]=a[o])}return s},ae.apply(this,arguments)}const yt=(s,t)=>n.createElement(Y,ae({},s,{ref:t,icon:bt})),vt=n.forwardRef(yt);var kt={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M257.7 752c2 0 4-.2 6-.5L431.9 722c2-.4 3.9-1.3 5.3-2.8l423.9-423.9a9.96 9.96 0 000-14.1L694.9 114.9c-1.9-1.9-4.4-2.9-7.1-2.9s-5.2 1-7.1 2.9L256.8 538.8c-1.5 1.5-2.4 3.3-2.8 5.3l-29.5 168.2a33.5 33.5 0 009.4 29.8c6.6 6.4 14.9 9.9 23.8 9.9zm67.4-174.4L687.8 215l73.3 73.3-362.7 362.6-88.9 15.7 15.6-89zM880 836H144c-17.7 0-32 14.3-32 32v36c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-36c0-17.7-14.3-32-32-32z"}}]},name:"edit",theme:"outlined"};function re(){return re=Object.assign?Object.assign.bind():function(s){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var o in a)Object.prototype.hasOwnProperty.call(a,o)&&(s[o]=a[o])}return s},re.apply(this,arguments)}const jt=(s,t)=>n.createElement(Y,re({},s,{ref:t,icon:kt})),wt=n.forwardRef(jt);var Ct={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M608 112c-167.9 0-304 136.1-304 304 0 70.3 23.9 135 63.9 186.5l-41.1 41.1-62.3-62.3a8.15 8.15 0 00-11.4 0l-39.8 39.8a8.15 8.15 0 000 11.4l62.3 62.3-44.9 44.9-62.3-62.3a8.15 8.15 0 00-11.4 0l-39.8 39.8a8.15 8.15 0 000 11.4l62.3 62.3-65.3 65.3a8.03 8.03 0 000 11.3l42.3 42.3c3.1 3.1 8.2 3.1 11.3 0l253.6-253.6A304.06 304.06 0 00608 720c167.9 0 304-136.1 304-304S775.9 112 608 112zm161.2 465.2C726.2 620.3 668.9 644 608 644c-60.9 0-118.2-23.7-161.2-66.8-43.1-43-66.8-100.3-66.8-161.2 0-60.9 23.7-118.2 66.8-161.2 43-43.1 100.3-66.8 161.2-66.8 60.9 0 118.2 23.7 161.2 66.8 43.1 43 66.8 100.3 66.8 161.2 0 60.9-23.7 118.2-66.8 161.2z"}}]},name:"key",theme:"outlined"};function oe(){return oe=Object.assign?Object.assign.bind():function(s){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var o in a)Object.prototype.hasOwnProperty.call(a,o)&&(s[o]=a[o])}return s},oe.apply(this,arguments)}const Nt=(s,t)=>n.createElement(Y,oe({},s,{ref:t,icon:Ct})),Ft=n.forwardRef(Nt);var Pt={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M909.1 209.3l-56.4 44.1C775.8 155.1 656.2 92 521.9 92 290 92 102.3 279.5 102 511.5 101.7 743.7 289.8 932 521.9 932c181.3 0 335.8-115 394.6-276.1 1.5-4.2-.7-8.9-4.9-10.3l-56.7-19.5a8 8 0 00-10.1 4.8c-1.8 5-3.8 10-5.9 14.9-17.3 41-42.1 77.8-73.7 109.4A344.77 344.77 0 01655.9 829c-42.3 17.9-87.4 27-133.8 27-46.5 0-91.5-9.1-133.8-27A341.5 341.5 0 01279 755.2a342.16 342.16 0 01-73.7-109.4c-17.9-42.4-27-87.4-27-133.9s9.1-91.5 27-133.9c17.3-41 42.1-77.8 73.7-109.4 31.6-31.6 68.4-56.4 109.3-73.8 42.3-17.9 87.4-27 133.8-27 46.5 0 91.5 9.1 133.8 27a341.5 341.5 0 01109.3 73.8c9.9 9.9 19.2 20.4 27.8 31.4l-60.2 47a8 8 0 003 14.1l175.6 43c5 1.2 9.9-2.6 9.9-7.7l.8-180.9c-.1-6.6-7.8-10.3-13-6.2z"}}]},name:"reload",theme:"outlined"};function ce(){return ce=Object.assign?Object.assign.bind():function(s){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var o in a)Object.prototype.hasOwnProperty.call(a,o)&&(s[o]=a[o])}return s},ce.apply(this,arguments)}const Et=(s,t)=>n.createElement(Y,ce({},s,{ref:t,icon:Pt})),qe=n.forwardRef(Et);function ie(){return ie=Object.assign?Object.assign.bind():function(s){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var o in a)Object.prototype.hasOwnProperty.call(a,o)&&(s[o]=a[o])}return s},ie.apply(this,arguments)}const It=(s,t)=>n.createElement(Y,ie({},s,{ref:t,icon:Qe})),Rt=n.forwardRef(It);function $t(s,t,a){const o=n.useRef({});return(!("value"in o.current)||a(o.current.condition,t))&&(o.current.value=s(),o.current.condition=t),o.current.value}Number(n.version.split(".")[0]);const St=(s,t)=>{typeof s=="function"?s(t):typeof s=="object"&&s&&"current"in s&&(s.current=t)},Ot=(...s)=>{const t=s.filter(Boolean);return t.length<=1?t[0]:a=>{s.forEach(o=>{St(o,a)})}},Tt=(...s)=>$t(()=>Ot(...s),s,(t,a)=>t.length!==a.length||t.every((o,i)=>o!==a[i]));function ee(){return ee=Object.assign?Object.assign.bind():function(s){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var o in a)Object.prototype.hasOwnProperty.call(a,o)&&(s[o]=a[o])}return s},ee.apply(this,arguments)}const ze=n.forwardRef((s,t)=>{const{className:a,component:o,viewBox:i,spin:l,rotate:r,tabIndex:c,onClick:u,children:p,...w}=s,h=n.useRef(),x=Tt(h,t);ve(!!(o||p),"Should have `component` prop or `children`."),We(h);const{prefixCls:$="anticon",rootClassName:j}=n.useContext(Ue),d=ke(j,$,{[`${$}-spin`]:!!l&&!!o},a),B=ke({[`${$}-spin`]:!!l}),b=r?{msTransform:`rotate(${r}deg)`,transform:`rotate(${r}deg)`}:void 0,S={...Ge,className:B,style:b,viewBox:i};i||delete S.viewBox;const L=()=>o?n.createElement(o,S,p):p?(ve(!!i||n.Children.count(p)===1&&n.isValidElement(p)&&n.Children.only(p).type==="use","Make sure that you provide correct `viewBox` prop (default `0 0 1024 1024`) to the icon."),n.createElement("svg",ee({},S,{viewBox:i}),p)):null;let f=c;return f===void 0&&u&&(f=-1),n.createElement("span",ee({role:"img"},w,{ref:x,tabIndex:f,onClick:u,className:d}),L())});ze.displayName="AntdIcon";function Bt({isOpen:s,onClose:t,children:a,title:o,width:i=400,offset:l={right:24,top:0,bottom:0},footer:r}){const[c,u]=n.useState(!1),[p,w]=n.useState(!1),h={right:l.right??24,top:l.top??0,bottom:l.bottom??0};return n.useEffect(()=>{if(s)u(!0),requestAnimationFrame(()=>{requestAnimationFrame(()=>{w(!0)})});else{w(!1);const x=setTimeout(()=>{u(!1)},300);return()=>clearTimeout(x)}},[s]),c?e.jsxs("div",{className:"fixed inset-0 z-50",children:[e.jsx("div",{className:"absolute inset-0 bg-opacity-25 transition-opacity duration-300",style:{opacity:p?1:0}}),e.jsxs("div",{className:"absolute right-0 bg-white shadow-lg rounded-[var(--ant-border-radius)] flex flex-col",style:{width:typeof i=="number"?`${i}px`:i,transform:p?"translateX(0) scale(1)":"translateX(100%) scale(0.9)",transformOrigin:"right center",right:`${h.right}px`,top:h.top>0?h.top:0,bottom:h.bottom>0?h.bottom:0,height:h.top>0||h.bottom>0?"auto":"100%",pointerEvents:"auto",overflowY:"auto",maxHeight:`calc(100vh - ${h.top+h.bottom}px)`,boxShadow:"-4px 0 15px rgba(0, 0, 0, 0.1)",transition:"transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)"},children:[e.jsxs("div",{className:"flex justify-between items-center p-4 border-b border-gray-200",children:[e.jsx("h3",{className:"text-lg font-medium",children:o}),e.jsx(I,{onClick:t,type:"text",size:"small",icon:e.jsx(Ze,{})})]}),e.jsx("div",{className:"p-6 flex-1 min-h-0 overflow-y-auto",children:a}),r&&e.jsx("div",{className:"p-4 border-t border-gray-200",children:r})]})]}):null}function me(s){return t=>({validator:async(a,o)=>{const i=t.getFieldsValue(),l=T.get(i,a.field.replace("path","endpoint")),r=T.get(i,a.field.replace("path","keychain_id"));if(!r)return Promise.reject(new Error(V.t("bucketForm.keychainIdRequired")));if(!l)return Promise.reject(new Error(V.t("bucketForm.endpointRequired")));if(!o)return Promise.reject(new Error(V.t("bucketForm.pathRequired")));if(!o.startsWith("s3://"))return Promise.reject(new Error(V.t("bucketForm.pathValidMessage")));try{const c=T.find(s,p=>p.value===r);if(!c)return Promise.reject(new Error(V.t("bucketForm.keychainIdRequired")));const u=await Je({endpoint:l,keychain_id:c.value,path:o});return T.get(u,"data")?Promise.resolve():Promise.reject(new Error(V.t("bucketForm.noPermission")))}catch(c){return Promise.reject(new Error(T.get(c,"message")))}}})}const le="open-bucket-manager";function _t(s){const t=new CustomEvent(le,{detail:s});document.dispatchEvent(t)}function fe(){return{async validator(s,t){if(!t)return Promise.reject(new Error(V.t("bucketForm.endpointRequired")));const a=await et(t);return T.get(a,"data",!1)?Promise.resolve(V.t("bucketForm.endpointAccessible")):Promise.reject(new Error(V.t("bucketForm.endpointInvalid")))}}}function De(){const{data:s,isLoading:t,...a}=Le();return{keyOptions:n.useMemo(()=>T.map(s,i=>({label:i.name,value:i.id,access_key_id:i.access_key_id})),[s]),isLoading:t,keyChainQuery:a}}function Mt({modalRef:s,className:t,showTrigger:a=!0}){const[o,i]=n.useState(!1),[l]=R.useForm(),{t:r}=Q(),{keyOptions:c,isLoading:u,keyChainQuery:p}=De(),{mutateAsync:w,isPending:h}=Xe(),x=W();n.useEffect(()=>{const b=S=>{l.resetFields(),S.detail&&setTimeout(()=>{l.setFieldsValue(S.detail)}),i(!0)};return document.addEventListener(le,b),()=>{document.removeEventListener(le,b)}},[l,o]),n.useImperativeHandle(s,()=>({open:b=>{l.resetFields(),b&&setTimeout(()=>{l.setFieldsValue(b)}),i(!0)},close:()=>{l.resetFields(),i(!1)}}));const $=()=>{l.resetFields(),i(!1)},j=async b=>{if(T.size(b==null?void 0:b.buckets)===0){X.error(r("bucketForm.atLeastOnePath"));return}await w(b.buckets),X.success(r("bucketForm.pathAdded")),$(),x.invalidateQueries({queryKey:["bucket"]})},d=()=>{l.submit()},B=n.useMemo(()=>{var b;return{buckets:[{keychain_id:(b=c[0])==null?void 0:b.value,endpoint:"",path:""}]}},[c]);return e.jsxs(e.Fragment,{children:[a&&e.jsx(A,{title:r("bucketForm.triggerTooltipMessage"),placement:"bottomLeft",children:e.jsx(I,{className:t,onClick:()=>i(!0),type:"primary",icon:e.jsx(se,{}),children:r("bucketForm.addBucket")})}),e.jsx(Bt,{isOpen:o,onClose:$,title:r("bucketForm.addBucket"),width:600,offset:{right:16,top:72,bottom:16},footer:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(I,{type:"primary",loading:h,onClick:d,children:r("bucketForm.save")}),e.jsx(I,{type:"default",onClick:$,children:r("bucketForm.cancel")})]}),children:e.jsx("div",{className:"",children:e.jsxs(R,{form:l,layout:"vertical",onFinish:j,initialValues:B,children:[e.jsx(_e,{className:"!mb-4",type:"info",showIcon:!0,message:e.jsxs("div",{children:[r("bucketForm.alertMessage")," → ",e.jsxs(I,{type:"link",className:"!text-[var(--ant-color-primary)] !px-0",target:"_blank",size:"small",href:"/keychain",children:[r("bucketForm.AS&SKManagement"),e.jsx(Se,{})]})]})}),e.jsx(R.List,{name:"buckets",children:(b,{add:S,remove:L})=>e.jsxs(e.Fragment,{children:[b.map((f,y)=>e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("span",{className:"font-bold text-black",children:[r("bucketForm.path"),"  ",y+1]}),e.jsx(A,{title:r("bucketForm.remove"),children:e.jsx(I,{size:"small",type:"text",danger:!0,icon:e.jsx(ze,{component:Me}),onClick:()=>L(y)})})]}),e.jsx(R.Item,{className:"!mb-0",label:e.jsxs("div",{className:"flex items-center gap-2",children:["AK&SK",e.jsx(A,{title:r("bucketForm.refresh"),children:e.jsx(I,{type:"text",size:"small",icon:e.jsx(qe,{}),loading:p.isFetching,onClick:()=>p.refetch()})})]}),required:!0,name:[y,"keychain_id"],rules:[{required:!0,message:r("bucketForm.keychainIdRequired")}],children:e.jsx(he,{className:"w-full",loading:u,options:c,placeholder:r("bucketForm.keychainIdRequired"),optionRender:F=>e.jsxs("div",{className:"flex flex-col gap-1",children:[F.label,e.jsx("span",{className:"text-gray-400",children:F.data.access_key_id})]})})}),e.jsx(R.Item,{label:"Endpoint",required:!0,hasFeedback:!0,className:"!mb-0",name:[y,"endpoint"],validateDebounce:1e3,rules:[{type:"url",message:r("bucketForm.endpointValidMessage")},fe],children:e.jsx(H,{placeholder:r("bucketForm.endpointPlaceholder")})}),e.jsx(R.Item,{label:r("bucketForm.path"),tooltip:r("bucketForm.pathTooltip"),required:!0,hasFeedback:!0,className:"!mb-0",name:[y,"path"],validateDebounce:1e3,rules:[me(c)],children:e.jsx(H,{placeholder:r("bucketForm.pathPlaceholder")})}),b.length>1&&y<b.length-1&&e.jsx(Ye,{})]},f.key)),e.jsx(I,{className:"mt-6",block:!0,icon:e.jsx(se,{}),onClick:()=>S(),children:r("bucketForm.add")})]})})]})})})]})}const Lt="_tree_1b5hq_2",Fe={tree:Lt},qt=s=>n.createElement("svg",{stroke:"currentColor",fill:"currentColor",strokeWidth:0,viewBox:"0 0 24 24",height:"1em",width:"1em",xmlns:"http://www.w3.org/2000/svg",...s},n.createElement("path",{d:"M4 6h2v12H4zm4 7h8.586l-4.293 4.293 1.414 1.414L20.414 12l-6.707-6.707-1.414 1.414L16.586 11H8z"})),zt=s=>n.createElement("svg",{stroke:"currentColor",fill:"currentColor",strokeWidth:0,viewBox:"0 0 24 24",height:"1em",width:"1em",xmlns:"http://www.w3.org/2000/svg",...s},n.createElement("path",{d:"M18 6h2v12h-2zm-2 5H7.414l4.293-4.293-1.414-1.414L3.586 12l6.707 6.707 1.414-1.414L7.414 13H16z"})),Dt=s=>n.createElement("svg",{width:"1em",height:"1em",viewBox:"0 0 20 20",fill:"none",xmlns:"http://www.w3.org/2000/svg",...s},n.createElement("path",{d:"M8.03243 3.33325C8.25344 3.33325 8.4654 3.42105 8.62168 3.57733L9.80019 4.75584C9.95647 4.91212 10.1684 4.99992 10.3894 4.99992H17.5443C18.0045 4.99992 18.3776 5.37301 18.3776 5.83325V15.8333C18.3776 16.2935 18.0045 16.6666 17.5443 16.6666H2.54427C2.08403 16.6666 1.71094 16.2935 1.71094 15.8333V4.16659C1.71094 3.70635 2.08403 3.33325 2.54427 3.33325H8.03243Z",fill:"#3477EB"}),n.createElement("path",{d:"M3.37695 8.75C3.37695 8.05964 3.9366 7.5 4.62695 7.5H15.4603C16.1506 7.5 16.7103 8.05964 16.7103 8.75H3.37695Z",fill:"white"}));function Pe(s){const t=s.replace(/^s3:\/\//,"").split("/");return t.map((a,o)=>{const i=t.slice(0,o+1).join("/");return{fragment:a,path:i,fullPath:`s3://${i}/`}})}function At(){const{open:s,setOpen:t}=Ke(),{t:a}=Q(),o=n.useCallback(()=>{document.dispatchEvent(new CustomEvent("toggleDirectoryTree",{detail:{open:!s}}))},[s,t]);return e.jsx(A,{title:a(s?"directoryTree.hide":"directoryTree.show"),placement:"bottomLeft",children:e.jsx(I,{icon:s?e.jsx(zt,{}):e.jsx(qt,{}),onClick:o})})}const Ae=n.createContext({open:!1,setOpen:()=>{}});function Ke(){const s=n.useContext(Ae);if(!s)throw new Error("useTreeContext must be used within a DirectoryTreeProvider");return s}function Kt({children:s}){const[t,a]=n.useState(!1),o=n.useMemo(()=>({open:t,setOpen:a}),[t]);return e.jsx(Ae.Provider,{value:o,children:s})}function Vt({treeRef:s,className:t}){const[a,o]=n.useState({}),i=n.useRef(!1),r=U().search,c=r.path||"",u=c==null?void 0:c.split("?")[0],[p,w]=n.useState([`${r.id}-${u}`]),[h,x]=n.useState([c]),{open:$,setOpen:j}=Ke(),[d,B]=n.useState(!1),b=W(),S=J(),L=Number(r.page_size)||50,{t:f}=Q(),[y,F]=n.useState(!1),O=n.useCallback((g,v,E)=>g?["bucket",{path:g,pageNo:v??T.get(a,[g,"pageNo"],1),pageSize:L,id:E??r.id}]:["bucket"],[a,r.id]);n.useEffect(()=>{w([`${r.id}-${u}`])},[u]),n.useEffect(()=>{const g=Pe(c).slice(0,-1);c&&x(g.map(v=>`${r.id}-${v.fullPath}`))},[c]);const P=n.useCallback(async g=>{if(j(g),i.current)return;i.current=!0;const v=Pe(c).slice(0,-1);B(!0);const _=(await Promise.all([b.fetchQuery({queryKey:O(),staleTime:1e4,queryFn:()=>Z({path:"/"})}),...v.map(M=>b.fetchQuery({queryKey:O(M.fullPath),staleTime:1e4,queryFn:()=>Z({path:M.fullPath,id:Number(r.id)})}))]).finally(()=>{B(!1)})).reduce((M,C,q)=>(q===0?M["s3://"]={total:C.total??0,data:C.data,pageNo:C.page_no??1}:M[`${C.data[0].id}-${v[q-1].fullPath}`]={total:C.total??0,data:C.data,pageNo:C.page_no??1},M),{});o(_)},[c,r.id]);n.useEffect(()=>{const g=v=>{P(v.detail.open)};return document.addEventListener("toggleDirectoryTree",g),()=>{document.removeEventListener("toggleDirectoryTree",g)}},[P]),n.useImperativeHandle(s,()=>({toggle:P}));const N=n.useCallback(async(g,v,E)=>{let _=v;if(g==="file")return;v.startsWith("s3://")||(_=`${c}${v}`),["bucket","dir"].includes(g)&&!_.endsWith("/")&&(_=`${_}/`);const M=await b.fetchQuery({queryKey:O(_,E),staleTime:1e4,queryFn:()=>Z({path:_,id:E})});o(C=>{const q=`${E}-${_}`;return C[q]?C:{...C,[q]:{total:M.total??0,data:M.data,pageNo:M.page_no??1}}})},[c]),D=n.useCallback(async({key:g,raw:v})=>{if(g.endsWith("///load-more")){if(y)return;const E=`${v.id}-${v.path}`,_=T.get(a,[E,"pageNo"],1)+1;F(!0);const M=await b.fetchQuery({queryKey:O(v.path,_),staleTime:1e4,queryFn:()=>Z({path:v.path,id:v.id,pageNo:_})});o(C=>{const q=C[E];return{...C,[E]:{total:M.total+((q==null?void 0:q.total)??0),data:[...(q==null?void 0:q.data)??[],...M.data],pageNo:_}}}),F(!1);return}S({to:"/",search:{...r,path:v.path,id:v.id}})},[r,a,y]),m=n.useCallback(g=>{const v=g.raw.path,E=`${g.raw.id}-${v}`;return a[E]?Promise.resolve():N(T.get(g,"raw.type"),v,g.raw.id)},[N,a]),k=n.useMemo(()=>{var v;const g=(E,_=0,M="")=>T.map(E,C=>{var xe,be,ye;const q=C.path.replace(M,"").replace(/\/$/,""),G=`${C.id}-${C.path}`,He={title:e.jsx("span",{className:"whitespace-nowrap",children:f("directoryTree.loadMore")}),key:`${G}///load-more`,isLeaf:!0,icon:y?e.jsx(nt,{spin:!0}):e.jsx(vt,{}),raw:C},ge=g(((xe=a[G])==null?void 0:xe.data)||[],_+1,C.path);return((be=a[G])==null?void 0:be.total)%L===0&&((ye=a[G])==null?void 0:ye.total)>0&&ge.push(He),{title:e.jsx("span",{className:"whitespace-nowrap",children:q}),key:G,children:ge,isLeaf:C.type==="file",icon:e.jsx("div",{className:"text-lg w-4 h-4",children:C.path.endsWith("/")?e.jsx(je,{type:"folder"}):e.jsx(je,{path:C.path})}),raw:C}});return g(((v=a["s3://"])==null?void 0:v.data)||[],0,"s3://")},[c,a,y]);return d?e.jsx(tt,{className:Fe.tree,active:!0}):e.jsx("div",{className:z(Fe.tree,t,{hidden:!$||!c}),children:e.jsx(st.DirectoryTree,{expandedKeys:h,onExpand:g=>x(g),loadData:m,icon:e.jsx(Dt,{className:"text-lg"}),blockNode:!0,selectedKeys:p,onSelect:(g,{node:v})=>D(v),treeData:k})})}const Ht="_shortcutPathDropdown_1klmh_7",Qt="_listItem_1klmh_14",de={shortcutPathDropdown:Ht,listItem:Qt},ue=e.jsx(Te,{className:"text-gray-300 text-[12px]"});function Ee({fragment:s,hideArrow:t,clickable:a=!0,onClick:o,className:i}){const l=W(),r=J(),u=U().search,p=u.path||"",w=n.useCallback(h=>{h.stopPropagation(),h.preventDefault();const x=`s3://${p}${p.endsWith("/")?"":"/"}`;l.invalidateQueries(),r({to:"/",search:{...u,id:p?u.id:void 0,path:x,page_no:1}})},[p,u,r]);return e.jsxs("div",{className:z("flex items-center whitespace-nowrap",i),children:[!t&&ue,e.jsx("div",{className:z({"cursor-pointer duration-100 hover:bg-(--ant-color-primary-bg) hover:text-(--ant-color-primary) rounded":a,"cursor-text":!a},"px-1 py-0.5"),onClick:a?o??w:void 0,children:s})]})}function Ie(s){const t=s.replace(/^s3:\/\//,"").split("/");return t.map((a,o)=>({fragment:a,path:t.slice(0,o+1).join("/")}))}function Wt(s){document.dispatchEvent(new CustomEvent("correct-path",{detail:s}))}function Ut({containerRef:s}){const t=n.useRef(null),a=n.useRef(null),[o,i]=n.useState(!1),l=J(),r=n.useRef(null),[c,u]=n.useState([]),[p,w]=n.useState([]),{t:h}=Q(),[x]=R.useForm(),j=U().search,d=j.path||"",B=W();n.useEffect(()=>{w(Ie(d))},[d]),n.useImperativeHandle(s,()=>({toggleFocus:m=>{i(m)},form:x})),n.useEffect(()=>{const m=k=>{setTimeout(()=>{x.setFieldValue("path",k.detail),w(Ie(k.detail))})};return document.addEventListener("correct-path",m),()=>{document.removeEventListener("correct-path",m)}},[]),n.useLayoutEffect(()=>{if(!t.current||!r.current)return;r.current.style.width=`${t.current.offsetWidth}px`,r.current.style.height=`${t.current.offsetHeight}px`;let m=0;r.current.innerHTML="";const k=[],g=[{fragment:"s3",path:""},...p];for(let v=0;v<g.length;v++){const E=document.createElement("div");E.style.display="flex",E.style.alignItems="center",E.style.whiteSpace="nowrap",E.innerHTML=`
        <div style="display: flex;align-items: center;white-space: nowrap;">
          <div style="width: 14px;height: 14px;background-color: #000;"></div>
          <div style="padding-left: 0.25rem;padding-right: 0.25rem;">${g[v].fragment}</div>
        </div>
      `,k.push(E)}for(r.current.append(...k);r.current.scrollWidth-r.current.offsetWidth>0;)r.current.childNodes[0].remove(),m+=1;u(p.slice(0,m))},[p,o]),n.useEffect(()=>{x.setFieldValue("path",d??"")},[d]);const b=m=>{m.key==="Enter"&&x.submit()},S=m=>{var k;(k=document.querySelector(".shortcut-path-dropdown"))!=null&&k.contains(m.target)||(i(!0),setTimeout(()=>{var g;(g=a.current)==null||g.focus()},100))},L=async()=>{const m=await x.validateFields(),k=x.getFieldValue("path");m&&k.split("?")[0]===d.split("?")[0]&&i(!1)},f=m=>{m.stopPropagation(),m.preventDefault(),l({to:"/",search:{page_no:1}})},y=n.useCallback(m=>k=>{k.stopPropagation(),k.preventDefault();const g=`s3://${m}${m.endsWith("/")?"":"/"}`;B.invalidateQueries(),l({to:"/",search:{...j,id:d?j.id:void 0,path:g,page_no:1}})},[d,j,l]),F=m=>{const k=m.path.trim();B.invalidateQueries(),l({to:"/",search:{...j,id:d?j.id:void 0,path:k}}),setTimeout(()=>{i(!1)},1e3)},O=m=>{x.setFieldValue("path",m.path.trim())},P=n.useMemo(()=>({onClick:({key:m,domEvent:k})=>{y(m)(k)},items:c.map(m=>({key:m.path,label:m.fragment}))}),[y,c]),N=n.useMemo(()=>({path:d}),[d]),D=o||!d;return e.jsxs(e.Fragment,{children:[e.jsx(R,{layout:"inline",form:x,className:z({"w-full":D,visible:D,absolute:!D,invisible:!D,"z-[-1]":!D,"left-8":!D}),onFinish:F,initialValues:N,onValuesChange:O,children:e.jsx(R.Item,{label:"",name:"path",className:"!flex-1 !m-0",rules:[{pattern:/^s3:\/\//,message:h("bucket.pathMustStartWithS3")}],children:e.jsx(H,{className:z("w-full rounded-none !shadow-none"),ref:a,allowClear:!0,placeholder:h("bucket.searchPlaceholder"),onKeyDown:b,onBlur:L})})}),e.jsxs("div",{id:"path-container",ref:t,className:z({visible:!o,invisible:o||!d,"z-[-1]":o||!d,absolute:o||!d},"flex items-center flex-1 cursor-text overflow-auto w-0 border-t border-b border-gray-300 bg-white"),onClick:S,children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(Ee,{fragment:"s3",path:"",className:"ml-1",hideArrow:!0,onClick:f}),ue]}),c.length>0&&e.jsx(it,{rootClassName:de.shortcutPathDropdown,menu:P,children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"hover:bg-(--ant-color-primary-bg) hover:text-(--ant-color-primary) px-1 cursor-pointer rounded duration-100",children:"..."}),ue]})}),e.jsx("div",{className:"flex items-center",children:p.slice(c.length).map((m,k)=>e.jsx(Ee,{hideArrow:k===0,clickable:k+c.length!==p.length-1,onClick:y(m.path),fragment:m.fragment,path:m.path},k))})]}),e.jsx("div",{id:"path-contaner-shadow",className:"absolute top-0 left-0 flex items-center flex-1 overflow-auto min-w-0 invisible z-[-1]",ref:r})]})}function Gt(){const{t:s}=Q(),t=n.useRef(null),a=at(),i=U().search,l=J(),[,r,c,u]=Oe(),p=pe(),w=()=>{let d=r;r.endsWith("/")?d=r.replace(/[^/]+\/$/,""):d=r.replace(/[^/]+$/,""),d==="s3://"&&(d=""),l({to:"/",search:{...i,id:d?i.id:void 0,path:d}})},h=T.get(p,"data.total",0),x=()=>{navigator.clipboard.writeText(r),X.success(s("copied"))},$=r.split("?")[0],j=r&&$.endsWith("/");return e.jsxs("div",{className:z("bucket-header"," flex items-center gap-2"),children:[r&&e.jsx(At,{}),e.jsxs(we.Compact,{className:"flex flex-1 text-sm relative",children:[e.jsx(A,{title:s("bucket.returnToParent"),placement:"bottomLeft",children:e.jsx(I,{disabled:!r||r==="s3://",icon:e.jsx(rt,{}),onClick:w})}),e.jsx(Ut,{containerRef:t}),e.jsx(A,{title:s("bucket.searchPath"),children:e.jsx(I,{disabled:a>0,icon:e.jsx(Rt,{}),onClick:()=>{var d;return(d=t.current)==null?void 0:d.form.submit()}})}),e.jsx(A,{title:s("bucket.copyPath"),children:e.jsx(I,{disabled:!r,icon:e.jsx(ot,{}),onClick:x})})]}),e.jsxs(e.Fragment,{children:[j&&e.jsxs(we.Compact,{children:[e.jsx(A,{title:s("bucket.prevPage"),children:e.jsx(I,{disabled:!c||c===1,onClick:()=>l({to:"/",search:{...i,page_no:c-1}}),icon:e.jsx(ct,{})})}),e.jsx(H,{className:"!w-16 text-center",min:1,readOnly:!0,value:c??"1"}),e.jsx(A,{title:s("bucket.nextPage"),children:e.jsx(I,{onClick:()=>l({to:"/",search:{...i,page_no:c+1}}),icon:e.jsx(Te,{}),disabled:h<c*u})})]}),e.jsx(A,{title:s("bucketForm.addBucket"),placement:"topLeft",children:e.jsx(I,{type:"primary",icon:e.jsx(se,{}),onClick:()=>{_t()}})})]})]})}const Re=s=>n.createElement("svg",{width:"1em",height:"1em",viewBox:"0 0 20 20",fill:"none",xmlns:"http://www.w3.org/2000/svg",...s},n.createElement("path",{d:"M8.03243 3.33325C8.25344 3.33325 8.4654 3.42105 8.62168 3.57733L9.80019 4.75584C9.95647 4.91212 10.1684 4.99992 10.3894 4.99992H17.5443C18.0045 4.99992 18.3776 5.37301 18.3776 5.83325V15.8333C18.3776 16.2935 18.0045 16.6666 17.5443 16.6666H2.54427C2.08403 16.6666 1.71094 16.2935 1.71094 15.8333V4.16659C1.71094 3.70635 2.08403 3.33325 2.54427 3.33325H8.03243Z",fill:"#FFBA52"}),n.createElement("path",{d:"M3.37793 8.75C3.37793 8.05964 3.93757 7.5 4.62793 7.5H15.4613C16.1516 7.5 16.7113 8.05964 16.7113 8.75H3.37793Z",fill:"white"})),K="ORIGIN";function $e(){return Math.random().toString(36).substring(2,15)}function Zt(s,t){const a=document.createElement("a");a.href=s,t&&a.setAttribute("download",t),document.body.appendChild(a),a.click(),setTimeout(()=>{document.body.removeChild(a)})}async function Xt(s){if(!s.startsWith("s3://"))throw new Error("s3路径必须以s3://开头");const t=s.split("/").pop();try{const a={path:s},i=`/api/v1/bucket/download?${new URLSearchParams(a).toString()}`;Zt(i,t)}catch{throw new Error("下载失败")}}function Ve({modalRef:s}){const[t,a]=n.useState(null),[o,i]=n.useState(!1),{data:l,isLoading:r}=Le(typeof t=="number"),[c]=R.useForm(),{t:u}=Q(),{mutateAsync:p}=lt(),w=W(),h=l==null?void 0:l.map(d=>({label:d.name,value:d.id}));n.useImperativeHandle(s,()=>({open:d=>{a(d),i(!0)}}));const{data:x}=dt(t);n.useEffect(()=>{x&&c.setFieldsValue(x)},[x]);const $=()=>{i(!1),a(null)},j=async()=>{i(!1),a(null);const d=c.getFieldsValue(),B=T.get(d,"endpoint"),b=T.get(d,"keychain_id"),S=T.get(d,"path"),L=T.get(d,"name");await p({id:t,body:{endpoint:B,keychain_id:b,path:S,name:L}}),w.invalidateQueries({queryKey:["bucket"]}),X.success(u("bucketUpdated"))};return e.jsx(ne,{title:u("editBucket"),open:o,onCancel:$,onOk:j,loading:r,children:e.jsxs(R,{form:c,layout:"vertical",name:"bucket",initialValues:x,onFinish:j,children:[e.jsx(R.Item,{label:u("bucketForm.path"),hasFeedback:!0,name:"path",required:!0,validateDebounce:1e3,rules:[me(h)],children:e.jsx(H,{placeholder:u("bucketForm.pathPlaceholder")})}),e.jsx(R.Item,{label:u("bucketForm.endpoint"),name:"endpoint",required:!0,hasFeedback:!0,validateDebounce:1e3,rules:[{type:"url",message:u("bucketForm.endpointValidMessage")},fe],children:e.jsx(H,{placeholder:u("bucketForm.endpointPlaceholder")})}),e.jsx(R.Item,{label:u("bucketForm.keychainId"),name:"keychain_id",rules:[{required:!0,message:u("bucketForm.keychainIdRequired")}],children:e.jsx(he,{options:h})})]})})}function Yt({block:s,onClose:t,pageSize:a=50,pageNo:o=1,updateBlock:i,...l}){const{path:r,id:c,bucketId:u}=s,[p,w]=n.useState(a),[h,x]=n.useState(o),$=J(),d=U().search,B=n.useMemo(()=>r?["bucket",{path:r,pageSize:p,pageNo:h,id:u}]:["bucket"],[r,p,h,u]);n.useEffect(()=>{c===K&&x(o)},[o]),n.useEffect(()=>{c===K&&w(a)},[a]);const b=n.useMemo(()=>({staleTime:r?1e4:0,queryKey:B,queryFn:()=>Z({path:r,pageSize:p,pageNo:h,id:c===K&&u?Number(u):void 0}).then(D=>D),select:N=>N.data}),[B]),{data:S,isLoading:L}=mt(b),f=n.useCallback(N=>{c===K&&Wt(N)},[c]),y=n.useCallback(N=>{if(c===K){const{path:D,...m}=N,k={};typeof N.path=="string"&&(k.path=D),m.pageNo&&(k.page_no=m.pageNo),m.pageSize&&(k.page_size=m.pageSize),$({to:"/",search:{...d,...k,id:!k.path&&Object.keys(m).length===0?void 0:d.id}})}else N.pageSize&&w(N.pageSize),N.pageNo&&x(N.pageNo);i==null||i(c,{path:N.path})},[c,d,i]),F=n.useCallback(N=>{window.open(`${window.location.origin}${window.location.pathname}?path=${encodeURIComponent(N)}&pageSize=${p}&pageNo=${h}`,"_blank","noopener,noreferrer")},[p,h,u]),O=c===K,P=Be(r);return e.jsx(ft,{id:s.id,path:s.path,loading:L,dataSource:S,onClose:t,onPathCorrection:f,onDownload:Xt,previewUrl:"/api/v1/bucket/preview",showGoParent:!O&&!!r,showPagination:!O&&P==="folder",onChange:y,closeable:!O,onOpenInNewTab:F,showOpenInNewTab:!O,...l})}function Jt({className:s}){const t=n.useRef(null),a=n.useRef(null),o=U(),i=W(),{t:l}=Q(),r=o.search,c=r.id,u=r.path||"",p=ut(u),w=Number(r.page_size)||50,h=Number(r.page_no)||1,x=Be(p)||"txt",[$,j]=n.useState([{id:K,path:u,bucketId:c}]);n.useEffect(()=>{j(f=>[{...f[0],bucketId:c},...f.slice(1)])},[c]);const d=n.useCallback((f,y)=>{j(F=>F.map(O=>O.id===f?{...O,...y}:O))},[]);n.useEffect(()=>{j(f=>[{...f[0],path:u,pathType:x}])},[u,x]),n.useEffect(()=>{const f=async y=>{const F=y.detail.path,O=await pt(F);if(O.data.length>1){ne.info({title:l("bucket.duplicatedBuckets"),content:e.jsx(te,{size:"small",bordered:!0,dataSource:O.data.map(P=>({name:P.name,path:P.path,id:P.id})),renderItem:P=>e.jsx(te.Item,{className:z(de.listItem,"!flex !items-center"),children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Re,{}),e.jsx("a",{href:"javascript:void(0)",className:"!hover:underline",onClick:()=>{j(N=>[...N.slice(0,1),...N.slice(1),{id:$e(),path:P.path,bucketId:P.id}]),ne.destroyAll()},children:`${P.path}/`}),P.name&&e.jsx(Ne,{children:P.name})]})})})});return}else j(P=>[...P.slice(0,1),...P.slice(1),{id:$e(),path:F,bucketId:O.data[0].id}]);setTimeout(()=>{t.current&&t.current.scrollTo({left:t.current.scrollWidth,behavior:"smooth"})})};return document.addEventListener("s3-path-click",f),()=>{document.removeEventListener("s3-path-click",f)}},[l]);const B=n.useCallback(f=>{j(y=>y.filter(F=>F.id!==f))},[]),b=n.useCallback(f=>Ce(f).then(()=>{X.success(l("upload.deleteSuccess")),i.invalidateQueries({queryKey:["bucket"]})}),[Ce,i]),S=pe(),L=n.useCallback(f=>T.get(S,"data.data",[]).filter(F=>F.path===f).length>1,[S]);return e.jsxs("div",{ref:t,className:z(s,"block-previewer","flex","items-start","gap-4","overflow-x-auto","h-full relative"),children:[$.map(f=>e.jsx(Yt,{block:f,updateBlock:d,onClose:()=>B(f.id),pageSize:f.id===K?w:void 0,pageNo:f.id===K?h:void 0,style:{width:`calc(100% / ${$.length})`},renderBucketItem:f.id===K?y=>e.jsxs(te.Item,{className:z(de.listItem,"!flex !items-center"),children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Re,{}),e.jsx(ht,{className:"hover:!underline",to:"/",search:{path:`${y.path}/`,id:y.id},children:`${y.path}/`}),L(y.path)&&e.jsxs(Ne,{color:"blue",children:[e.jsx(Ft,{})," ",y.keychain_name]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(I,{type:"text",size:"small",icon:e.jsx(wt,{}),onClick:()=>{var F;return(F=a.current)==null?void 0:F.open(y.id)}}),e.jsx(xt,{title:l("bucketForm.deleteConfirm"),onConfirm:()=>b(y.id),okText:l("ok"),cancelText:l("cancel"),children:e.jsx(I,{danger:!0,type:"text",size:"small",icon:e.jsx(Me,{})})})]})]}):void 0},f.id)),e.jsx(Ve,{modalRef:a})]})}function es({className:s}){const{t}=Q(),[a]=R.useForm(),{keyOptions:o,isLoading:i,keyChainQuery:l}=De(),{mutateAsync:r,isPending:c}=gt(),u=W(),p=async h=>{await r(h),u.invalidateQueries({queryKey:["bucket"]}),a.resetFields()},w=[{name:t("supportedCloudPlatforms.huawei"),icon:"/huawei.png"},{name:t("supportedCloudPlatforms.tencent"),icon:"/tencent.png"},{name:t("supportedCloudPlatforms.sensetime"),icon:"/sensetime.png"},{name:t("supportedCloudPlatforms.aws"),icon:"/aws.png"},{name:t("supportedCloudPlatforms.aliyun"),icon:"/aliyun.png"},{name:t("supportedCloudPlatforms.inspur"),icon:"/inspur.png"},{name:t("supportedCloudPlatforms.microsoft"),icon:"/microsoft.png"}];return e.jsxs("div",{className:z("flex flex-col items-center justify-center bg-[url(/bg.png)] bg-cover bg-center fixed inset-0 z-10",s),children:[e.jsx("div",{className:"text-center mb-12",children:e.jsx("h1",{className:"text-4xl font-bold mb-4",children:t("addFirstBucket")})}),e.jsxs(R,{form:a,className:"max-w-2xl",layout:"vertical",onFinish:p,children:[e.jsx(_e,{className:"!mb-4",type:"info",showIcon:!0,message:e.jsxs("div",{children:[t("bucketForm.alertMessage")," → ",e.jsxs(I,{type:"link",target:"_blank",size:"small",className:"!text-[var(--ant-color-primary)] !px-0",href:"/keychain",children:[t("bucketForm.AS&SKManagement")," ",e.jsx(Se,{})]})]})}),e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsx(R.Item,{className:"!mb-0",label:e.jsxs("div",{className:"flex items-center gap-2",children:["AK&SK",e.jsx(A,{title:t("bucketForm.refresh"),children:e.jsx(I,{type:"text",size:"small",icon:e.jsx(qe,{}),loading:l.isFetching,onClick:()=>l.refetch()})})]}),required:!0,name:"keychain_id",rules:[{required:!0,message:t("bucketForm.keychainIdRequired")}],children:e.jsx(he,{className:"w-full",loading:i,options:o,placeholder:t("bucketForm.keychainIdRequired"),optionRender:h=>e.jsxs("div",{className:"flex flex-col gap-1",children:[h.label,e.jsx("span",{className:"text-gray-400",children:h.data.access_key_id})]})})}),e.jsx(R.Item,{label:"Endpoint",required:!0,hasFeedback:!0,className:"!mb-0",name:"endpoint",validateDebounce:1e3,rules:[{type:"url",message:t("bucketForm.endpointValidMessage")},fe],children:e.jsx(H,{placeholder:t("bucketForm.endpointPlaceholder")})}),e.jsx(R.Item,{label:t("bucketForm.path"),tooltip:t("bucketForm.pathTooltip"),required:!0,hasFeedback:!0,className:"!mb-0",name:"path",validateDebounce:1e3,rules:[me(o)],children:e.jsx(H,{placeholder:t("bucketForm.pathPlaceholder")})}),e.jsx(R.Item,{children:e.jsx(I,{block:!0,type:"primary",size:"large",loading:c,onClick:a.submit,children:t("bucketForm.add")})})]})]}),e.jsxs("div",{className:"text-center text-gray-600 mt-4",children:[e.jsx("p",{children:t("currentSupport")}),e.jsx("div",{className:"flex justify-center items-center space-x-6 mt-4",children:w.map(h=>e.jsx("div",{className:"bg-white rounded-md w-8 h-8 p-1",title:h.name,children:e.jsx("img",{src:h.icon,alt:h.name,className:"w-full h-full object-contain"})},h.name))})]})]})}const as=function(){const t=n.useRef(null),a=n.useRef(null),[,o]=Oe(),{fetchingCount:i,data:l}=pe(),r=T.get(l,"total",0),c=!!l&&!o&&r===0&&i===0;return e.jsxs("div",{className:z("p-4",{"flex flex-1 flex-col":!c}),ref:t,children:[e.jsx(es,{className:z({block:c,hidden:!c})}),e.jsx(Kt,{children:e.jsxs("div",{className:z("flex-col gap-4 h-[calc(100vh-88px)]",{hidden:c,flex:!c}),children:[e.jsx(Gt,{}),e.jsxs("div",{className:"flex flex-1 min-h-0 overflow-y-auto relative gap-4",children:[e.jsx(Vt,{}),e.jsx(Jt,{className:"flex-1"})]})]})}),e.jsx(Mt,{showTrigger:!1}),e.jsx(Ve,{modalRef:a})]})};export{as as component};
