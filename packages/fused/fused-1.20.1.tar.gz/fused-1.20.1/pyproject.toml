[build-system]
requires = ["poetry-core>=2.0.0", "poetry-dynamic-versioning"]
build-backend = "poetry_dynamic_versioning.backend"

[project]
name = "fused"
dynamic = ["dependencies"]
description = ""
authors = []
readme = "README.md"
version = "1.20.1"

[tool.poetry]
packages = [
    { include = "fused" },
]
# Version is set to 0.0.0 as the version string is automatically generated by
# https://github.com/mtkennerly/poetry-dynamic-versioning

[project.urls]
Homepage = "https://www.fused.io"
Documentation = "https://docs.fused.io"
# Repository = "https://github.com/fusedlabs/fused-py"
# Issues = "https://github.com/fusedlabs/fused-py/issues"
Changelog = "https://docs.fused.io/python-sdk/changelog/"

[tool.versioning]
migration_version = "0.0.3"

[tool.poetry.dependencies]
python = ">=3.10,<4"
pydantic = "^2.7.0"
requests = "^2.31"
aiohttp = "^3.8.3"
yarl = "^1.9.4"
tqdm = "^4.67.1"

# TODO: Make optional
# Job dependencies
loguru = {version = "^0.7.0"}
pyarrow = {version = ">=11"}
numpy = {version = ">=1.20"}

rtoml = {version = "^0", markers = "sys_platform != 'emscripten'"}

shapely = {version = "^2", optional = true}
geopandas = {version = ">=0.14,<2", optional = true}
fsspec = {version = "^2024.3.1", optional = true}
affine = {version = "^2", optional = true}
pyproj = {version = "^3.7.1", optional = true}
importlib-resources = {version = "^5.12.0", optional = true}
pandas = {version = "^2.2.0", optional = true}
pillow = {version = ">=10", optional = true}
xarray = {version = "2024.3.0", optional = true}
rioxarray = {version = "^0.15", optional = true}
rasterio = {version = "^1.3.10", optional = true}
jinja2 = {version = "^3.1.2", optional = true}
mercantile = {version ="^1.2.1", optional = true}

[project.optional-dependencies]
batch = [
    "shapely",
    "geopandas",
    "fsspec",
    "affine",
    "pyproj",
    "importlib-resources",
    "pandas",
    "pillow",
    "xarray",
    "rioxarray",
    "jinja2",
    "mercantile",
]
raster = [
    "mercantile",
    "pillow",
    "xarray",
    "rioxarray",
    "rasterio",
]
vector = [
    "mercantile",
    "geopandas",
    "shapely",
]
all = [
    "shapely",
    "mercantile",
    "pillow",
    "xarray",
    "rioxarray",
    "rasterio",
    "geopandas",
]

[tool.poetry.group.dev.dependencies]
# Set black to exact pin because it uses calendar versioning
# Note that this should match the version in .pre-commit-config.yaml
black = {version = "23.7.0", extras = ["jupyter"]}
isort = "^5.12.0"
ipykernel = "^6.22.0"
# https://github.com/ipython/ipython/issues/14051
ipython = "^8.7.0,<8.12.1"
mypy = "^1"
types-requests = "^2.29.0.0"
pytest = "^7.3.1"
pytest-asyncio = "^0.23.5"
pre-commit = "^3.3.1"
pytest-httpserver = "^1.0.8"
coverage = "^7.3.1"

[tool.poetry.group.test.dependencies]
h3 = "4.0.0b3"
contextily = ">=1.3.0"

[tool.poetry-dynamic-versioning]
enable = false
vcs = "git"
# This makes strings like `1.3.2.dev3+28c1684` instead of `1.3.1.post3.dev0+28c1684`
bump = true
pattern-prefix = "fused-py-"

[tool.poetry-dynamic-versioning.substitution]
folders = [
    { path = "fused" }
]

[tool.ruff]
extend-exclude = ["tests/data/udf_with_utils/udf_with_utils.py"]
target-version = "py310"

[tool.ruff.lint]
select = [
    # pycodestyle
    "E",
    # Pyflakes
    "F",
    # isort
    "I",
]

ignore = [
    "E501", # Line length
    "E731", # assign to lambda
]

[tool.mypy]
plugins = "pydantic.mypy"

[tool.pytest.ini_options]
norecursedirs = ["integration_tests", "docker_integration_tests"] # do not run the integration tests unless explicitly requested
markers = [
    "require_auth: tests that require an authenticated API (locally, or with refresh token on CI)",
]
asyncio_mode = "auto"
