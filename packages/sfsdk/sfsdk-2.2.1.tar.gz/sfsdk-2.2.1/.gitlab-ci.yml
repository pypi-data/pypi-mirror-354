image: python:3-alpine

stages:
  - build
  - pypi-release

build:
  stage: build
  script:
    - apk add --no-cache git build-base libffi-dev openssl-dev
    - pip install --upgrade build
    - echo "Building $(python -m setuptools_scm)"
    - python -m build
  artifacts:
    paths:
      - dist/
  only:
    - tags

release:
  stage: pypi-release
  needs:
    - job: build
      artifacts: true
  script:
    - apk add --no-cache git build-base libffi-dev openssl-dev
    - pip install --upgrade twine
    - echo "Uploading $(python -m setuptools_scm) to PyPI"
    - twine upload dist/*
  only:
    - tags
  allow_failure: false
  when: manual
