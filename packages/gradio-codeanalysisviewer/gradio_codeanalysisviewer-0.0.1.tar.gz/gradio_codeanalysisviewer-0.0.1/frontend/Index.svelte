<svelte:options accessors={true} />

<script lang="ts">
    import type { Gradio } from "@gradio/utils";
    import { BlockTitle } from "@gradio/atoms";
    import { Block } from "@gradio/atoms";
    import { StatusTracker } from "@gradio/statustracker";
    import type { LoadingStatus } from "@gradio/statustracker";
    import { diffChars } from 'diff';
    // For rendering markdown, we'll use svelte's {@html ...} directive.
    // Ensure any HTML passed this way is sanitized if it comes from untrusted sources.
    // In this case, 'feedback' is generated by our backend, so we assume it's safe.

    // Define the expected structure of the 'value' prop based on OutputSchema
    interface OutputSchema {
        code: string;
        issue: string;
        reason: string;
        fixed_code?: string | null;
        feedback: string;
    }

    export let gradio: Gradio<{
        change: OutputSchema; // The component will dispatch the full object on change
        clear_status: LoadingStatus;
    }>;

    export let label = "Code Analysis";
    export let elem_id = "";
    export let elem_classes: string[] = [];
    export let visible = true;
    export let value: OutputSchema | null = null; // This is the main data prop
    export let show_label: boolean = true;
    export let scale: number | null = null;
    export let min_width: number | undefined = undefined;
    export let loading_status: LoadingStatus | undefined = undefined;
    export let interactive: boolean; // Will likely be false for a display component
    export let root: string;

    // Reactive statement to dispatch change when value updates
    $: if (value) {
        gradio.dispatch("change", value);
    }

    // Default empty state or placeholder if value is null
    const default_value: OutputSchema = {
        code: "// No code provided",
        issue: "No issues to display.",
        reason: "N/A",
        fixed_code: null,
        feedback: "No feedback available."
    };

    $: display_value = value || default_value;

    // Reactive declaration for code diff
    let codeDiff = [];
    $: {
        if (display_value && display_value.code && display_value.fixed_code) {
            codeDiff = diffChars(display_value.code, display_value.fixed_code);
        } else {
            codeDiff = [];
        }
    }

</script>

<Block
    {visible}
    {elem_id}
    {elem_classes}
    {scale}
    {min_width}
    allow_overflow={true} 
    padding={true}
>
    {#if loading_status}
        <StatusTracker
            autoscroll={gradio.autoscroll}
            i18n={gradio.i18n}
            {...loading_status}
            on:clear_status={() => gradio.dispatch("clear_status", loading_status)}
        />
    {/if}

    <div class="code-analysis-viewer">
        {#if show_label}
            <BlockTitle {root} {show_label} info={undefined}>{label}</BlockTitle>
        {/if}

        {#if display_value}
            <div class="analysis-section">
                <h4>Original Code:</h4>
                <pre><code>{display_value.code}</code></pre>
            </div>

            <div class="analysis-section">
                <h4>Issue:</h4>
                <p>{display_value.issue}</p>
            </div>

            <div class="analysis-section">
                <h4>Reason:</h4>
                <p>{display_value.reason}</p>
            </div>

            {#if display_value.fixed_code}
                <div class="analysis-section">
                    <h4>Suggested Fix (Diff):</h4>
                    <pre class="diff-view">{#each codeDiff as part}<!--
                        --><span class="diff-part {part.added ? 'added' : (part.removed ? 'removed' : 'common')}">{part.value}</span><!--
                    -->{/each}</pre>
                </div>
            {/if}

            <div class="analysis-section feedback-section">
                <h4>Feedback:</h4>
                <div class="markdown-content">
                    {@html display_value.feedback}
                </div>
            </div>
        {:else}
            <p>No analysis data to display.</p>
        {/if}
    </div>
</Block>

<style>
    .code-analysis-viewer {
        font-family: var(--font-mono, monospace);
        font-size: var(--text-sm, 14px);
        color: var(--body-text-color, #333);
        border: 1px solid var(--border-color-primary, #e0e0e0);
        border-radius: var(--radius-lg, 8px);
        padding: var(--spacing-lg, 16px);
        background-color: var(--background-fill-primary, #f9f9f9);
    }

    .analysis-section {
        margin-bottom: var(--spacing-lg, 16px);
        padding-bottom: var(--spacing-md, 12px);
        border-bottom: 1px solid var(--border-color-secondary, #eee);
    }
    .analysis-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }

    .analysis-section h4 {
        font-weight: var(--font-weight-semibold, 600);
        color: var(--text-color-strong, #222);
        margin-top: 0;
        margin-bottom: var(--spacing-sm, 8px);
        font-size: var(--text-md, 16px);
    }

    pre {
        background-color: var(--background-fill-secondary, #f0f0f0);
        padding: var(--spacing-md, 12px);
        border-radius: var(--radius-md, 6px);
        overflow-x: auto;
        white-space: pre-wrap; 
        word-wrap: break-word; 
    }

    code {
        font-family: var(--font-mono, monospace);
    }

    p {
        line-height: 1.6;
        margin-top: 0;
        margin-bottom: var(--spacing-xs, 4px);
    }
    
    .feedback-section .markdown-content {
        /* Styles for markdown rendered content if needed */
        /* For example, to ensure paragraphs have margins */
    }
    .feedback-section .markdown-content :global(p) {
        margin-bottom: var(--spacing-sm, 8px);
    }
    .feedback-section .markdown-content :global(ul),
    .feedback-section .markdown-content :global(ol) {
        padding-left: var(--spacing-lg, 20px);
        margin-bottom: var(--spacing-sm, 8px);
    }
    .feedback-section .markdown-content :global(li) {
        margin-bottom: var(--spacing-xxs, 4px);
    }
    .feedback-section .markdown-content :global(code) {
        background-color: var(--color-accent-soft, #e6f3ff);
        padding: 2px 4px;
        border-radius: var(--radius-sm, 4px);
        font-size: 0.9em;
    }
    .feedback-section .markdown-content :global(pre) {
         background-color: var(--background-fill-secondary, #f0f0f0);
         padding: var(--spacing-md, 12px);
         border-radius: var(--radius-md, 6px);
         overflow-x: auto;
    }
    .feedback-section .markdown-content :global(pre code) {
        background-color: transparent;
        padding: 0;
        border-radius: 0;
    }

    /* Styles for diff view */
    .diff-view {
        white-space: pre-wrap;
        word-wrap: break-word;
        font-family: var(--font-mono, monospace);
        background-color: var(--background-fill-secondary, #f0f0f0);
        padding: var(--spacing-md, 12px);
        border-radius: var(--radius-md, 6px);
        overflow-x: auto;
    }
    .diff-part.added {
        background-color: var(--color-green-soft, #e6ffed);
        color: var(--color-green-dark, #006400);
    }
    .diff-part.removed {
        background-color: var(--color-red-soft, #ffe6e6);
        color: var(--color-red-dark, #8b0000);
        text-decoration: line-through;
    }
    .diff-part.common {
        /* No special styling for common parts, or subtle if needed */
    }
</style>
