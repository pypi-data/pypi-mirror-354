Metadata-Version: 2.1
Name: svc_user_auth_zxw
Version: 2.0.2
Summary: ç”¨æˆ·æƒé™éªŒè¯å·¥å…·åŒ…
Home-page: https://github.com/sunshineinwater/
Author: æ™¯å‹Ÿ
Author-email: 
Classifier: Programming Language :: Python :: 3.10
Classifier: License :: OSI Approved :: MIT License
Classifier: Operating System :: OS Independent
Description-Content-Type: text/markdown
Requires-Dist: pycryptodome<=3.22.0,>=3.20.0
Requires-Dist: fastapi<0.113,>=0.112.0
Requires-Dist: jose<1.1.0,>=1.0.0
Requires-Dist: aiohttp<3.11.0,>=3.10.5
Requires-Dist: httpx<=0.27.0,>=0.23.3
Requires-Dist: sqlalchemy==2.0.32
Requires-Dist: greenlet==3.0.3
Requires-Dist: databases==0.9.0
Requires-Dist: python-jose==3.3.0
Requires-Dist: passlib==1.7.4
Requires-Dist: asyncpg==0.29.0
Requires-Dist: uvicorn<0.31.0,>=0.30.0
Requires-Dist: python-multipart==0.0.9
Requires-Dist: bcrypt==4.2.0
Requires-Dist: app-tools-zxw>=1.0.71
Requires-Dist: alibabacloud_dysmsapi20170525==3.0.0
Requires-Dist: redis==5.2.0

# svc_user_auth_zxw ç”¨æˆ·è®¤è¯æƒé™ç®¡ç†åº“

## ç®€ä»‹

`svc_user_auth_zxw` æ˜¯ä¸€ä¸ªåŸºäº FastAPI çš„ç”¨æˆ·è®¤è¯å’Œæƒé™ç®¡ç† Python åº“ï¼Œæä¾›å®Œæ•´çš„ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€æƒé™éªŒè¯ç­‰åŠŸèƒ½ã€‚æ”¯æŒå¤šç§ç™»å½•æ–¹å¼ï¼ŒåŒ…æ‹¬è´¦å·å¯†ç ã€å¾®ä¿¡ç™»å½•ã€æ‰‹æœºå·éªŒè¯ç ç™»å½•ç­‰ã€‚

## ğŸ“š ç‰ˆæœ¬å†å²

### éå…¼å®¹æ€§æ›´æ–°ï¼Œä¸ä¹‹å‰çš„ç‰ˆæœ¬ä¸å…¼å®¹
- **2.0.2**
  - é˜¿é‡Œäº‘smså‘é€é…ç½®ä½¿ç”¨configä¸­é…ç½®, ä¸ºNoneæ—¶ä½¿ç”¨é»˜è®¤é…ç½®
- **2.0.1**
    - ä¿®æ­£ä½¿ç”¨æ–‡æ¡£é”™è¯¯
- **2.0.0**
  - é¡¹ç›®ç”± user_auth_zxw æ›´åä¸º svc_svc_user_auth_zxw
  - å°šæœªè¿›è¡Œä»»ä½•æµ‹è¯•,å¯èƒ½å­˜åœ¨é”™è¯¯
### éå…¼å®¹æ€§æ›´æ–°ï¼Œä¸ä¹‹å‰çš„ç‰ˆæœ¬ä¸å…¼å®¹
#### 1.0.0ä»¥ä¸Šç‰ˆæœ¬ï¼Œé€‚é…VUE-ELEMENT-PLUS-ADMINæ¡†æ¶
- **1.0.5**
  - ç”¨æˆ·æ–‡æ¡£é”™è¯¯ä¿®æ­£
- **1.0.4**: æ·»åŠ ç”¨æˆ·æ–‡æ¡£
- **1.0.3**: 
  - bug fix
  - æ–°ç”¨æˆ·æ³¨å†Œåï¼Œto_payload()æŠ¥é”™ä¿®å¤
  - ä¼˜åŒ–: ç”¨æˆ·è§’è‰²å…³è”æ•°æ®åŠ è½½
- **1.0.2**: 
  - ä¼˜åŒ–è´¦å·å¯†ç æ³¨å†Œç™»å½•è¿”å›å€¼ï¼›
  - bug fix - å˜æ›´æ•°æ®è¡¨ç»“æ„ï¼šRoleé‡‡ç”¨è”åˆä¸»é”®ï¼š(app_id, name)
  - ä¸VUE-ELEMENT-PLUS-ADMINæ¡†æ¶ä¿æŒä¸€è‡´ï¼Œå®Œæˆè´¦å·å¯†ç æ³¨å†Œç™»å½•APIå¯¹æ¥
- **1.0.1**: æ–°å¢vue-element-plus-admin api: é€€å‡ºç™»å½•
- **1.0.0**: ç»Ÿä¸€APIè¿”å›å€¼ï¼Œç¬¦åˆvue-element-plus-adminæ¡†æ¶åŸç”Ÿæ ‡å‡†
  - è¿”å›å€¼æ ¼å¼: `{"code": 200, "data": {}}`

### æ—©æœŸç‰ˆæœ¬
- **0.1.1**: æ”¯æŒå¤šçº¿ç¨‹ä»»åŠ¡ï¼Œé›†æˆä¿®æ”¹: çŸ­ä¿¡éªŒè¯ç éªŒè¯ï¼Œrediså­˜å‚¨ä¸éªŒè¯
- **0.1.0**: ä¿®æ”¹: jwtéªŒè¯å¤±è´¥, å¼¹å‡º401 HTTPException_AppToolsSZXWå¼‚å¸¸
- **0.0.9**: è¡¨ç»“æ„Useræ–°å¢å­—æ®µ:referer_id,referer,invitees , æ‰‹æœºå·æ³¨å†Œç™»å½•æ–°å¢ç›¸åº”å­—æ®µ.  å¯¹åº”åŠŸèƒ½: å¢åŠ é‚€è¯·äººä¿¡æ¯
- **0.0.8**: æ–°å¢:æ‰¹é‡åˆ é™¤ç”¨æˆ·è§’è‰²(delete_roles)
- **0.0.7.4**: ä¼˜åŒ–configs.pyå¯¼å…¥
- **0.0.7.3**: ä¸Šä¼ vueå‰ç«¯é¡µé¢
- **0.0.7.2**: å–æ¶ˆget_current_userçš„print(token)
- **0.0.7.1**: æ–°å¢api: /register-or-login-phone/ æ‰‹æœºå·æ³¨å†Œæˆ–ç™»å½•
- **0.0.7**: bug fix : add new role
- **0.0.6.9**: bug fix : æ³¨å†Œç™»å½• import add_new_role
- **0.0.6.8**: æ–°å¢:require_roleså‡½æ•°, æ‰¹é‡éªŒè¯æƒé™
- **0.0.6.7**: æ–°å¢:delete_roleå‡½æ•°, è§£é™¤ç”¨æˆ·æƒé™(åªè§£é™¤å…³è”, ä¸åˆ é™¤roleè¡¨)
- **0.0.6.6**: æ–°å¢:add_new_roleå‡½æ•°, æ–°å¢app name, ç”¨æˆ·æƒé™
- **0.0.6.5**: å»æ‰åœ°å€ä¸­å†—ä½™åœ°å€../api/...ï¼Œtagsä¼˜åŒ–

## ğŸ“‹ ç›®å½•

1. [ç‰¹æ€§](#ç‰¹æ€§)
2. [å®‰è£…](#å®‰è£…)
3. [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
4. [å®Œæ•´APIä½¿ç”¨è¯´æ˜](#å®Œæ•´apiä½¿ç”¨è¯´æ˜)
5. [æƒé™ç®¡ç†](#æƒé™ç®¡ç†)
6. [å‰ç«¯é›†æˆ](#å‰ç«¯é›†æˆ)
7. [é«˜çº§åŠŸèƒ½](#é«˜çº§åŠŸèƒ½)
8. [é”™è¯¯å¤„ç†](#é”™è¯¯å¤„ç†)
9. [éƒ¨ç½²æ³¨æ„äº‹é¡¹](#éƒ¨ç½²æ³¨æ„äº‹é¡¹)

## âœ¨ ç‰¹æ€§

- ğŸ” å¤šç§ç™»å½•æ–¹å¼ï¼šè´¦å·å¯†ç ã€å¾®ä¿¡ã€æ‰‹æœºéªŒè¯ç 
- ğŸ¯ çµæ´»çš„è§’è‰²æƒé™ç®¡ç†ç³»ç»Ÿ
- ğŸ”‘ JWT Token è®¤è¯æœºåˆ¶
- ğŸ“± çŸ­ä¿¡éªŒè¯ç æ”¯æŒ
- ğŸ—„ï¸ Redis ç¼“å­˜æ”¯æŒ
- ğŸ¨ é€‚é… Vue-Element-Plus-Admin æ¡†æ¶
- ğŸš€ å¼‚æ­¥æ•°æ®åº“æ“ä½œï¼ˆPostgreSQLï¼‰
- ğŸ”„ Token åˆ·æ–°æœºåˆ¶

## ğŸš€ å®‰è£…

### 1. é€šè¿‡ pip å®‰è£…

```bash
pip install svc_user_auth_zxw
```


## âš¡ å¿«é€Ÿå¼€å§‹

### 1. é¡¹ç›®é…ç½®

- ï¼ˆæ¨èï¼‰åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `configs/config_user_auth.py` æ–‡ä»¶ï¼š

```python
import os
from datetime import timedelta

# PostgreSQL æ•°æ®åº“é…ç½®
DATABASE_URL = os.environ.get('USER_CENTER_DATABASE_URL')
if not DATABASE_URL:
    DATABASE_URL = "postgresql+asyncpg://username:password@localhost:5432/database_name"
    os.environ['USER_CENTER_DATABASE_URL'] = DATABASE_URL

# Redis æ•°æ®åº“é…ç½®
REDIS_URL_AUTH = os.environ.get('REDIS_URL_AUTH')
if not REDIS_URL_AUTH:
    REDIS_URL_AUTH = "redis://:your_redis_password@localhost:6379/0"
    os.environ['REDIS_URL_AUTH'] = REDIS_URL_AUTH

# JWT é…ç½®
class JWT:
    SECRET_KEY = "your-secret-key-here"
    ALGORITHM = "HS256"
    expire_time = timedelta(seconds=3600)  # 1å°æ—¶

# åº”ç”¨é…ç½®
app_name = "your_app_name"

# å¾®ä¿¡é…ç½®ï¼ˆå¯é€‰ï¼‰
class WeChatPub:
    app_id = "your_wechat_app_id"
    app_secret = "your_wechat_app_secret"
    scope = "snsapi_login"
    state = "your_custom_state"

# é˜¿é‡Œäº‘çŸ­ä¿¡é…ç½®ï¼ˆå¯é€‰ï¼‰
class AliyunSMS:
    ali_access_key_id = "your_access_key_id"
    ali_access_key_secret = "your_access_key_secret"
```

### 2. FastAPI åº”ç”¨é›†æˆ

```python
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from svc_user_auth_zxw import router as user_auth_router

# åˆ›å»º FastAPI åº”ç”¨
app = FastAPI(title="ä½ çš„åº”ç”¨")

# æ·»åŠ  CORS ä¸­é—´ä»¶
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["GET", "POST", "DELETE", "PUT", "OPTIONS"],
    allow_headers=["*"],
)

# æ³¨å†Œç”¨æˆ·è®¤è¯è·¯ç”±
app.include_router(user_auth_router, prefix="/user_center")


if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)
```

### 3. æ•°æ®åº“åˆå§‹åŒ–

åœ¨é¡¹ç›®ä¸»å‡½æ•°å¯¼å…¥from svc_user_auth_zxw import routeræ¨¡å—æ—¶ï¼Œè‡ªåŠ¨è¿›è¡Œæ•°æ®åº“åˆå§‹åŒ–.

## ğŸ“– å®Œæ•´APIä½¿ç”¨è¯´æ˜

> **å‰ç¼€è¯´æ˜**: æ‰€æœ‰APIéƒ½éœ€è¦åŠ ä¸Šå‰ç¼€ `/user_center`ï¼ˆå¦‚æœåœ¨é›†æˆæ—¶è®¾ç½®äº†prefixï¼‰

### ğŸ” è´¦å·å¯†ç è®¤è¯

#### 1. ç”¨æˆ·æ³¨å†Œ
- **URL**: `/api/account/normal/register/`
- **æ–¹æ³•**: `POST`
- **æè¿°**: ä½¿ç”¨è´¦å·å¯†ç æ³¨å†Œæ–°ç”¨æˆ·

```json
// è¯·æ±‚å‚æ•°
{
    "username": "testuser",
    "password": "password123",
    "role_name": "user",      // å¯é€‰ï¼Œé»˜è®¤ "l0"
    "app_name": "your_app"    // å¯é€‰ï¼Œé»˜è®¤ "app0"
}

// å“åº”ç¤ºä¾‹
{
    "code": 200,
    "data": {
        "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
        "refresh_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
        "user_info": {
            "username": "testuser",
            "nickname": "testuser",
            "roles": [...],
            "email": "testuser",
            "phone": "testuser"
        }
    }
}
```

#### 2. ç”¨æˆ·ç™»å½•
- **URL**: `/api/account/normal/login/`
- **æ–¹æ³•**: `POST`
- **æè¿°**: ä½¿ç”¨è´¦å·å¯†ç ç™»å½•

```json
// è¯·æ±‚å‚æ•°
{
    "username": "testuser",
    "password": "password123"
}

// å“åº”ç¤ºä¾‹ï¼ˆåŒæ³¨å†Œæ ¼å¼ï¼‰
{
    "code": 200,
    "data": {
        "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
        "refresh_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
        "user_info": {
            "username": "testuser",
            "nickname": "testuser",
            "roles": [...],
            "email": "testuser",
            "phone": "testuser"
        }
    }
}
```

#### 3. è¡¨å•ç™»å½•
- **URL**: `/api/account/normal/login-form/`
- **æ–¹æ³•**: `POST`
- **æè¿°**: ä½¿ç”¨OAuth2PasswordRequestFormæ ¼å¼ç™»å½•
- **Content-Type**: `application/x-www-form-urlencoded`

```
// è¯·æ±‚å‚æ•°
username=testuser&password=password123&grant_type=password

// å“åº”ç¤ºä¾‹ï¼ˆåŒè´¦å·å¯†ç ç™»å½•æ ¼å¼ï¼‰
{
    "code": 200,
    "data": {
        "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
        "refresh_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
        "user_info": {
            "username": "testuser",
            "nickname": "testuser",
            "roles": [...]
        }
    }
}
```

### ğŸ“± æ‰‹æœºå·è®¤è¯

#### 1. å‘é€éªŒè¯ç 
- **URL**: `/api/account/phone/send-verification-code/`
- **æ–¹æ³•**: `POST`

```json
// è¯·æ±‚å‚æ•°
{
    "phone": "13800138000"
}

// å“åº”ç¤ºä¾‹
{
    "code": 200,
    "data": {
        "message": "éªŒè¯ç å·²å‘é€"
    }
}
```

#### 2. æ‰‹æœºå·æ³¨å†Œ
- **URL**: `/api/account/phone/register-phone/`
- **æ–¹æ³•**: `POST`

```json
// è¯·æ±‚å‚æ•°
{
    "phone": "13800138000",
    "sms_code": "123456",
    "email": "user@example.com",     // å¯é€‰
    "referer_id": 123,               // å¯é€‰ï¼Œé‚€è¯·äººID
    "role_name": "user",             // å¯é€‰ï¼Œé»˜è®¤ "l0"
    "app_name": "your_app"           // å¯é€‰ï¼Œé»˜è®¤ "app0"
}

// å“åº”ç¤ºä¾‹ï¼ˆåŒç™»å½•æ ¼å¼ï¼‰
{
    "code": 200,
    "data": {
        "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
        "refresh_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
        "user_info": {
            "username": "13800138000",
            "nickname": "13800138000",
            "roles": [...],
            "email": "user@example.com",
            "phone": "13800138000"
        }
    }
}
```

#### 3. æ‰‹æœºå·ç™»å½•
- **URL**: `/api/account/phone/login-phone/`
- **æ–¹æ³•**: `POST`

```json
// è¯·æ±‚å‚æ•°
{
    "phone": "13800138000",
    "sms_code": "123456"
}

// å“åº”ç¤ºä¾‹ï¼ˆåŒæ³¨å†Œæ ¼å¼ï¼‰
{
    "code": 200,
    "data": {
        "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
        "refresh_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
        "user_info": {
            "username": "13800138000",
            "nickname": "13800138000",
            "roles": [...],
            "email": "user@example.com",
            "phone": "13800138000"
        }
    }
}
```

#### 4. æ‰‹æœºå·æ³¨å†Œæˆ–ç™»å½•ï¼ˆæ¨èï¼‰
- **URL**: `/api/account/phone/register-or-login-phone/`
- **æ–¹æ³•**: `POST`
- **æè¿°**: è‡ªåŠ¨åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨åˆ™ç™»å½•ï¼Œä¸å­˜åœ¨åˆ™æ³¨å†Œ

```json
// è¯·æ±‚å‚æ•°
{
    "phone": "13800138000",
    "sms_code": "123456",
    "referer_id": 123,        // å¯é€‰ï¼Œé‚€è¯·äººID
    "app_name": "your_app"    // å¯é€‰
}

// å“åº”ç¤ºä¾‹ï¼ˆåŒç™»å½•æ ¼å¼ï¼‰
{
    "code": 200,
    "data": {
        "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
        "refresh_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
        "user_info": {
            "username": "13800138000",
            "nickname": "13800138000",
            "roles": [...],
            "email": null,
            "phone": "13800138000"
        }
    }
}
```

#### 5. æ›´æ¢ç»‘å®šæ‰‹æœºå·
- **URL**: `/api/account/phone/change-phone/`
- **æ–¹æ³•**: `POST`
- **éœ€è¦è®¤è¯**: âœ…

```json
// è¯·æ±‚å‚æ•°
{
    "new_phone": "13900139000",
    "sms_code": "123456"
}

// å“åº”ç¤ºä¾‹ï¼ˆè¿”å›æ›´æ–°åçš„ç”¨æˆ·ä¿¡æ¯ï¼‰
{
    "code": 200,
    "data": {
        "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
        "refresh_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
        "user_info": {
            "username": "testuser",
            "nickname": "testuser",
            "roles": [...],
            "email": "test@example.com",
            "phone": "13900139000"
        }
    }
}
```

### ğŸ”— å¾®ä¿¡ç™»å½•è®¤è¯

#### 1. è·å–ç™»å½•äºŒç»´ç URL
- **URL**: `/api/account/wechat/qr-login/get-qrcode`
- **æ–¹æ³•**: `POST`

```json
// è¯·æ±‚å‚æ•°
{
    "WECHAT_REDIRECT_URI": "https://your-domain.com/callback"
}

// å“åº”ç¤ºä¾‹
{
    "code": 200,
    "data": {
        "qr_code_url": "https://open.weixin.qq.com/connect/qrconnect?..."
    }
}
```

#### 2. å¾®ä¿¡ä¸€é”®ç™»å½•
- **URL**: `/api/account/wechat/qr-login/login/`
- **æ–¹æ³•**: `POST`

```json
// è¯·æ±‚å‚æ•°
{
    "code": "å¾®ä¿¡è¿”å›çš„æˆæƒç ",
    "app_name": "your_app"
}

// å“åº”ç¤ºä¾‹
{
    "code": 200,
    "data": {
        "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
        "refresh_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
        "user_info": {
            "username": "wx_openid",
            "nickname": "WeChatPub User",
            "roles": [...],
            "email": "wx_openid",
            "phone": "wx_openid"
        }
    }
}
```

### ğŸ« JWT Tokenç®¡ç†

#### 1. è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
- **URL**: `/api/token/get-current-user/`
- **æ–¹æ³•**: `POST`
- **éœ€è¦è®¤è¯**: âœ…

```bash
# Headers
Authorization: Bearer your_access_token
```

```json
// å“åº”ç¤ºä¾‹
{
    "code": 200,
    "data": {
        "username": "testuser",
        "nickname": "testuser",
        "email": "test@example.com",
        "phone": "13800138000",
        "roles": [
            {
                "role_name": "admin",
                "app_name": "your_app",
                "app_id": 1
            }
        ]
    }
}
```

#### 2. åˆ·æ–°è®¿é—®ä»¤ç‰Œ
- **URL**: `/api/token/refresh-token/`
- **æ–¹æ³•**: `POST`

```json
// è¯·æ±‚å‚æ•°
{
    "refresh_token": "your_refresh_token"
}

// å“åº”ç¤ºä¾‹
{
    "code": 200,
    "data": {
        "access_token": "new_access_token",
        "refresh_token": "new_refresh_token"
    }
}
```

#### 3. éªŒè¯ä»¤ç‰Œï¼ˆè¯·æ±‚ä½“æ–¹å¼ï¼‰
- **URL**: `/api/token/check-token-from-body/`
- **æ–¹æ³•**: `POST`

```json
// è¯·æ±‚å‚æ•°
{
    "access_token": "your_access_token"
}

// å“åº”ç¤ºä¾‹
{
    "code": 200,
    "data": {
        "username": "testuser",
        "nickname": "testuser",
        "email": "test@example.com",
        "phone": "13800138000",
        "roles": [
            {
                "role_name": "admin",
                "app_name": "your_app",
                "app_id": 1
            }
        ]
    }
}
```

#### 4. éªŒè¯ä»¤ç‰Œï¼ˆè¯·æ±‚å¤´æ–¹å¼ï¼‰
- **URL**: `/api/token/check-token-from-header/`
- **æ–¹æ³•**: `POST`
- **éœ€è¦è®¤è¯**: âœ…

```bash
# Headers
Authorization: Bearer your_access_token
```

```json
// å“åº”ç¤ºä¾‹ï¼ˆåŒè¯·æ±‚ä½“æ–¹å¼ï¼‰
{
    "code": 200,
    "data": {
        "username": "testuser",
        "nickname": "testuser",
        "email": "test@example.com",
        "phone": "13800138000",
        "roles": [
            {
                "role_name": "admin",
                "app_name": "your_app",
                "app_id": 1
            }
        ]
    }
}
```

### ğŸ‘¥ ç”¨æˆ·æƒé™ç®¡ç†API

#### 1. åˆ†é…æˆ–åˆ›å»ºè§’è‰²
- **URL**: `/api/roles/assign-role/`
- **æ–¹æ³•**: `POST`

```json
// è¯·æ±‚å‚æ•°
{
    "user_id": 1,
    "role_name": "admin",
    "app_name": "your_app"
}

// å“åº”ç¤ºä¾‹
{
    "code": 200,
    "data": {
        "status": true,
        "message": "è§’è‰²åˆ†é…æˆåŠŸ"
    }
}
```

#### 2. éªŒè¯ç”¨æˆ·è§’è‰²
- **URL**: `/api/roles/role-auth/`
- **æ–¹æ³•**: `POST`
- **éœ€è¦è®¤è¯**: âœ…

```json
// è¯·æ±‚å‚æ•°
{
    "role_name": "admin",
    "app_name": "your_app"
}

// å“åº”ç¤ºä¾‹
{
    "code": 200,
    "data": {
        "status": true
    }
}
```

#### 3. Adminè§’è‰²éªŒè¯ç¤ºä¾‹
- **URL**: `/api/roles/admin-data/`
- **æ–¹æ³•**: `GET`
- **éœ€è¦è®¤è¯**: âœ…ï¼ˆéœ€è¦adminè§’è‰²ï¼‰

```json
// å“åº”ç¤ºä¾‹
{
    "code": 200,
    "data": "This is admin data"
}
```

### ğŸšª ç”¨æˆ·ç™»å‡º

#### é€€å‡ºç™»å½•
- **URL**: `/api/account/logout`
- **æ–¹æ³•**: `GET`

```json
// å“åº”ç¤ºä¾‹
{
    "code": 200,
    "data": "é€€å‡ºæˆåŠŸ"
}
```

## ğŸ›¡ï¸ æƒé™ç®¡ç†

### 1. åŸºæœ¬æ¦‚å¿µ

- **ç”¨æˆ· (User)**: ç³»ç»Ÿä¸­çš„ä¸ªäººè´¦æˆ·
- **è§’è‰² (Role)**: æƒé™çš„é›†åˆï¼Œå¦‚ adminã€userã€editor ç­‰
- **åº”ç”¨ (App)**: ä¸åŒçš„åº”ç”¨ç³»ç»Ÿï¼Œæ”¯æŒå¤šåº”ç”¨æƒé™éš”ç¦»

### 2. æƒé™éªŒè¯è£…é¥°å™¨

```python
from svc_user_auth_zxw import require_role, require_roles, get_current_user
from fastapi import Depends


# å•ä¸ªè§’è‰²éªŒè¯
@app.get("/admin-only")
async def admin_endpoint(user=Depends(require_role("admin", "your_app"))):
  return {"message": "åªæœ‰adminå¯ä»¥è®¿é—®"}


# å¤šä¸ªè§’è‰²éªŒè¯
@app.get("/multi-roles")
async def multi_roles_endpoint(user=Depends(require_roles(["admin", "moderator"], "your_app"))):
  return {"message": "adminæˆ–moderatorå¯ä»¥è®¿é—®"}


# è·å–å½“å‰ç”¨æˆ·
@app.get("/profile")
async def get_profile(current_user=Depends(get_current_user)):
  return {"user": current_user.username}
```

### 3. è§’è‰²ç®¡ç†ä»£ç ç¤ºä¾‹

#### åˆ é™¤ç”¨æˆ·è§’è‰²ï¼ˆä»£ç è°ƒç”¨ï¼‰

```python
from svc_user_auth_zxw.apis.api_ç”¨æˆ·æƒé™_å¢åŠ  import delete_role, delete_roles

# åˆ é™¤å•ä¸ªè§’è‰²
await delete_role(user_id=1, role_name="admin", db=db_session)

# æ‰¹é‡åˆ é™¤è§’è‰²
await delete_roles(user_id=1, role_names=["admin", "editor"], db=db_session)
```

### 4. é«˜çº§æƒé™ç®¡ç†ç¤ºä¾‹

å‚è€ƒ `useExamples/api_æƒé™ç®¡ç†.py` ä¸­çš„æƒé™ç®¡ç†å®ç°ï¼š

```python
from svc_user_auth_zxw import add_new_role, require_roles, get_current_user
from svc_user_auth_zxw.apis.schemas import è¯·æ±‚_åˆ†é…æˆ–åˆ›å»ºè§’è‰²


# æ–°å¢æƒé™
async def æ–°å¢æƒé™_æ•™æ¡ˆ(user: User, db: AsyncSession, æ–°å¢æ•°é‡: int):
  for i in range(1, æ–°å¢æ•°é‡ + 1):
    await add_new_role(
      è¯·æ±‚_åˆ†é…æˆ–åˆ›å»ºè§’è‰²(
        user_id=user.id,
        role_name=f"gen_content_{i}",
        app_name="your_app"
      ),
      db=db
    )


# ä½¿ç”¨æƒé™
async def ä½¿ç”¨æƒé™_æ•™æ¡ˆ(user: User, db: AsyncSession):
  await require_roles(["gen_content_1"], "your_app")(user, db)
  # æƒé™ä½¿ç”¨åå¯ä»¥é€‰æ‹©æ€§åˆ é™¤
  await delete_roles(user.id, ["gen_content_1"], db)
```

## ğŸ¨ å‰ç«¯é›†æˆ

### 1. Vue-Element-Plus-Admin æ¡†æ¶é›†æˆ

è¯¥åº“å·²é€‚é… Vue-Element-Plus-Admin æ¡†æ¶çš„ API æ ‡å‡†æ ¼å¼ï¼š

```javascript
// API è¿”å›æ ¼å¼
{
    "code": 200,
    "data": {
        // å®é™…æ•°æ®
    }
}
```

### 2. å‰ç«¯ç™»å½•ç¤ºä¾‹

```javascript
// ç™»å½•å‡½æ•°
async function login(username, password) {
    const response = await fetch('/user_center/api/account/normal/login/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ username, password })
    });
    
    const result = await response.json();
    if (result.code === 200) {
        localStorage.setItem('access_token', result.data.access_token);
        localStorage.setItem('refresh_token', result.data.refresh_token);
        return result.data.user_info;
    }
    throw new Error(result.message);
}

// è¯·æ±‚æ‹¦æˆªå™¨
axios.interceptors.request.use(config => {
    const token = localStorage.getItem('access_token');
    if (token) {
        config.headers.Authorization = `Bearer ${token}`;
    }
    return config;
});

// å“åº”æ‹¦æˆªå™¨ï¼ˆè‡ªåŠ¨åˆ·æ–°Tokenï¼‰
axios.interceptors.response.use(
    response => response,
    async error => {
        if (error.response?.status === 401) {
            const refreshToken = localStorage.getItem('refresh_token');
            if (refreshToken) {
                try {
                    const response = await axios.post('/user_center/api/token/refresh-token/', {
                        refresh_token: refreshToken
                    });
                    const { access_token, refresh_token } = response.data.data;
                    localStorage.setItem('access_token', access_token);
                    localStorage.setItem('refresh_token', refresh_token);
                    // é‡è¯•åŸè¯·æ±‚
                    return axios.request(error.config);
                } catch {
                    // åˆ·æ–°å¤±è´¥ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
                    localStorage.clear();
                    window.location.href = '/login';
                }
            }
        }
        return Promise.reject(error);
    }
);
```

## ğŸš€ é«˜çº§åŠŸèƒ½

### 1. çŸ­ä¿¡éªŒè¯ç 

åº“é›†æˆäº†é˜¿é‡Œäº‘çŸ­ä¿¡æœåŠ¡ï¼Œæ”¯æŒéªŒè¯ç å‘é€å’ŒéªŒè¯ï¼š

```python
# å‘é€éªŒè¯ç  API ä¼šè‡ªåŠ¨å¤„ç†
# éªŒè¯æ—¶åœ¨ç™»å½•/æ³¨å†Œæ¥å£ä¼ å…¥ sms_code å‚æ•°
```

### 2. å¾®ä¿¡ç™»å½•

æ”¯æŒå¾®ä¿¡å…¬ä¼—å·æ‰«ç ç™»å½•ï¼š

```python
# è·å–äºŒç»´ç 
# POST /user_center/api/account/wechat/qr-login/get-qrcode

# å¾®ä¿¡ç™»å½•
# POST /user_center/api/account/wechat/qr-login/login/
{
    "code": "å¾®ä¿¡è¿”å›çš„code",
    "app_name": "your_app"
}
```

### 3. é‚€è¯·ç³»ç»Ÿ

æ”¯æŒç”¨æˆ·é‚€è¯·åŠŸèƒ½ï¼Œæ³¨å†Œæ—¶å¯ä»¥æŒ‡å®šé‚€è¯·äººï¼š

```python
{
    "phone": "13800138000",
    "sms_code": "123456",
    "referer_id": 123  # é‚€è¯·äººç”¨æˆ·ID
}
```

## âš ï¸ é”™è¯¯å¤„ç†

åº“ä½¿ç”¨ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼š

```python
from svc_user_auth_zxw.tools.http_exception import HTTPException_VueElementPlusAdmin
from app_tools_zxw.Errors.api_errors import ErrorCode

# è‡ªå®šä¹‰é”™è¯¯å¤„ç†
try:
  # ä¸šåŠ¡é€»è¾‘
  pass
except HTTPException_VueElementPlusAdmin as e:
  # ç»Ÿä¸€é”™è¯¯æ ¼å¼
  return {"code": e.detail["code"], "data": e.detail["data"]}
```

### å®Œæ•´é”™è¯¯ä»£ç è¯´æ˜

#### HTTPçŠ¶æ€ç è¯´æ˜
- `200`: æˆåŠŸ
- `400`: è¯·æ±‚å‚æ•°é”™è¯¯
- `401`: æœªæˆæƒï¼ˆTokenæ— æ•ˆæˆ–è¿‡æœŸï¼‰
- `403`: æƒé™ä¸è¶³
- `404`: èµ„æºæœªæ‰¾åˆ°
- `500`: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯

#### ä¸šåŠ¡é”™è¯¯ä»£ç è¯¦è§£

**ç”¨æˆ·è®¤è¯ç›¸å…³é”™è¯¯ï¼ˆ400çŠ¶æ€ç ï¼‰**
- `ç”¨æˆ·åå·²æ³¨å†Œ`: æ³¨å†Œæ—¶ç”¨æˆ·åå·²å­˜åœ¨
- `æ‰‹æœºå·å·²æ³¨å†Œ`: æ³¨å†Œæ—¶æ‰‹æœºå·å·²å­˜åœ¨  
- `é‚®ç®±å·²æ³¨å†Œ`: æ³¨å†Œæ—¶é‚®ç®±å·²å­˜åœ¨
- `æ— æ•ˆçš„ç”¨æˆ·åæˆ–å¯†ç `: ç™»å½•æ—¶ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯
- `æ— æ•ˆçš„æ‰‹æœºå·æˆ–éªŒè¯ç `: æ‰‹æœºç™»å½•æ—¶æ‰‹æœºå·æˆ–éªŒè¯ç é”™è¯¯
- `ç”¨æˆ·æœªæ‰¾åˆ°`: æ“ä½œçš„ç”¨æˆ·ä¸å­˜åœ¨ï¼ˆ404çŠ¶æ€ç ï¼‰

**Tokenè®¤è¯ç›¸å…³é”™è¯¯ï¼ˆ401çŠ¶æ€ç ï¼‰**
- `tokenéªŒè¯å¤±è´¥`: JWT TokenéªŒè¯å¤±è´¥æˆ–å·²è¿‡æœŸ
- `jwtè§£ç é”™è¯¯`: JWTè§£ç æ—¶å‘ç”Ÿé”™è¯¯
- `Tokenå·²è¿‡æœŸ`: Tokenè¶…è¿‡æœ‰æ•ˆæœŸ

**éªŒè¯ç ç›¸å…³é”™è¯¯**
- `éªŒè¯ç å‘é€å¤±è´¥`: çŸ­ä¿¡éªŒè¯ç å‘é€å¤±è´¥ï¼ˆ500çŠ¶æ€ç ï¼‰
- `éªŒè¯ç éªŒè¯å¤±è´¥`: éªŒè¯ç é”™è¯¯æˆ–å·²è¿‡æœŸï¼ˆ400çŠ¶æ€ç ï¼‰
- `éªŒè¯ç å·²è¿‡æœŸ`: éªŒè¯ç è¶…è¿‡5åˆ†é’Ÿæœ‰æ•ˆæœŸï¼ˆ400çŠ¶æ€ç ï¼‰

**å¾®ä¿¡ç™»å½•ç›¸å…³é”™è¯¯**
- `å¾®ä¿¡ç™»å½•å¤±è´¥`: å¾®ä¿¡æˆæƒç™»å½•å¤±è´¥ï¼ˆ400çŠ¶æ€ç ï¼‰
- `ç”ŸæˆäºŒç»´ç å¤±è´¥`: å¾®ä¿¡äºŒç»´ç ç”Ÿæˆå¤±è´¥ï¼ˆ500çŠ¶æ€ç ï¼‰
- `å¾®ä¿¡æˆæƒç æ— æ•ˆ`: å¾®ä¿¡è¿”å›çš„æˆæƒç æ— æ•ˆï¼ˆ400çŠ¶æ€ç ï¼‰

**æƒé™ç®¡ç†ç›¸å…³é”™è¯¯ï¼ˆ403çŠ¶æ€ç ï¼‰**
- `è§’è‰²æœªæ‰¾åˆ°`: æ“ä½œçš„è§’è‰²ä¸å­˜åœ¨ï¼ˆ404çŠ¶æ€ç ï¼‰
- `è§’è‰²åˆ›å»ºå¤±è´¥`: æ–°å»ºè§’è‰²æ—¶å¤±è´¥ï¼ˆ500çŠ¶æ€ç ï¼‰
- `åº”ç”¨æœªæ‰¾åˆ°`: æ“ä½œçš„åº”ç”¨ä¸å­˜åœ¨ï¼ˆ403/404çŠ¶æ€ç ï¼‰
- `æƒé™ä¸è¶³`: ç”¨æˆ·æ²¡æœ‰æ‰§è¡Œè¯¥æ“ä½œçš„æƒé™ï¼ˆ403çŠ¶æ€ç ï¼‰

**æ•°æ®åº“ç›¸å…³é”™è¯¯ï¼ˆ500çŠ¶æ€ç ï¼‰**
- `æ•°æ®åˆ›å»ºå¤±è´¥`: æ•°æ®åº“åˆ›å»ºè®°å½•å¤±è´¥
- `æ•°æ®åº“è¿æ¥å¤±è´¥`: æ•°æ®åº“è¿æ¥å¼‚å¸¸
- `å”¯ä¸€çº¦æŸè¿å`: è¿åæ•°æ®åº“å”¯ä¸€æ€§çº¦æŸ
- `å¤–é”®çº¦æŸè¿å`: è¿åæ•°æ®åº“å¤–é”®çº¦æŸ

**ä¸šåŠ¡é€»è¾‘é”™è¯¯ï¼ˆ400çŠ¶æ€ç ï¼‰**
- `å•†å“åç§°ä¸èƒ½ä¸ºç©º`: ä¸šåŠ¡é€»è¾‘å‚æ•°éªŒè¯å¤±è´¥
- `å‚æ•°æ ¼å¼é”™è¯¯`: è¯·æ±‚å‚æ•°æ ¼å¼ä¸æ­£ç¡®
- `å¿…å¡«å‚æ•°ç¼ºå¤±`: ç¼ºå°‘å¿…è¦çš„è¯·æ±‚å‚æ•°

**æœåŠ¡å™¨é”™è¯¯ï¼ˆ500çŠ¶æ€ç ï¼‰**
- `å†…éƒ¨æœåŠ¡å™¨é”™è¯¯`: æœåŠ¡å™¨å†…éƒ¨æœªå¤„ç†çš„å¼‚å¸¸
- `ç¬¬ä¸‰æ–¹æœåŠ¡è°ƒç”¨å¤±è´¥`: è°ƒç”¨å¤–éƒ¨æœåŠ¡ï¼ˆå¦‚é˜¿é‡Œäº‘çŸ­ä¿¡ï¼‰å¤±è´¥
- `é…ç½®é”™è¯¯`: æœåŠ¡å™¨é…ç½®ä¸æ­£ç¡®

#### é”™è¯¯å“åº”æ ¼å¼

```json
{
    "code": 400,
    "data": "å…·ä½“é”™è¯¯ä¿¡æ¯æè¿°"
}
```

#### å‰ç«¯é”™è¯¯å¤„ç†ç¤ºä¾‹

```javascript
// Axios å“åº”æ‹¦æˆªå™¨
axios.interceptors.response.use(
    response => {
        // æˆåŠŸå“åº”
        if (response.data.code === 200) {
            return response.data.data;
        }
        // ä¸šåŠ¡é”™è¯¯
        throw new Error(response.data.data);
    },
    error => {
        // HTTPé”™è¯¯
        if (error.response?.status === 401) {
            // Tokenè¿‡æœŸï¼Œè·³è½¬ç™»å½•
            localStorage.clear();
            window.location.href = '/login';
        } else if (error.response?.status === 403) {
            // æƒé™ä¸è¶³
            ElMessage.error('æƒé™ä¸è¶³ï¼Œè¯·è”ç³»ç®¡ç†å‘˜');
        } else if (error.response?.status === 400) {
            // ä¸šåŠ¡é€»è¾‘é”™è¯¯
            ElMessage.error(error.response?.data?.data || 'è¯·æ±‚å‚æ•°é”™è¯¯');
        } else if (error.response?.status === 500) {
            // æœåŠ¡å™¨é”™è¯¯
            ElMessage.error('æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
        } else {
            // å…¶ä»–é”™è¯¯
            ElMessage.error(error.response?.data?.data || 'è¯·æ±‚å¤±è´¥');
        }
        return Promise.reject(error);
    }
);
```

#### UniApp é”™è¯¯å¤„ç†ç¤ºä¾‹

```typescript
const request = (url, method, data = null) => {
    return new Promise((resolve, reject) => {
        uni.request({
            url: `${BASE_URL}${url}`,
            method,
            data,
            header: setHeaderToken(),
            success: (res) => {
                if (res.statusCode >= 200 && res.statusCode < 300) {
                    resolve(res.data)
                } else {
                    const error_detail = res.data["detail"];
                    uni.showToast({
                        title: `è¯·æ±‚å¤±è´¥: ${error_detail.code}, ${error_detail.data}`,
                        icon: 'none',
                        duration: 3000
                    })
                    reject(new Error(`è¯·æ±‚å¤±è´¥: ${error_detail.code}, ${error_detail.data}`))
                }
            },
            fail: (err) => {
                console.error('ç½‘ç»œè¯·æ±‚é”™è¯¯:', err)
                uni.showToast({
                    title: `ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–æœåŠ¡å™¨åœ°å€`,
                    icon: 'none',
                    duration: 3000
                })
                reject(new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–æœåŠ¡å™¨åœ°å€'))
            }
        })
    })
}
```

## ğŸš€ éƒ¨ç½²æ³¨æ„äº‹é¡¹

### 1. ç¯å¢ƒå˜é‡

ç¡®ä¿è®¾ç½®ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š

```bash
export USER_CENTER_DATABASE_URL="postgresql+asyncpg://user:pass@host:port/db"
export REDIS_URL_AUTH="redis://:password@host:port/db"
```

### 2. æ•°æ®åº“è¿ç§»

ä½¿ç”¨ Alembic è¿›è¡Œæ•°æ®åº“è¿ç§»ï¼š

```bash
alembic upgrade head
```

### 3. ç”Ÿäº§ç¯å¢ƒé…ç½®

- ä½¿ç”¨å¼ºå¯†ç å’Œå¤æ‚çš„ JWT Secret Key
- é…ç½®åˆé€‚çš„ Token è¿‡æœŸæ—¶é—´
- è®¾ç½® Redis å¯†ç å’Œè®¿é—®æ§åˆ¶
- é…ç½® HTTPS

### 4. æ³¨æ„äº‹é¡¹

1. **Tokenå®‰å…¨**: è®¿é—®ä»¤ç‰Œåº”å®‰å…¨å­˜å‚¨ï¼Œé¿å…XSSæ”»å‡»
2. **åˆ·æ–°ä»¤ç‰Œ**: åˆ·æ–°ä»¤ç‰Œæœ‰æ•ˆæœŸæ›´é•¿ï¼Œåº”å¦¥å–„ä¿ç®¡
3. **æƒé™éš”ç¦»**: ä¸åŒåº”ç”¨çš„æƒé™ç›¸äº’éš”ç¦»
4. **éªŒè¯ç **: çŸ­ä¿¡éªŒè¯ç æœ‰æ•ˆæœŸä¸º5åˆ†é’Ÿ
5. **å¹¶å‘é™åˆ¶**: å»ºè®®å¯¹å‘é€éªŒè¯ç ç­‰æ•æ„Ÿæ“ä½œè¿›è¡Œé¢‘ç‡é™åˆ¶

## ğŸ“ ç¤ºä¾‹é¡¹ç›®

å®Œæ•´çš„ä½¿ç”¨ç¤ºä¾‹è¯·å‚è€ƒé¡¹ç›®ä¸­çš„ `useExamples` ç›®å½•ï¼š

- `main.py`: FastAPI åº”ç”¨é›†æˆç¤ºä¾‹
- `api_æƒé™ç®¡ç†.py`: é«˜çº§æƒé™ç®¡ç†ç¤ºä¾‹

## ğŸ‘¨â€ğŸ’» æŠ€æœ¯æ”¯æŒ

- **ä½œè€…**: å¼ è–›ä¼Ÿ (Zhang Xuewei)
- **é‚®ç®±**: shuiheyangguang@gmail.com
- **GitHub**: https://github.com/sunshineinwater/

## ğŸ“„ è®¸å¯è¯

MIT License
