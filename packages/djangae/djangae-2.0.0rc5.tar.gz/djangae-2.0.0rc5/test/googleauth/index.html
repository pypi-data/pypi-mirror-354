<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://potato-oss.gitlab.io/djangae/djangae/googleauth/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Googleauth - Djangae Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Googleauth";
        var mkdocs_page_input_path = "googleauth.md";
        var mkdocs_page_url = "/djangae/djangae/googleauth/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Djangae Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../installation/">Installation & Deployment</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../sandbox/">Local/remote management commands</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../environment/">Environment</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../utils/">Utils</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../storage/">Storage backends</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../deferred/">Background Processing</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Contrib apps</span></p>
              <ul class="current">
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Googleauth</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#installation-and-configuration">Installation and Configuration</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#custom-user-model">Custom User model</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#custom-permissions">Custom Permissions</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#oauth-20-configuration">OAuth 2.0 Configuration</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#linking-oauth-django-session-expiry">Linking OAuth &amp; Django Session Expiry</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#handling-app-engine-versioning">Handling App Engine Versioning</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#handling-clock-skew-times">Handling clock skew times</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#iap-configuration">IAP configuration</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#testing-authentication-locally">Testing Authentication Locally</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../contrib_search/">Search</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../pagination/">Pagination</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../backup/">Scheduled backups</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../security/">Security</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../locking/">Thread locking</a>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../cloud_run/">Cloud Run</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../contributing/">Contributing & Testing</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../commercial_support/">Commercial Support</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../work_with_potato/">Work with us!</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Djangae Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Contrib apps</li>
      <li class="breadcrumb-item active">Googleauth</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://gitlab.com/potato-oss/djangae/djangae/edit/master/docs/googleauth.md" class="icon icon-gitlab"> Edit on GitLab</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="googleauth-djangaecontribgoogleauth">Googleauth (djangae.contrib.googleauth)</h1>
<p>Djangae comes with a built-in Django application for handling Google Cloud authentication for you. <code>djangae.contrib.googleauth</code>
provides Django authentication backends and utilities for handling authentication and authorization using Google Internet Aware Proxy
(IAP), and also through Google's OAuth2 service.</p>
<p>googleauth gives an authentication system very similar to the built-in contrib.auth that comes with Django. The differences
are as follows:</p>
<ul>
<li>Provides backends for Google Cloud authentication systems</li>
<li>Built for the Google Cloud Datastore rather than SQL</li>
<li>Permissions are not stored in the database, but are instead generated from apps + models. This avoids M2M relationships
   that wouldn't work well on the Datastore, but sacrifices the ability to create Permissions dynamically.</li>
<li>The exception is object-specific permissions, which are handled via the UserPermission object</li>
</ul>
<h2 id="installation-and-configuration">Installation and Configuration</h2>
<p>The googleauth app ships with two different authentication backends:</p>
<ol>
<li>An IAP backend which uses Google's Internet Aware Proxy to login users who have hit a service that's restricted by IAP</li>
<li>An OAuth2 backend which uses Google's oauth implementation</li>
</ol>
<p>You can use these backends individually, or in combination. If you use the backends in combination then IAP would be responsible
for authentication (unless you're on a non-IAP protected service), and then OAuth can be used for authorization with additional scopes.</p>
<p>As an example, if you hit an IAP protected view, with <code>@login_required</code> for example, then the user will be authenticated using IAP.</p>
<p>However, when you make use of the <code>@oauth_scopes_required(scopes, offline=False)</code> decorator, then an oauth flow will be triggered. Whether the view
is IAP protected, or not, this will result in the user authenticating and authorizing with OAuth. This will only happen if the user hasn't
already granted the required scopes.</p>
<p>The first place to configure then is your <code>AUTHENTICATION_BACKENDS</code> setting:</p>
<pre><code class="language-python">AUTHENTICATION_BACKENDS = (
    &quot;djangae.contrib.googleauth.backends.iap.IAPBackend&quot;,
    &quot;djangae.contrib.googleauth.backends.oauth2.OAuthBackend&quot;,
)
</code></pre>
<p>And then you must add <code>djangae.contrib.googleauth</code> to your <code>INSTALLED_APPS</code> setting, and add the authentication middleware. e.g.</p>
<pre><code class="language-python">MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'djangae.contrib.googleauth.middleware.AuthenticationMiddleware', # &lt;--
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]
</code></pre>
<p>You must also have <code>django.contrib.contenttypes</code>, and <code>django.contrib.auth</code> in your <code>INSTALLED_APPS</code> for everything to function correctly.</p>
<p>Finally, you must include the <code>googleauth</code> urls in your urlpatterns:</p>
<pre><code class="language-python">urlpatterns = [
    ...
    path('googleauth/', include('djangae.contrib.googleauth.urls')),
]
</code></pre>
<h3 id="custom-user-model">Custom User model</h3>
<p>Like Django's auth app, googleauth ships a concrete <code>User</code> model which you an use directly. However, if you want to customise this, you should
instead inherit from <code>AbstractGoogleUser</code>. This includes all the fields necessary for the googleauth authentication backends, but is an abstract
model and so avoids multi-table inheritance.</p>
<h3 id="custom-permissions">Custom Permissions</h3>
<p>By default the generated permissions are the standard add, change, delete, and view permissions that Django's auth system
defines. However you can add additional permissions to this on a per-app-model basis or globally by using the <code>GOOGLEAUTH_CUSTOM_PERMISSIONS</code>
setting in your settings.py</p>
<pre><code class="language-python">GOOGLEAUTH_CUSTOM_PERMISSIONS = {
    '__all__': ['archive'],
    'events.Event': ['invite']
}
</code></pre>
<h3 id="oauth-20-configuration">OAuth 2.0 Configuration</h3>
<p>IAP requires little configuration, but OAuth 2.0 unfortunately requires a bit more. To start with you have the <code>GOOGLEAUTH_OAUTH_SCOPES</code> setting. This
is the list of default scopes that your application asks for when the user is required to login. The default setting is:</p>
<pre><code class="language-python">GOOGLEAUTH_OAUTH_SCOPES = [
    &quot;openid&quot;,
    &quot;profile&quot;,
    &quot;email&quot;
]
</code></pre>
<p>But you can replace this list to request more account access.</p>
<p>Next you must configure your client ID and client secret:</p>
<pre><code class="language-python">GOOGLEAUTH_CLIENT_ID = &quot;...&quot;
GOOGLEAUTH_CLIENT_SECRET = &quot;...&quot;
</code></pre>
<p>You must generate these values in the Google Cloud Console.</p>
<p>When you configure OAuth Consent Screen and Credentials on Google Cloud Platform you are
required to configure a list of Authorised domains and OAuth redirects.</p>
<h3 id="linking-oauth-django-session-expiry">Linking OAuth &amp; Django Session Expiry</h3>
<p>By default, an oauth session expiring doesn't force log-out the user from their Django session. If however you want to <em>require</em> that a Django session
expires when the oauth session expires, you can do so by setting the <code>GOOGLEAUTH_LINK_OAUTH_SESSION_EXPIRY</code> setting to <code>True</code>. This will redirect the user back through the oauth flow (although normally transparently).</p>
<h3 id="handling-app-engine-versioning">Handling App Engine Versioning</h3>
<p>While working on multiple AppEngine versions it's quite inconvenient to have to update those lists for every new version you deploy.
In order to workaround the problem we've added the <code>GOOGLEAUTH_OAUTH_REDIRECT_HOST</code> setting.
If provided, the user will automatically be redirected to the configured base url during the OAuth2 flow (independently from which application version the flow is triggered from).
The <code>oauth2callback</code> will automatically redirect the user back to the right application version that triggered the flow.</p>
<p>ie.</p>
<pre><code class="language-python">GOOGLEAUTH_OAUTH_REDIRECT_HOST = &quot;app.appspot.com&quot;
</code></pre>
<p>Finally, you'll probably want to set your <code>LOGIN_URL</code> setting to the oauth_login view which will trigger the oauth
authentication if necessary:</p>
<pre><code class="language-python">LOGIN_URL = reverse_lazy('oauth_login')
</code></pre>
<h3 id="handling-clock-skew-times">Handling clock skew times</h3>
<p>By default, Djangae allows for a 10 seconds skew between your server and google's
auth server when verifying token are not issued in the future.</p>
<p>You can change this via the <code>GOOGLEAUTH_CLOCK_SKEWS_SECONDS</code> setting</p>
<h3 id="iap-configuration">IAP configuration</h3>
<p>IAP uses JSON Web Tokens (JWT) to make sure that a request to your app is authorized. This protects your app from the following kind of risks:</p>
<ul>
<li>IAP is accidentally disabled;</li>
<li>Misconfigured firewalls;</li>
<li>Access from within the project.</li>
<li>Attackers bypasses IAP unsigned identity headers.</li>
</ul>
<p>One of the constraints of the validation is the audience should match the <code>Signed Header JWT Audience</code> of your project.</p>
<p>To get audience string values from the Cloud Console, go to the <a href="https://console.cloud.google.com/security/iap/?_ga=2.175450922.908770789.1613644087-688439372.1485967413">Identity-Aware Proxy settings</a> for your project, click <strong>More</strong> next to the Load Balancer resource, and then select <strong>Signed Header JWT Audience</strong>. The Signed Header JWT dialog that appears displays the aud claim for the selected resource.</p>
<p>In order to use IAP backend you need to set <code>GOOGLEAUTH_IAP_JWT_AUDIENCE</code> in your settings using this string.</p>
<p>Please refer to this <a href="https://cloud.google.com/iap/docs/signed-headers-howto#verifying_the_jwt_header">page</a> for more context.</p>
<p>The JWT audience is used to check that the IAP headers haven't been tampered with. If you are testing
locally then you can disable the JWT checking by setting the <code>GOOGLEAUTH_IAP_JWT_ENABLED</code> setting
to <code>False</code>. It is highly recommended to keep this setting to <code>True</code> on production!</p>
<h2 id="testing-authentication-locally">Testing Authentication Locally</h2>
<p>googleauth ships with a middleware class that simulates IAP authentication.</p>
<p>Adding <code>djangae.contrib.googleauth.middleware.LocalIAPLoginMiddleware</code> to your <code>MIDDLEWARE</code> setting will give the following
features:</p>
<ul>
<li>Visiting <code>/_dj/login/</code> will give you a login view to set which account to simulate. IAP credentials will then reflect this login</li>
<li>Visiting <code>/_dj/logout/</code> will remove the IAP credentials</li>
</ul>
<p>The middleware will not run if djangae.environment reports that the site is on production. It is highly recommended that you
don't include this middleware in live production settings.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../deferred/" class="btn btn-neutral float-left" title="Background Processing"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../contrib_search/" class="btn btn-neutral float-right" title="Search">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://gitlab.com/potato-oss/djangae/djangae" class="icon icon-gitlab" style="color: #fcfcfc"> GitLab</a>
        </span>
    
    
      <span><a href="../deferred/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../contrib_search/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
