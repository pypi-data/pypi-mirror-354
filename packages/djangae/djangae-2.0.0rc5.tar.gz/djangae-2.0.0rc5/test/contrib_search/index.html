<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://potato-oss.gitlab.io/djangae/djangae/contrib_search/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Search - Djangae Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Search";
        var mkdocs_page_input_path = "contrib_search.md";
        var mkdocs_page_url = "/djangae/djangae/contrib_search/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Djangae Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../installation/">Installation & Deployment</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../sandbox/">Local/remote management commands</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../environment/">Environment</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../utils/">Utils</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../storage/">Storage backends</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../deferred/">Background Processing</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Contrib apps</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../googleauth/">Googleauth</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Search</a>
    <ul class="current">
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../pagination/">Pagination</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../backup/">Scheduled backups</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../security/">Security</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../locking/">Thread locking</a>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../cloud_run/">Cloud Run</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../contributing/">Contributing & Testing</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../commercial_support/">Commercial Support</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../work_with_potato/">Work with us!</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Djangae Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Contrib apps</li>
      <li class="breadcrumb-item active">Search</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://gitlab.com/potato-oss/djangae/djangae/edit/master/docs/contrib_search.md" class="icon icon-gitlab"> Edit on GitLab</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="djangaecontribsearch">djangae.contrib.search</h1>
<p>This is a minimal search engine built on the Google Cloud Datastore
that in part mimics the old Google App Engine Search API.</p>
<p>It exists for two reasons:</p>
<ol>
<li>An upgrade path from the GAE Search API.</li>
<li>To aid smaller projects that don't need to run their own ElasticSearch instance.</li>
</ol>
<h1 id="query-format">Query Format</h1>
<p>The original App Engine Search query format was pretty tricky to parse, and not often used
extensively. The query format used in djangae.contrib.search is much simpler.</p>
<h2 id="or-operator">OR operator</h2>
<p>You can create a multiple branch search with the OR operator. ORs are not nested, you can simply
use:</p>
<pre><code>marathon OR race OR run
</code></pre>
<p>The OR can be lower case, as 'or' is a common token that is not indexed</p>
<h2 id="exact-match">Exact match</h2>
<p>You can combine tokens together to return documents that have an exact match by using quotes. e.g.</p>
<pre><code>&quot;tallest building&quot;
</code></pre>
<p>This can in turn be used with the OR operator:</p>
<pre><code>&quot;tallest building&quot; OR tower
</code></pre>
<h2 id="field-match">Field match</h2>
<p>Finally, you can use the <code>:</code> operator to specify a Document field to search:</p>
<pre><code>name:james
</code></pre>
<p>To combine with the OR operator you'll need to duplicate the <code>:</code> operator:</p>
<pre><code>name:james OR name:jim OR last_name:kirk
</code></pre>
<p>You can also combine with exact matching:</p>
<pre><code>name:&quot;james kirk&quot; OR name:spock
</code></pre>
<h1 id="documents-and-indexes">Documents and Indexes</h1>
<p>Contrib search is built around the concept of Indexes and Documents. To make your data searchable,
you must define a Document subclass that defines the structure in search fields:</p>
<pre><code class="language-python">class MyDocument(search.Document):
    name = search.TextField()
    age = search.NumberField()
</code></pre>
<p>You can then add the document to an index. Indexes are created automatically in the database when you instantiate
them if they don't already exist:</p>
<pre><code class="language-python">index = Index(name=&quot;my_index&quot;)
index.add(MyDocument(name=&quot;Lister&quot;, age=3000030))
index.add(MyDocument(name=&quot;Cat&quot;, age=40))
</code></pre>
<p>Finally, you can search for documents using <code>index.search</code>:</p>
<pre><code class="language-python">results = index.search(&quot;lister&quot;, MyDocument)
</code></pre>
<p>The second parameter to <code>search</code> is the Document subclass that results
are returned as.</p>
<h1 id="field-types">Field Types</h1>
<p>The App Engine Search API had an array of field types. Currently djangae.contrib.search only
supports the following:</p>
<ul>
<li>TextField - A blob of text up to 1024 ** 2 chars in length</li>
<li>DateField - A field for storing a Python datetime or date field.</li>
<li>NumberField - A field for storing an integer</li>
</ul>
<p>Fields under construction (do not use!):</p>
<ul>
<li>AtomField - A field</li>
<li>FuzzyTextField - A field that supports stemmed matching</li>
</ul>
<h1 id="django-model-integration">Django Model Integration</h1>
<p>It's a very common need to be able to index and search Django model instances. contrib.search
provides a mechanism for this that is similar to the Django admin registration.</p>
<p>First, in your Django app, create a file called <code>search.py</code>. Inside <code>search.py</code> you define a subclass
of <code>ModelDocument</code> (which is simular to Django's <code>ModelAdmin</code>), and use that to register your model
as searchable:</p>
<pre><code class="language-python">from djangae.contrib import search
from .models import MyModel

class MyModelDocument(search.ModelDocument):
    class Meta:
        fields = (&quot;name&quot;, &quot;age&quot;)


search.register(MyModel, MyModelDocument)
</code></pre>
<p>This has the following effect:</p>
<ul>
<li>Saving an instance of MyModel will automatically index the name and age fields</li>
<li>The managers on MyModel (e.g. MyModel.objects) will gain a <code>search(...)</code> method</li>
</ul>
<p>This means you can search for models in the same way you'd use Django filters:</p>
<pre><code class="language-python">instances = MyModel.objects.filter(age=10).search(&quot;cat&quot;)
</code></pre>
<p>There's no need to specify the Document subclass when searching for models.</p>
<h1 id="stopwords-and-ranking">Stopwords and Ranking</h1>
<p>By default stop words (i.e common tokens) are both indexed, and searched. The default ranking
algorithm treats stop-word matching as weaker than other words.</p>
<p>If you don't want to match stop words, pass <code>match_stopwords=False</code> to the search() method.</p>
<h2 id="queryset-search-ranking">Queryset Search Ranking</h2>
<p>If you're using <code>ModelDocument</code> the Django queryset <code>.search()</code> method, then ranking order <strong>will not apply</strong> by default. Instead results
will be ordered by whatever the Django queryset is ordered by. You have two options if you want ranking to apply to your
queryset.</p>
<ol>
<li>Pass an empty list to search using the <code>ordered_ids</code> kwarg. This will be populated with the primary keys of the result set
    ordered by the default search ranking. You can then use this to reorder you final results.</li>
<li>Use <code>.search_and_rank()</code> instead. This however will not return a queryset, and will instead evaluate the queryset and return
    an ordered list.</li>
</ol>
<h1 id="caveats-issues">Caveats / Issues</h1>
<h2 id="handling-common-tokens">Handling common tokens</h2>
<p>Searching for a very common token (e.g. punctuation like a '.') will likely return
a <em>lot</em> of results. Currently this token query will be artificially limited to 1000
results. This may cause the resulting document set to be missing relevant documents.
Further work is needed to improve the querying to resolve this issue, potential solutions are:</p>
<ol>
<li>Stripping punctuation from queries if there are other non-punctuation tokens</li>
<li>Performing a second in-memory pass to include/exclude documents returned by other token matches</li>
</ol>
<h2 id="pagination">Pagination</h2>
<p>There is currently no way to paginate results. Patches welcome :)</p>
<h2 id="legacy-datastore">Legacy Datastore</h2>
<p>Search doesn't fully support  the legacy Datastore or Firestore in Datastore mode using "Optimistic With Entity Groups" concurrency model.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../googleauth/" class="btn btn-neutral float-left" title="Googleauth"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../pagination/" class="btn btn-neutral float-right" title="Pagination">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://gitlab.com/potato-oss/djangae/djangae" class="icon icon-gitlab" style="color: #fcfcfc"> GitLab</a>
        </span>
    
    
      <span><a href="../googleauth/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../pagination/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
