"""Marimo deployment template for Modal.

This template provides Gradio deployment with Marimo notebook integration.
"""

TEMPLATE = '''# üöÄ Modal Deployment Script (Marimo Configuration)
# Generated by modal-for-noobs - https://github.com/arthrod/modal-for-noobs
# Deployment Mode: marimo
# Features: Gradio app with Marimo notebooks, ML libraries, dashboard, and logging
# Timeout: {timeout_seconds}s | Scaledown: {scaledown_window}s

import modal
import sys
import os
import subprocess
import asyncio
from pathlib import Path
from datetime import datetime
from fastapi import FastAPI
from fastapi.responses import RedirectResponse
import gradio as gr
from gradio.routes import mount_gradio_app
from loguru import logger

# Import dashboard components
sys.path.append(str(Path(__file__).parent))
from dashboard import create_dashboard_interface, create_dashboard_api, dashboard_state, DeploymentInfo

# üéØ Create Modal App
app = modal.App("{app_name}")

# üê≥ Container Image Configuration (Marimo + ML)
{image_config}

# üì¶ Original Application Code
{original_code}

async def start_marimo_server():
    """Start Marimo server in the background."""
    # Create workspace directory
    workspace_dir = Path("/workspace")
    workspace_dir.mkdir(exist_ok=True)
    
    # Create a sample Marimo notebook
    sample_notebook = workspace_dir / "welcome.py"
    if not sample_notebook.exists():
        notebook_content = '''import marimo

__generated_with = "0.1.0"
app = marimo.App()

@app.cell
def __():
    import marimo as mo
    return mo,

@app.cell
def __(mo):
    mo.md(r"""
    # Welcome to Modal Marimo! üéâ
    
    This Marimo notebook is running alongside your Gradio app on Modal.
    
    Marimo provides:
    - **Reactive notebooks** - cells automatically re-run when dependencies change
    - **Pure Python** - notebooks are just Python files
    - **Interactive widgets** - build UIs with Python
    - **GPU acceleration** - full ML/AI support
    
    Your Gradio app is available at the [root URL](/).
    """)
    return

@app.cell
def __():
    import sys
    import torch
    import pandas as pd
    import numpy as np
    
    print(f"Python {sys.version}")
    print(f"PyTorch {torch.__version__}")
    print(f"CUDA available: {torch.cuda.is_available()}")
    
    if torch.cuda.is_available():
        print(f"GPU: {torch.cuda.get_device_name(0)}")
    return np, pd, sys, torch

@app.cell
def __(mo):
    mo.md("## Interactive Example")
    slider = mo.ui.slider(1, 10, value=5, label="Select a value")
    return slider,

@app.cell
def __(mo, slider):
    mo.md(f"You selected: **{slider.value}**")
    
    # Create a simple plot
    import matplotlib.pyplot as plt
    
    fig, ax = plt.subplots()
    ax.bar(range(slider.value), range(slider.value))
    ax.set_title(f"Bar chart with {slider.value} bars")
    plt.tight_layout()
    return ax, fig, plt

if __name__ == "__main__":
    app.run()
'''
        sample_notebook.write_text(notebook_content)
    
    # Start Marimo server
    logger.info("Starting Marimo server on port 2718")
    process = await asyncio.create_subprocess_exec(
        "marimo", "run",
        "--host", "0.0.0.0",
        "--port", "2718",
        "--no-browser",
        str(workspace_dir),
        stdout=asyncio.subprocess.PIPE,
        stderr=asyncio.subprocess.PIPE
    )
    
    # Give it time to start
    await asyncio.sleep(3)
    logger.info("Marimo server started")
    
    return process

# ‚ö° Modal Function Configuration with GPU
@app.function(
    image=image,
    gpu="any",  # GPU support for ML workloads
    min_containers=1,
    max_containers=1,
    timeout={timeout_seconds},
    scaledown_window={scaledown_window},
    memory=16384,  # 16GB RAM
)
@modal.concurrent(max_inputs=100)
@modal.asgi_app()
def deploy_gradio():
    """Deploy Gradio app with Marimo notebooks and dashboard on Modal."""
    
    # Check GPU availability
    import torch
    gpu_available = torch.cuda.is_available()
    gpu_name = torch.cuda.get_device_name(0) if gpu_available else "None"
    
    # Initialize deployment info
    deployment_info = DeploymentInfo(
        app_name="{app_name}",
        deployment_mode="marimo",
        deployment_time=datetime.now().isoformat(),
        modal_version=modal.__version__,
        python_version=f"{sys.version_info.major}.{sys.version_info.minor}.{sys.version_info.micro}",
        gpu_enabled=gpu_available,
        timeout_seconds={timeout_seconds},
        max_containers=1,
        environment={{
            **{{k: v for k, v in os.environ.items() if k.startswith("MODAL_")}},
            "GPU_AVAILABLE": str(gpu_available),
            "GPU_NAME": gpu_name,
            "MARIMO_ENABLED": "true",
            "MARIMO_PORT": "2718",
        }}
    )
    dashboard_state.set_deployment_info(deployment_info)
    
    logger.info(f"Starting Modal deployment in marimo mode (GPU: {gpu_available})")
    
    # Start Marimo in the background
    asyncio.create_task(start_marimo_server())
    
    # üîç Detect Gradio Interface
    demo = None
    interface_names = ['demo', 'app', 'interface', 'iface']
    
    for name in interface_names:
        if name in globals() and hasattr(globals()[name], 'launch'):
            demo = globals()[name]
            logger.info(f"Found Gradio interface: {name}")
            break
    
    if demo is None:
        for var_name, var_value in globals().items():
            if hasattr(var_value, 'queue') and hasattr(var_value, 'launch'):
                demo = var_value
                logger.info(f"Found Gradio interface through scanning: {var_name}")
                break
    
    if demo is None:
        logger.error("No Gradio interface found")
        raise ValueError("Could not find Gradio interface")
    
    # üé® Create Dashboard with Marimo integration
    with gr.Blocks() as enhanced_dashboard:
        gr.Markdown("# üöÄ Modal Deployment Dashboard")
        gr.Markdown("Monitor and manage your Modal deployment with Marimo notebook integration")
        
        with gr.Tabs():
            # Marimo Tab (first for easy access)
            with gr.Tab("üìì Marimo Notebooks"):
                gr.Markdown("### Interactive Marimo Notebook Environment")
                gr.Markdown("Access Marimo for reactive Python notebooks with GPU support.")
                
                with gr.Row():
                    gr.Markdown("**Marimo is running on port 2718**")
                    marimo_btn = gr.Button("üöÄ Open Marimo", variant="primary", scale=2)
                
                gr.Markdown("""
                #### Why Marimo?
                - **Reactive notebooks** - Cells automatically update when dependencies change
                - **Pure Python files** - Version control friendly, no JSON
                - **Built-in UI components** - Create interactive apps with Python
                - **GPU acceleration** - Full PyTorch and ML support
                
                #### Features:
                - Pre-installed ML/AI packages
                - GPU support enabled
                - Interactive widgets and visualizations
                - Persistent workspace at `/workspace`
                
                #### Usage:
                1. Click the button above to open Marimo in a new tab
                2. Create reactive notebooks with `.py` extension
                3. Build interactive ML experiments
                """)
                
                # JavaScript to open Marimo in new tab
                marimo_btn.click(
                    None,
                    None,
                    None,
                    js="window.open('/marimo', '_blank')"
                )
            
            # Original dashboard tabs
            dashboard_interface = create_dashboard_interface(demo)
            for tab in dashboard_interface.children:
                if hasattr(tab, 'children'):
                    for child in tab.children:
                        child.render()
        
        gr.Markdown("---")
        gr.Markdown("üöÄ Powered by [Modal](https://modal.com) | üìì [Marimo](/marimo) | Generated by [modal-for-noobs](https://github.com/arthrod/modal-for-noobs)")
    
    enhanced_dashboard.queue(max_size=20)
    
    # üîó FastAPI Setup with Marimo proxy
    fastapi_app = FastAPI(
        title="{app_name} - Modal Dashboard (Marimo)",
        description="Optimized deployment with Marimo notebooks and monitoring",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc"
    )
    
    # Add Marimo proxy endpoint
    @fastapi_app.get("/marimo")
    @fastapi_app.get("/marimo/{{path:path}}")
    async def marimo_proxy(path: str = ""):
        """Proxy requests to Marimo."""
        # Redirect to Marimo
        marimo_url = f"http://localhost:2718/{path}"
        return RedirectResponse(url=marimo_url)
    
    # Add dashboard API endpoints
    fastapi_app = create_dashboard_api(fastapi_app)
    
    logger.info("Dashboard with Marimo integration configured successfully")
    
    # Mount Gradio app
    return mount_gradio_app(fastapi_app, enhanced_dashboard, path="/")

# Import dashboard module
dashboard_content = """\"\"\"Dashboard module - embedded for deployment.\"\"\"
{dashboard_module}
"""

# Write dashboard module
dashboard_path = Path(__file__).parent / "dashboard.py"
if not dashboard_path.exists():
    dashboard_path.write_text(dashboard_content)

if __name__ == "__main__":
    app.run()
'''