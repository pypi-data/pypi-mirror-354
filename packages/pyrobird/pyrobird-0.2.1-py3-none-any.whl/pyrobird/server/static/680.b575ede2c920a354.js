"use strict";(self.webpackChunkfirebird=self.webpackChunkfirebird||[]).push([[680],{680:(O,B,u)=>{u.r(B),u.d(B,{TASImagePainter:()=>D});var b=u(467),h=u(6998),v=u(6823),R=u(6370),A=u(9041),p=u(675),E=u(4485),w=u(9025);class D extends p.JW{decodeOptions(a){const t=new A.nC(a);this.options={Zscale:!1};const e=this.getObject();t.check("CONST")&&(this.options.constRatio=!0,e&&(e.fConstRatio=!0)),t.check("Z")&&(this.options.Zscale=!0)}createRGBA(a){const t=this.getObject(),e=t?.fPalette;if(!e)return null;const n=new Array(4*(a+1)).fill(0);for(let i=0,o=1;i<=a;++i){const l=i/a;for(;e.fPoints[o]<l&&o<e.fPoints.length-1;)o++;const s=(e.fPoints[o]-l)/(e.fPoints[o]-e.fPoints[o-1]),r=(l-e.fPoints[o-1])/(e.fPoints[o]-e.fPoints[o-1]);n[4*i]=Math.min(255,Math.round((e.fColorRed[o-1]*s+e.fColorRed[o]*r)/256)),n[4*i+1]=Math.min(255,Math.round((e.fColorGreen[o-1]*s+e.fColorGreen[o]*r)/256)),n[4*i+2]=Math.min(255,Math.round((e.fColorBlue[o-1]*s+e.fColorBlue[o]*r)/256)),n[4*i+3]=Math.min(255,Math.round((e.fColorAlpha[o-1]*s+e.fColorAlpha[o]*r)/256))}return n}makeUrlFromImageBuf(a,t){var e=this;return(0,b.A)(function*(){e.rgba=e.createRGBA(1e3);let i=a.fImgBuf[0],o=a.fImgBuf[0];for(let r=1;r<a.fImgBuf.length;++r){const f=a.fImgBuf[r];i=Math.min(f,i),o=Math.max(f,o)}e.fContour={arr:new Array(200),rgba:e.rgba,getLevels(){return this.arr},getPaletteColor(r,f){if(!this.arr||!this.rgba)return"white";const c=4*Math.round((f-this.arr[0])/(this.arr.at(-1)-this.arr.at(0))*(this.rgba.length-4)/4);return(0,v.VR)(this.rgba[c]/255,this.rgba[c+1]/255,this.rgba[c+2]/255,this.rgba[c+3]/255)}};for(let r=0;r<200;r++)e.fContour.arr[r]=i+(o-i)/199*r;i>=o&&(o=i+1);const l=e.getImageZoomRange(t,a.fConstRatio,a.fWidth,a.fHeight);return((0,h.isNodeJs)()?u.e(1965).then(u.t.bind(u,1965,19)).then(r=>r.default.createCanvas(l.xmax-l.xmin,l.ymax-l.ymin)):new Promise(r=>{const f=document.createElement("canvas");f.width=l.xmax-l.xmin,f.height=l.ymax-l.ymin,r(f)})).then(r=>{const f=r.getContext("2d"),c=f.getImageData(0,0,r.width,r.height),g=c.data;for(let m=l.ymin;m<l.ymax;++m){let d=(l.ymax-m-1)*(l.xmax-l.xmin)*4;const x=m*a.fWidth;for(let P=l.xmin;P<l.xmax;++P){let _=4*Math.round((a.fImgBuf[x+P]-i)/(o-i)*1e3);g[d++]=e.rgba[_++],g[d++]=e.rgba[_++],g[d++]=e.rgba[_++],g[d++]=e.rgba[_]}}return f.putImageData(c,0,0),{url:r.toDataURL(),constRatio:a.fConstRatio,can_zoom:!0}})})()}getImageZoomRange(a,t,e,n){const i={xmin:0,xmax:e,ymin:0,ymax:n};if(!a)return i;let o=0,l=0,s=e,r=n;if(t){const f=n/e,c=a.getFrameHeight()/a.getFrameWidth();if(f>c){const g=n/c;o=Math.round((g-e)/2),s=Math.round(g)}else{const g=c*e;l=Math.round((g-n)/2),r=Math.round(g)}}return a.zoom_xmin!==a.zoom_xmax&&(i.xmin=Math.min(e,Math.max(0,Math.round(a.zoom_xmin*s)-o)),i.xmax=Math.min(e,Math.max(0,Math.round(a.zoom_xmax*s)-o))),a.zoom_ymin!==a.zoom_ymax&&(i.ymin=Math.min(n,Math.max(0,Math.round(a.zoom_ymin*r)-l)),i.ymax=Math.min(n,Math.max(0,Math.round(a.zoom_ymax*r)-l))),i}makeUrlFromPngBuf(a,t){var e=this;return(0,b.A)(function*(){const n=a.fPngBuf;let i="";if((0,h.isStr)(n))i=n;else for(let s=0;s<n.length;++s)i+=String.fromCharCode(n[s]<0?256+n[s]:n[s]);const o={url:"data:image/png;base64,"+(0,h.btoa_func)(i),constRatio:a.fConstRatio,can_zoom:t&&!(0,h.isNodeJs)()},l=(0,h.getDocument)();return!o.can_zoom||t?.zoom_xmin===t?.zoom_xmax&&t?.zoom_ymin===t?.zoom_ymax?o:new Promise(s=>{const r=l.createElement("img");r.onload=()=>{const f=l.createElement("canvas");f.width=r.width,f.height=r.height;const c=f.getContext("2d");c.drawImage(r,0,0);const g=c.getImageData(0,0,r.width,r.height).data,m=e.getImageZoomRange(t,o.constRatio,r.width,r.height),d=l.createElement("canvas");d.width=m.xmax-m.xmin,d.height=m.ymax-m.ymin;const x=d.getContext("2d"),P=x.getImageData(0,0,d.width,d.height),_=P.data;for(let C=m.ymin;C<m.ymax;++C){let M=(m.ymax-C-1)*(m.xmax-m.xmin)*4,I=4*((r.height-C-1)*r.width+m.xmin);for(let y=m.xmin;y<m.xmax;++y)_[M++]=g[I++],_[M++]=g[I++],_[M++]=g[I++],_[M++]=g[I++]}x.putImageData(P,0,0),o.url=d.toDataURL(),s(o)},r.onerror=()=>s(o),r.src=o.url})})()}drawImage(){var a=this;return(0,b.A)(function*(){const t=a.getObject(),e=a.getFramePainter(),n=e?.getFrameRect()??a.getPadPainter().getPadRect();let i;return a.wheel_zoomy=!0,t._blob&&(15!==t._blob.length||t._blob[0]?3===t._blob.length&&t._blob[0]?(t.fPngBuf=t._blob[2],t.fPngBuf?.length!==t._blob[1]&&(console.error(`TASImage with png buffer _blob error ${t._blob[1]} != ${t.fPngBuf?.length}`),delete t.fPngBuf)):console.error(`TASImage _blob len ${t._blob.length} not recognized`):(t.fImageQuality=t._blob[1],t.fImageCompression=t._blob[2],t.fConstRatio=t._blob[3],t.fPalette={_typename:h.clTImagePalette,fUniqueID:t._blob[4],fBits:t._blob[5],fNumPoints:t._blob[6],fPoints:t._blob[7],fColorRed:t._blob[8],fColorGreen:t._blob[9],fColorBlue:t._blob[10],fColorAlpha:t._blob[11]},t.fWidth=t._blob[12],t.fHeight=t._blob[13],t.fImgBuf=t._blob[14],(t.fWidth*t.fHeight!==t.fImgBuf.length||t.fPalette.fNumPoints!==t.fPalette.fPoints.length)&&(console.error(`TASImage _blob decoding error ${t.fWidth*t.fHeight} != ${t.fImgBuf.length} ${t.fPalette.fNumPoints} != ${t.fPalette.fPoints.length}`),delete t.fImgBuf,delete t.fPalette)),delete t._blob),i=t.fImgBuf&&t.fPalette?a.makeUrlFromImageBuf(t,e):t.fPngBuf?a.makeUrlFromPngBuf(t,e):Promise.resolve(null),i.then(o=>{if(!o?.url)return a;const l=a.createG(e).append("image").attr("href",o.url).attr("width",n.width).attr("height",n.height).attr("preserveAspectRatio",o.constRatio?null:"none");return a.isBatchMode()||((h.settings.MoveResize||h.settings.ContextMenu)&&l.style("pointer-events","visibleFill"),o.can_zoom&&l.style("cursor","pointer")),(0,R.wh)(a,R.Og),e&&o.can_zoom?a.drawColorPalette(a.options.Zscale,!0).then(()=>(e.setAxesRanges((0,h.create)(h.clTAxis),0,1,(0,h.create)(h.clTAxis),0,1,null,0,0),e.createXY({ndim:2,check_pad_range:!1}),e.addInteractivity())):a})})()}fillContextMenuItems(a){const t=this.getObject();t&&a.addchk(t.fConstRatio,"Const ratio",e=>{t.fConstRatio=e,this.interactiveRedraw("pad",`exec:SetConstRatio(${e})`)},"Change const ratio flag of image"),t?.fPalette&&a.addchk(this.options.Zscale,"Color palette",e=>{this.options.Zscale=e,this.drawColorPalette(e,!0)},"Toggle color palette")}canZoomInside(a,t,e){return!!this.getObject()&&("x"===a||"y"===a)&&e-t>.01}drawColorPalette(a,t){var e=this;return(0,b.A)(function*(){if(!e.isMainPainter())return null;if(!e.draw_palette){const o=(0,h.create)(h.clTPaletteAxis);Object.assign(o,{fX1NDC:.91,fX2NDC:.95,fY1NDC:.1,fY2NDC:.9,fInit:1}),o.fAxis.fChopt="+",e.draw_palette=o,e._color_palette=!0}let n=e.getPadPainter().findPainterFor(e.draw_palette);if(!a)return n&&(n.Enabled=!1,n.removeG()),null;const i=e.getFramePainter();if(t&&i){const o=e.draw_palette;o.fX2NDC=i.fX2NDC+.01+(o.fX2NDC-o.fX1NDC),o.fX1NDC=i.fX2NDC+.01,o.fY1NDC=i.fY1NDC,o.fY2NDC=i.fY2NDC}return n?(n.Enabled=!0,n.drawPave("")):E.TPavePainter.draw(e.getPadPainter(),e.draw_palette).then(o=>{n=o,n.setSecondary(e),n.redraw=function(){}})})()}toggleColz(){if(this.getObject()?.fPalette)return this.options.Zscale=!this.options.Zscale,this.drawColorPalette(this.options.Zscale,!0)}redraw(){return this.drawImage()}clickButton(a){return!(!this.isMainPainter()||"ToggleColorZ"!==a)&&this.toggleColz()}fillToolbar(){const a=this.getPadPainter();a&&this.getObject()?.fPalette&&(a.addPadButton("th2colorz","Toggle color palette","ToggleColorZ"),a.showPadButtons())}static draw(a,t,e){return(0,b.A)(function*(){const n=new D(a,t,e);return n.setAsMainPainter(),n.decodeOptions(e),(0,w.ensureTCanvas)(n,!1).then(()=>n.drawImage()).then(()=>(n.fillToolbar(),n))})()}}}}]);