import{a as Se,c as tt}from"./chunk-LWQ6XHU3.js";import{a as Be,b as qe,c as Je,d as Qe,e as et}from"./chunk-YC5SGHGH.js";import{a as c,b as Ne,c as Ve,d as ne,e as He,f as $e,g as Ge,h as Ze,i as Ue,j as Xe,k as Ye,l as We,m as ze,n as ee,o as xe,r as Ke}from"./chunk-FYXTN3X2.js";import{$ as Pe,b as Oe,ca as Ee,da as Re}from"./chunk-FVXVO67X.js";import{f as de,g as Ae,n as Ie,s as Le,v as je}from"./chunk-KYOHYQWH.js";function ye(e,h,i){let r={font:Ve(),size:i,height:0,curveSegments:5};if(c.REVISION>162?r.depth=0:r.height=0,Ee(h))return new c.TextGeometry(Pe(h),r);let t=i*100,n=[],d=5;class f{constructor(w,z){this.kind=w??"g",this.childs=[],this.x=0,this.y=0,this.font_size=z?.font_size??t,z?.childs.push(this)}append(w){if(w==="svg:g")return new f("g",this);if(w==="svg:text")return new f("text",this);if(w==="svg:path")return new f("path",this);console.log("should create",w)}style(w,z){return w==="stroke-width"&&z&&(d=Number.parseInt(z)),this}translate(){this.geom&&this.geom.translate(this.x,this.y,0),this.childs.forEach(w=>{w.x+=this.x,w.y+=this.y,w.translate()})}attr(w,z){let R=()=>{if(!z)return"";let y=z[0];return z=z.slice(1),y},j=y=>{let _=0;for(;z[_]>="0"&&z[_]<="9"||z[_]==="-";)_++;let x=Number.parseInt(z.slice(0,_));return z=z.slice(_),y&&R(),x};if(w==="font-size"&&z)this.font_size=Number.parseInt(z);else if(w==="transform"&&Ae(z)&&z.indexOf("translate")===0){let y=z.slice(z.indexOf("(")+1,z.lastIndexOf(")")).split(",");this.x+=y[0]?Number.parseInt(y[0])*.01:0,this.y-=y[1]?Number.parseInt(y[1])*.01:0}else if(w==="x"&&this.kind==="text")this.x+=Number.parseInt(z)*.01;else if(w==="y"&&this.kind==="text")this.y-=Number.parseInt(z)*.01;else if(w==="d"&&this.kind==="path"){if(R()!=="M")return console.error("Not starts with M");let y=[],_=j(!0),x=j(),D;for(;D=R();){let T=_,p=x;switch(D){case"L":T=j(!0),p=j();break;case"l":T+=j(!0),p+=j();break;case"H":T=j();break;case"h":T+=j();break;case"V":p=j();break;case"v":p+=j();break;default:console.log("not supported operator",D)}let F=Math.atan2(p-x,T-_),E=.5*d*Math.sin(F),L=-.5*d*Math.cos(F);y.push(_-E,x-L,0,T-E,p-L,0,T+E,p+L,0,_-E,x-L,0,T+E,p+L,0,_+E,x+L,0),_=T,x=p}let B=new Float32Array(y);this.geom=new c.BufferGeometry,this.geom.setAttribute("position",new c.BufferAttribute(B,3)),this.geom.scale(.01,-.01,.01),this.geom.computeVertexNormals(),n.push(this.geom)}return this}text(w){this.kind==="text"&&(r.size=Math.round(.01*this.font_size),this.geom=new c.TextGeometry(w,r),n.push(this.geom))}}let s=new f;if(Re(e,s,{font_size:t,latex:1,x:0,y:0,text:h,align:["start","top"],fast:!0,font:{size:t,isMonospace:()=>!1,aver_width:.9}}),!n.length)return r.size=i,new c.TextGeometry(Pe(h),r);if(s.translate(),n.length===1)return n[0];let u=0;n.forEach(S=>{u+=S.getAttribute("position").array.length});let P=new Float32Array(u),M=new Float32Array(u),A=0;n.forEach(S=>{let w=S.getAttribute("position").array,z=S.getAttribute("normal").array;for(let R=0;R<w.length;++R,++A)P[A]=w[R],M[A]=z[R]});let v=new c.BufferGeometry;return v.setAttribute("position",new c.BufferAttribute(P,3)),v.setAttribute("normal",new c.BufferAttribute(M,3)),v}function st(e,h,i=!1,r=!1){let t;if(h?.children)for(let a=0;a<h.children.length&&(t=h.children[a],!t.axis_draw);++a)t=void 0;if(!t)return;if(!e){h.remove(t);return}let n=e.position,d=1;n.x<0&&n.y>=0&&(d=2),n.x>=0&&n.y>=0&&(d=3),n.x>=0&&n.y<0&&(d=4);let f=(a,u)=>(a<=d&&(a+=4),a>d&&a<d+u),s=a=>{for(let u=0;u<a.children?.length;++u)a.children[u].zoom!==void 0&&(a.children[u].zoom_disabled=!a.visible)};for(let a=0;a<t.children.length;++a){let u=t.children[a];if(u.grid)u.visible=r&&f(u.grid,3);else if(u.zid)u.visible=f(u.zid,2),s(u);else if(u.xyid)u.visible=f(u.xyid,3),s(u);else if(u.xyboxid){let P=5,M=0;r&&!i?(P=3,M=-2):i&&!r?P=3:!i&&!r&&(P=u.bottom?3:0),u.visible=f(u.xyboxid+M,P),!u.visible&&u.bottom&&r&&(u.visible=f(u.xyboxid,3))}else if(u.zboxid){let P=2,M=0;i&&r?P=5:r&&!i?P=4:!r&&i&&(M=-2,P=4),u.visible=f(u.zboxid+M,P)}}}function Ce(e,h,i,r){if(e.options.System===Be)return h;let t=e.getFramePainter(),n=1/t.size_x3d,d=1/t.size_y3d;if(i&&r&&(n*=i/(i-1),d*=r/(r-1)),e.options.System===qe)for(let f=0;f<h.length;f+=3){let s=(1-h[f]*n)*Math.PI,a=.5+.5*h[f+1]*d;h[f]=Math.cos(s)*a*t.size_x3d,h[f+1]=Math.sin(s)*a*t.size_y3d}else if(e.options.System===Je)for(let f=0;f<h.length;f+=3){let s=(1-h[f]*n)*Math.PI,a=.5+h[f+2]/t.size_z3d/4;h[f]=Math.cos(s)*a*t.size_x3d,h[f+2]=(1+Math.sin(s)*a)*t.size_z3d}else if(e.options.System===Qe)for(let f=0;f<h.length;f+=3){let s=(1+h[f]*n)*Math.PI,a=h[f+1]*d*Math.PI,u=.5+h[f+2]/t.size_z3d/4;h[f]=u*Math.cos(a)*Math.cos(s)*t.size_x3d,h[f+1]=u*Math.cos(a)*Math.sin(s)*t.size_y3d,h[f+2]=(1+u*Math.sin(a))*t.size_z3d}else if(e.options.System===et)for(let f=0;f<h.length;f+=3){let s=(1-h[f]*n)*Math.PI,a=h[f+1]*d*Math.PI,u=.5+h[f+2]/t.size_z3d/4;h[f]=u*Math.cos(s)*t.size_x3d,h[f+1]=u*Math.sin(a)/Math.cos(a)*t.size_y3d/2,h[f+2]=(1+u*Math.sin(s))*t.size_z3d}return h}function ve(e,h,i,r,t){let n=new c.BufferGeometry;return e.options.System===Be?(n.setAttribute("position",new c.BufferAttribute(h,3)),i?n.setAttribute("normal",new c.BufferAttribute(i,3)):n.computeVertexNormals()):(Ce(e,h,r,t),n.setAttribute("position",new c.BufferAttribute(h,3)),n.computeVertexNormals()),n}function nt(e,h){e.camera&&(e.scene.remove(e.camera),ze(e.camera),delete e.camera),h?e.camera=new c.OrthographicCamera(-1.3*e.size_x3d,1.3*e.size_x3d,2.3*e.size_z3d,-.7*e.size_z3d,.001,40*e.size_z3d):e.camera=new c.PerspectiveCamera(45,e.scene_width/e.scene_height,1,40*e.size_z3d),e.camera.up.set(0,0,1),e.pointLight=new c.DirectionalLight(16777215,3),e.pointLight.position.set(e.size_x3d/2,e.size_y3d/2,e.size_z3d/2),e.camera.add(e.pointLight),e.lookat=new c.Vector3(0,0,h?.3*e.size_z3d:.8*e.size_z3d),e.scene.add(e.camera)}function ot(e,h){let i=e.getPadPainter().getRootPad(!0),r=e.camera.isOrthographicCamera?1:1.4,t=Math.max(.75*e.size_x3d,e.size_z3d),n=Math.max(.75*e.size_y3d,e.size_z3d),d=null;if(h&&(d=new c.Vector3,t===n?d.set(-1.6*t,-3.5*n,r*e.size_z3d):t>n?d.set(-2*t,-3.5*n,r*e.size_z3d):d.set(-3.5*t,-2*n,r*e.size_z3d)),i&&(h||!e.zoomChangedInteractive())&&Number.isFinite(i.fTheta)&&Number.isFinite(i.fPhi)&&(i.fTheta!==e.camera_Theta||i.fPhi!==e.camera_Phi)){d||(d=new c.Vector3),t=3*Math.max(e.size_x3d,e.size_z3d),n=3*Math.max(e.size_y3d,e.size_z3d);let f=(270-i.fPhi)/180*Math.PI,s=(i.fTheta-10)/180*Math.PI;d.set(t*Math.cos(f)*Math.cos(s),n*Math.sin(f)*Math.cos(s),e.size_z3d+(r-.9)*(t+n)*Math.sin(s))}return d}function De(e,h){let i=ot(e,h);if(i&&(e.camera.position.copy(i),h=!0),h&&e.camera.lookAt(e.lookat),h&&e.camera.isOrthographicCamera&&e.scene_width&&e.scene_height){let r=e.scene_width/e.scene_height,t=e.camera.right-e.camera.left,n=e.camera.top-e.camera.bottom;if(r>t/n){let d=(e.camera.right+e.camera.left)/2;e.camera.left=d-n*r/2,e.camera.right=d+n*r/2}else{let d=(e.camera.top+e.camera.bottom)/2;e.camera.top=d+t/r/2,e.camera.bottom=d-t/r/2}}e.camera.updateProjectionMatrix()}function at(e){let h=e.camera.position,i=e.lookat,r=h.distanceTo(i),t=Math.sqrt((h.x-i.x)**2+(h.y-i.y)**2),n=Math.atan2((h.z-i.z)/r,t/r)/Math.PI*180,d=270-Math.atan2((h.y-i.y)/t,(h.x-i.x)/t)/Math.PI*180,f=e.getPadPainter()?.getRootPad(!0);e.camera_Phi=d>=360?d-360:d,e.camera_Theta=n,f&&Number.isFinite(e.camera_Phi)&&Number.isFinite(e.camera_Theta)&&(f.fPhi=e.camera_Phi,f.fTheta=e.camera_Theta)}function rt(e){e.control=We(e,e.camera,e.scene,e.renderer,e.lookat);let h=e,i=e.getMainPainter();if(e.access3dKind()===Le.Embed3D.Embed){let r=e.getCanvPainter()?.getPadScale();r&&e.control.tooltip?.setScale(r)}e.control.processMouseMove=function(r){let t=null,n=null,d=null,f=h.isTooltipAllowed();for(let s=0;s<r.length;++s)if(f&&de(r[s].object?.tooltip)){if(t=r[s].object.tooltip(r[s]),t){n=r[s].object;break}}else r[s].object?.zoom&&!d&&(d=r[s].object);if(t&&!t.use_itself){let s=1e-4*h.size_x3d,a=1e-4*h.size_y3d,u=1e-4*h.size_z3d;(t.x1>t.x2||t.y1>t.y2||t.z1>t.z2)&&console.warn("check 3D hints coordinates"),t.x1-=s,t.x2+=s,t.y1-=a,t.y2+=a,t.z1-=u,t.z2+=u}if(h.highlightBin3D(t,n),!t&&d&&de(h.get3dZoomCoord)){let s=d.zoom,a=d.globalIntersect(this.raycaster),u=h.get3dZoomCoord(a,s);return s==="z"&&d.use_y_for_z&&(s="y"),{name:s,title:"axis object",line:s+" : "+h.axisAsText(s,u),only_status:!0}}return t?.lines?t:""},e.control.processMouseLeave=function(){h.highlightBin3D(null)},e.control.contextMenu=function(r,t){let n="painter",d=i;if(t)for(let s=0;s<t.length;++s){let a=t[s].object;if(a.zoom){n=a.zoom,d=null;break}if(de(a.painter?.fillContextMenu)){d=a.painter;break}}let f=i.getFramePainter();de(f?.showContextMenu)&&f.showContextMenu(n,r,d)}}function ht(e,h,i,r){if(e===-1){if(!this.mode3d)return;if(!de(this.clear3dCanvas)){console.error(`Strange, why mode3d=${this.mode3d} is configured!!!!`);return}st(null,this.toplevel),this.clear3dCanvas(),ze(this.scene),this.control?.cleanup(),Ue(this.renderer),delete this.size_x3d,delete this.size_y3d,delete this.size_z3d,delete this.tooltip_mesh,delete this.scene,delete this.toplevel,delete this.camera,delete this.pointLight,delete this.renderer,delete this.control,this.render_tmout&&(clearTimeout(this.render_tmout),delete this.render_tmout),this.mode3d=!1,this.draw_g&&this.createFrameG();return}if(this.mode3d=!0,"toplevel"in this){this.scene.remove(this.toplevel),ze(this.toplevel),delete this.tooltip_mesh,delete this.toplevel,this.control?.hideTooltip();let d=new c.Object3D;return this.scene.add(d),this.toplevel=d,this.resize3D(),De(this,!1),Promise.resolve(!0)}e=$e(e,this.isBatchMode()),Ge(this);let t=this.getSizeFor3d(void 0,e);this.size_z3d=100,this.x3dscale=h||1,this.y3dscale=i||1;let n=t.height>10&&t.width>10?Math.round(t.width/t.height*this.size_z3d):this.size_z3d;return this.size_x3d=n*this.x3dscale,this.size_y3d=n*this.y3dscale,Ne().then(()=>(this.scene=new c.Scene,this.toplevel=new c.Object3D,this.scene.add(this.toplevel),this.scene_width=t.width,this.scene_height=t.height,this.scene_x=t.x??0,this.scene_y=t.y??0,this.camera_Phi=30,this.camera_Theta=30,nt(this,r),De(this,!0),Ze(this.scene_width,this.scene_height,e))).then(d=>(this.renderer=d,this.webgl=d.jsroot_render3d===Le.Render3D.WebGL,this.add3dCanvas(t,d.jsroot_dom,this.webgl),this.first_render_tm=0,this.enable_highlight=!1,!this.isBatchMode()&&this.webgl&&!Ie()&&rt(this),this))}function lt(e){let h=!1;this.control&&(this.control.cleanup(),delete this.control,h=!0),nt(this,e),De(this,!0),h&&rt(this),this.render3D()}function dt(e,h,i){if(e){if(!this.toplevel)return console.error("3D objects are not yet created in the frame");h&&i&&this.remove3DMeshes(h),this.toplevel.add(e),e._painter=h}}function ct(e){if(!e||!this.toplevel)return;let h=this.toplevel.children.length;for(;h>0;){let i=this.toplevel.children[--h];i._painter===e&&(this.toplevel.remove(i),ze(i))}}function mt(e){if(e===-1111){let t=je(),n=He(!1,0,t);if(n.setSize(this.scene_width,this.scene_height),n.render(this.scene,this.camera),n.makeOuterHTML){let d=t.createElement("div");return d.innerHTML=n.makeOuterHTML(),d.childNodes[0]}return n.domElement}e===void 0&&(e=5);let h=this.isBatchMode();if(e>0&&!this.usesvg&&!h){this.render_tmout||(this.render_tmout=setTimeout(()=>this.render3D(0),e));return}if(this.render_tmout&&(clearTimeout(this.render_tmout),delete this.render_tmout),!this.renderer)return;Xe(this.renderer);let i=new Date;st(this.camera,this.toplevel,this.opt3d?.FrontBox,this.opt3d?.BackBox),this.renderer.render(this.scene,this.camera),Ye(this.renderer);let r=new Date;this.first_render_tm===0?(this.first_render_tm=r.getTime()-i.getTime(),this.enable_highlight=this.first_render_tm<1200&&this.isTooltipAllowed(),this.first_render_tm>500&&console.log(`three.js r${c.REVISION}, first render tm = ${this.first_render_tm}`)):at(this),this.processRender3D&&this.getPadPainter()?.painters?.forEach(t=>{de(t.handleRender3D)&&t.handleRender3D()})}function ft(){let e=this.getSizeFor3d(this.access3dKind());if(this.apply3dSize(e),this.scene_width===e.width&&this.scene_height===e.height||e.width<10||e.height<10)return!1;this.scene_width=e.width,this.scene_height=e.height,this.camera.aspect=this.scene_width/this.scene_height,this.camera.updateProjectionMatrix(),this.renderer.setSize(this.scene_width,this.scene_height);let h=e.height>10&&e.width>10?Math.round(e.width/e.height*this.size_z3d):this.size_z3d,i=h*this.x3dscale,r=h*this.y3dscale;return Math.abs(i-this.size_x3d)>.15*this.size_z3d||Math.abs(r-this.size_y3d)>.15*this.size_z3d?(this.size_x3d=i,this.size_y3d=r,this.control?.position0?.copy(ot(this,!0)),1):!0}function xt(e,h){let i=!e||e.x1===void 0||!this.enable_highlight,r=!1,t=null,n=!0,d=this.getMainPainter();if((!d?.provideUserTooltip||!d?.hasUserTooltip())&&(d=null),this.tooltip_selfmesh&&(n=this.tooltip_selfmesh!==h,this.tooltip_selfmesh.material.color=this.tooltip_selfmesh.save_color,delete this.tooltip_selfmesh,r=!0),this.tooltip_mesh&&(t=this.tooltip_mesh,this.toplevel.remove(this.tooltip_mesh),delete this.tooltip_mesh,r=!0),i){r&&(this.render3D(),d?.provideUserTooltip(null));return}if(e.use_itself)h.save_color=h.material.color,h.material.color=new c.Color(e.color),this.tooltip_selfmesh=h,r=n;else{r=!0;let f=xe.Indexes,s=xe.Normals,a=xe.Vertices,u=new c.Color(e.color?e.color:16711680),P=e.opacity||1,M,A;if(t)M=t.geometry.attributes.position.array,t.geometry.attributes.position.needsUpdate=!0,t.material.color=u,t.material.opacity=P;else{M=new Float32Array(f.length*3),A=new Float32Array(f.length*3);let v=new c.BufferGeometry;v.setAttribute("position",new c.BufferAttribute(M,3)),v.setAttribute("normal",new c.BufferAttribute(A,3));let S=new c.MeshBasicMaterial({color:u,opacity:P,vertexColors:!1});t=new c.Mesh(v,S)}e.x1===e.x2&&console.warn(`same tip X ${e.x1} ${e.x2}`),e.y1===e.y2&&console.warn(`same tip Y ${e.y1} ${e.y2}`),e.z1===e.z2&&(e.z2=e.z1+1e-4);for(let v=0,S=-3;v<f.length;++v){let w=a[f[v]];M[v*3]=e.x1+w.x*(e.x2-e.x1),M[v*3+1]=e.y1+w.y*(e.y2-e.y1),M[v*3+2]=e.z1+w.z*(e.z2-e.z1),A&&(v%6===0&&(S+=3),A[v*3]=s[S],A[v*3+1]=s[S+1],A[v*3+2]=s[S+2])}this.tooltip_mesh=t,this.toplevel.add(t),e.$painter&&e.$painter.options.System!==Be&&(Ce(e.$painter,M),t.geometry.computeVertexNormals())}r&&this.render3D(),r&&e.$projection&&de(e.$painter?.redrawProjection)&&e.$painter.redrawProjection(e.ix-1,e.ix,e.iy-1,e.iy),r&&d?.getObject()&&d.provideUserTooltip({obj:d.getObject(),name:d.getObject().fName,bin:e.bin,cont:e.value,binx:e.ix,biny:e.iy,binz:e.iz,grx:(e.x1+e.x2)/2,gry:(e.y1+e.y2)/2,grz:(e.z1+e.z2)/2})}function gt(e){this.opt3d=e}function ut(e,h,i){i||(i={ndim:2}),i.drawany===!1?i.draw=!1:i.drawany=!0;let r=i.v7?null:this.getPadPainter().getRootPad(!0),t=-this.size_x3d,n=this.size_x3d,d=-this.size_y3d,f=this.size_y3d,s=0,a=2*this.size_z3d,u=this.size_z3d,P=this.xmin,M=this.xmax,A=this.ymin,v=this.ymax,S=this.zmin,w=this.zmax,z=!1,R=!1;this.size_z3d||(t=this.xmin,n=this.xmax,d=this.ymin,f=this.ymax,s=this.zmin,a=this.zmax,u=a-s),"zoom_xmin"in this&&"zoom_xmax"in this&&this.zoom_xmin!==this.zoom_xmax&&(P=this.zoom_xmin,M=this.zoom_xmax),"zoom_ymin"in this&&"zoom_ymax"in this&&this.zoom_ymin!==this.zoom_ymax&&(A=this.zoom_ymin,v=this.zoom_ymax,z=!0),"zoom_zmin"in this&&"zoom_zmax"in this&&this.zoom_zmin!==this.zoom_zmax&&(S=this.zoom_zmin,w=this.zoom_zmax,R=!0),i.use_y_for_z&&(this.zmin=this.ymin,this.zmax=this.ymax,S=A,w=v,R=z,A=0,v=1),this.lego_zmin=S,this.lego_zmax=w,i.zmult!==void 0&&!R&&(w*=i.zmult),this.x_handle=new h(null,this.xaxis),i.v7?(this.x_handle.pad_name=this.pad_name,this.x_handle.assignSnapId(this.snapid)):i.hist_painter&&this.x_handle.setHistPainter(i.hist_painter,"x"),this.x_handle.configureAxis("xaxis",this.xmin,this.xmax,P,M,!1,[t,n],{log:r?.fLogx??0,reverse:i.reverse_x,logcheckmin:!0}),this.x_handle.assignFrameMembers(this,"x"),this.x_handle.extractDrawAttributes(u),this.y_handle=new h(null,this.yaxis),i.v7?(this.y_handle.pad_name=this.pad_name,this.y_handle.assignSnapId(this.snapid)):i.hist_painter&&this.y_handle.setHistPainter(i.hist_painter,"y"),this.y_handle.configureAxis("yaxis",this.ymin,this.ymax,A,v,!1,[d,f],{log:r&&!i.use_y_for_z?r.fLogy:0,reverse:i.reverse_y,logcheckmin:i.ndim>1}),this.y_handle.assignFrameMembers(this,"y"),this.y_handle.extractDrawAttributes(u),this.z_handle=new h(null,this.zaxis),i.v7?(this.z_handle.pad_name=this.pad_name,this.z_handle.assignSnapId(this.snapid)):i.hist_painter&&this.z_handle.setHistPainter(i.hist_painter,"z"),this.z_handle.configureAxis("zaxis",this.zmin,this.zmax,S,w,!1,[s,a],{value_axis:i.ndim===1||i.ndim===2,log:(i.use_y_for_z||i.ndim===2?r?.fLogv:void 0)??r?.fLogz??0,reverse:i.reverse_z,logcheckmin:i.ndim>2}),this.z_handle.assignFrameMembers(this,"z"),this.z_handle.extractDrawAttributes(u),this.setRootPadRange(r,!0);let j={},y={},_=this.x_handle.createTicks(!1,!0),x=this.y_handle.createTicks(!1,!0),D=this.z_handle.createTicks(!1,!0),B=1;function T(o,l){let m=(l==="ticks"?o.ticksColor:o.lineatt.color)||"black",C=l==="ticks"?o.ticksWidth:o.lineatt.width,g=`${m}_${C}`;return y[g]||(y[g]=new c.LineBasicMaterial(ne(m,{linewidth:C,vertexColors:!1}))),y[g]}function p(o,l,m){let C=m||(l==="title"?o.titleFont?.color:o.labelsFont?.color)||"black";return j[C]||(j[C]=new c.MeshBasicMaterial(ne(C,{vertexColors:!1}))),j[C]}let F=new c.Object3D;F.axis_draw=!0,e.add(F);let E=[],L=[],G=0,H=0,oe=this.x_handle.isCenteredLabels(),J=this.x_handle.isRotateLabels();for(;_.next();){let o=_.grpos,l=_.kind===1,m=this.x_handle.format(_.tick,2);if(_.last_major()?this.x_handle.fTitle||(m="x"):m===null&&(l=!1,m=""),l&&m&&i.draw&&(!oe||!_.last_major())){let C=_.get_modifier();C?.fLabText&&(m=C.fLabText);let g=ye(this,m,this.x_handle.labelsFont.size);g.computeBoundingBox();let k=g.boundingBox.max.x-g.boundingBox.min.x,I=g.boundingBox.max.y-g.boundingBox.min.y;g.center=!0,g.offsety=this.x_handle.labelsOffset+(f-d)*.005,H=Math.max(H,k),G=Math.max(G,I),C?.fTextColor&&(g.color=this.getColor(C.fTextColor)),g.grx=o,L.push(g);let b=0;_.last_major()||(b=Math.abs(_.next_major_grpos()-o),k>0&&b>0&&(B=Math.min(B,.9*b/k))),J&&(g.rotate=1),oe&&(b||(b=Math.min(o-t,n-o)),g.grx+=b/2)}E.push(o,0,0,o,this.x_handle.ticksSize*(l?-1:-.6),0)}if(this.x_handle.fTitle&&i.draw){let o=ye(this,this.x_handle.fTitle,this.x_handle.titleFont.size);o.computeBoundingBox(),o.center=this.x_handle.titleCenter,o.opposite=this.x_handle.titleOpposite,o.offsety=1.6*this.x_handle.titleOffset+(f-d)*.005,o.grx=(t+n)/2,o.kind="title",this.x_handle.isRotateTitle()&&(o.rotate=2),L.push(o)}this.get3dZoomCoord=function(o,l){let m=this[`scale_${l}min`],C=this[`scale_${l}max`],g=o[l];switch(l){case"x":g=(g+this.size_x3d)/2/this.size_x3d;break;case"y":g=(g+this.size_y3d)/2/this.size_y3d;break;case"z":g=g/2/this.size_z3d;break}return this["log"+l]?g=Math.exp(Math.log(m)+g*(Math.log(C)-Math.log(m))):g=m+g*(C-m),g};let W=(o,l,m)=>{let C=new c.BufferGeometry,g=Math.max(this[o+"_handle"].ticksSize,.005*l),k;o==="z"?k=new Float32Array([0,0,0,g*4,0,2*l,g*4,0,0,0,0,0,0,0,2*l,g*4,0,2*l]):k=new Float32Array([-l,0,0,l,-g*4,0,l,0,0,-l,0,0,-l,-g*4,0,l,-g*4,0]),C.setAttribute("position",new c.BufferAttribute(k,3)),C.computeVertexNormals();let I=new c.MeshBasicMaterial({transparent:!0,vertexColors:!1,side:c.DoubleSide,opacity:0}),b=new c.Mesh(C,I);return b.zoom=o,b.size_3d=l,b.tsz=g,b.use_y_for_z=m,o==="y"&&b.rotateZ(Math.PI/2).rotateX(Math.PI),b.v1=new c.Vector3(k[0],k[1],k[2]),b.v2=new c.Vector3(k[6],k[7],k[8]),b.v3=new c.Vector3(k[3],k[4],k[5]),b.globalIntersect=function(q){if(!this.v1||!this.v2||!this.v3)return;let V=new c.Plane;V.setFromCoplanarPoints(this.v1,this.v2,this.v3),V.applyMatrix4(this.matrixWorld);let Y=q.ray.origin.clone(),re=Y.clone().addScaledVector(q.ray.direction,1e10),O=V.intersectLine(new c.Line3(Y,re),new c.Vector3);if(!O)return;let X=-this.size_3d,fe=this.size_3d;return this.zoom==="z"&&(X=0,fe=2*this.size_3d),O[this.zoom]<X?O[this.zoom]=X:O[this.zoom]>fe&&(O[this.zoom]=fe),O},b.showSelection=function(q,V){let Y=this.children?this.children[0]:null,re;if(!q||!V)return Y&&(this.remove(Y),ze(Y)),Y;if(!this.geometry)return!1;if(Y)re=Y.geometry;else{re=this.geometry.clone();let X=re.getAttribute("position").array;this.zoom==="z"?X[6]=X[3]=X[15]=this.tsz:X[4]=X[16]=X[13]=-this.tsz,Y=new c.Mesh(re,new c.MeshBasicMaterial({color:65280,side:c.DoubleSide,vertexColors:!1})),this.add(Y)}let O=re.getAttribute("position").array;return this.zoom==="z"?(O[2]=O[11]=O[8]=q[this.zoom],O[5]=O[17]=O[14]=V[this.zoom]):(O[0]=O[9]=O[12]=q[this.zoom],O[6]=O[3]=O[15]=V[this.zoom]),re.getAttribute("position").needsUpdate=!0,!0},b},$=new c.Object3D,ce;$.position.set(0,d,s),$.rotation.x=1/4*Math.PI,$.xyid=2,$.painter=this.x_handle,i.draw&&(ce=ee(E,T(this.x_handle,"ticks")),$.add(ce)),L.forEach(o=>{let l=o.boundingBox.max.x-o.boundingBox.min.x,m=o.boundingBox.max.y-o.boundingBox.min.y,C=o.rotate===1?m:l,g=o.center?o.grx-C/2:o.opposite?t:n-C,k=-B*(o.rotate===1?H:G)-this.x_handle.ticksSize-o.offsety,I=new c.Matrix4;I.set(B,0,0,g,0,B,0,k,0,0,1,0,0,0,0,1);let b=new c.Mesh(o,p(this.x_handle,o.kind,o.color));o.rotate&&b.rotateZ(o.rotate*Math.PI/2),o.rotate===1&&b.translateY(-m),o.rotate===2&&b.translateX(-l),b.applyMatrix4(I),$.add(b)}),i.zoom&&i.drawany&&$.add(W("x",this.size_x3d)),F.add($),$=new c.Object3D,$.position.set(0,f,s),$.rotation.x=3/4*Math.PI,$.painter=this.x_handle,i.draw&&$.add(new c.LineSegments(ce.geometry,ce.material)),L.forEach(o=>{let l=o.boundingBox.max.x-o.boundingBox.min.x,m=o.boundingBox.max.y-o.boundingBox.min.y,C=o.rotate===1?m:l,g=o.center?o.grx+C/2:o.opposite?t+C:n,k=-B*(o.rotate===1?H:G)-this.x_handle.ticksSize-o.offsety,I=new c.Matrix4;I.set(-B,0,0,g,0,B,0,k,0,0,-1,0,0,0,0,1);let b=new c.Mesh(o,p(this.x_handle,o.kind,o.color));o.rotate&&b.rotateZ(o.rotate*Math.PI/2),o.rotate===1&&b.translateY(-m),o.rotate===2&&b.translateX(-l),b.applyMatrix4(I),$.add(b)}),$.xyid=4,i.zoom&&i.drawany&&$.add(W("x",this.size_x3d)),F.add($),L=[],B=1,H=G=0,E=[];let ge=this.y_handle.isCenteredLabels(),ae=this.y_handle.isRotateLabels();for(;x.next();){let o=x.grpos,l=x.kind===1,m=this.y_handle.format(x.tick,2);if(x.last_major()?this.y_handle.fTitle||(m="y"):m===null&&(l=!1,m=""),l&&m&&i.draw&&(!ge||!x.last_major())){let C=x.get_modifier();C?.fLabText&&(m=C.fLabText);let g=ye(this,m,this.y_handle.labelsFont.size);g.computeBoundingBox();let k=g.boundingBox.max.x-g.boundingBox.min.x,I=g.boundingBox.max.y-g.boundingBox.min.y;g.center=!0,H=Math.max(H,k),G=Math.max(G,I),C?.fTextColor&&(g.color=this.getColor(C.fTextColor)),g.gry=o,g.offsetx=this.y_handle.labelsOffset+(n-t)*.005,L.push(g);let b=0;x.last_major()||(b=Math.abs(x.next_major_grpos()-o),k>0&&(B=Math.min(B,.9*b/k))),ge&&(b||(b=Math.min(o-d,f-o)),g.gry+=b/2),ae&&(g.rotate=1)}E.push(0,o,0,this.y_handle.ticksSize*(l?-1:-.6),o,0)}if(this.y_handle.fTitle&&i.draw){let o=ye(this,this.y_handle.fTitle,this.y_handle.titleFont.size);o.computeBoundingBox(),o.center=this.y_handle.titleCenter,o.opposite=this.y_handle.titleOpposite,o.offsetx=1.6*this.y_handle.titleOffset+(n-t)*.005,o.gry=(d+f)/2,o.kind="title",this.y_handle.isRotateTitle()&&(o.rotate=2),L.push(o)}if(!i.use_y_for_z){let o,l=new c.Object3D;l.position.set(t,0,s),l.rotation.y=-1/4*Math.PI,l.painter=this.y_handle,i.draw&&(o=ee(E,T(this.y_handle,"ticks")),l.add(o)),L.forEach(m=>{let C=m.boundingBox.max.x-m.boundingBox.min.x,g=m.boundingBox.max.y-m.boundingBox.min.y,k=m.rotate===1?g:C,I=-B*(m.rotate===1?H:G)-this.y_handle.ticksSize-m.offsetx,b=m.center?m.gry+k/2:m.opposite?d+k:f,q=new c.Matrix4;q.set(0,B,0,I,-B,0,0,b,0,0,1,0,0,0,0,1);let V=new c.Mesh(m,p(this.y_handle,m.kind,m.color));m.rotate&&V.rotateZ(m.rotate*Math.PI/2),m.rotate===1&&V.translateY(-g),m.rotate===2&&V.translateX(-C),V.applyMatrix4(q),l.add(V)}),l.xyid=3,i.zoom&&i.drawany&&l.add(W("y",this.size_y3d)),F.add(l),l=new c.Object3D,l.position.set(n,0,s),l.rotation.y=-3/4*Math.PI,l.painter=this.y_handle,i.draw&&l.add(new c.LineSegments(o.geometry,o.material)),L.forEach(m=>{let C=m.boundingBox.max.x-m.boundingBox.min.x,g=m.boundingBox.max.y-m.boundingBox.min.y,k=m.rotate===1?g:C,I=-B*(m.rotate===1?H:G)-this.y_handle.ticksSize-m.offsetx,b=m.center?m.gry-k/2:m.opposite?d:f-k,q=new c.Matrix4;q.set(0,B,0,I,B,0,0,b,0,0,-1,0,0,0,0,1);let V=new c.Mesh(m,p(this.y_handle,m.kind,m.color));m.rotate&&V.rotateZ(m.rotate*Math.PI/2),m.rotate===1&&V.translateY(-g),m.rotate===2&&V.translateX(-C),V.applyMatrix4(q),l.add(V)}),l.xyid=1,i.zoom&&i.drawany&&l.add(W("y",this.size_y3d)),F.add(l)}L=[],B=1,E=[];let he=null,me=null,we=null,Q=0,Me=this.z_handle.isCenteredLabels(),ke=this.z_handle.isRotateLabels();for(this.size_z3d&&i.drawany&&(he=[],me=[]);D.next();){let o=D.grpos,l=D.kind===1,m=this.z_handle.format(D.tick,2);if(m===null&&(l=!1,m=""),l&&m&&i.draw&&(!Me||!D.last_major())){let C=D.get_modifier();C?.fLabText&&(m=C.fLabText);let g=ye(this,m,this.z_handle.labelsFont.size);g.computeBoundingBox();let k=g.boundingBox.max.x-g.boundingBox.min.x,I=g.boundingBox.max.y-g.boundingBox.min.y;g.translate(-k,-I/2,0),C?.fTextColor&&(g.color=this.getColor(C.fTextColor)),g.grz=o,L.push(g),we!==null&&I>0&&(B=Math.min(B,.9*(o-we)/I)),Q=Math.max(Q,k),we=o}he&&l&&he.push(t,0,o,n,0,o),me&&l&&me.push(0,d,o,0,f,o),E.push(0,0,o,this.z_handle.ticksSize*(l?1:.6),0,o)}if(he&&he.length>0){let o=new c.LineDashedMaterial({color:this.x_handle.ticksColor,dashSize:2,gapSize:2}),l=ee(he,o);l.position.set(0,f,0),l.grid=2,l.visible=!1,F.add(l);let m=new c.LineSegments(l.geometry,o);m.position.set(0,d,0),m.grid=4,m.visible=!1,F.add(m)}if(me&&me.length>0){let o=new c.LineDashedMaterial({color:this.y_handle.ticksColor,dashSize:2,gapSize:2}),l=ee(me,o);l.position.set(n,0,0),l.grid=3,l.visible=!1,F.add(l);let m=new c.LineSegments(l.geometry,o);m.position.set(t,0,0),m.grid=1,m.visible=!1,F.add(m)}let Z=[],ue=i.draw?ee(E,T(this.z_handle,"ticks")):null;for(let o=0;o<4;++o){if(Z.push(new c.Object3D),L.forEach((l,m)=>{let C=new c.Matrix4,g=l.boundingBox.max.x-l.boundingBox.min.x,k=l.grz;Me&&(m<L.length-1?k=(k+L[m+1].grz)/2:m>0&&(k=Math.min(1.5*k-L[m-1].grz*.5,a))),C.set(-B,0,0,this.z_handle.ticksSize+(n-t)*.005+this.z_handle.labelsOffset,0,0,1,0,0,B,0,k);let I=new c.Mesh(l,p(this.z_handle));ke&&I.rotateZ(-Math.PI/2).translateX(g/2),I.applyMatrix4(C),Z[o].add(I)}),this.z_handle.fTitle&&i.draw){let l=ye(this,this.z_handle.fTitle,this.z_handle.titleFont.size);l.computeBoundingBox();let m=l.boundingBox.max.x-l.boundingBox.min.x,C=l.boundingBox.max.y-l.boundingBox.min.y,g=this.z_handle.isRotateTitle(),k=this.z_handle.titleCenter?(a+s-m)/2:(this.z_handle.titleOpposite?s:a-m)+(g?m:0),I=new c.Matrix4;I.set(-B,0,0,this.z_handle.ticksSize+(n-t)*.005+Q+this.z_handle.titleOffset,0,0,1,0,0,B,0,k);let b=new c.Mesh(l,p(this.z_handle,"title"));b.rotateZ(Math.PI*(g?1.5:.5)),g&&b.translateY(-C),b.applyMatrix4(I),Z[o].add(b)}i.draw&&ue&&Z[o].add(o===0?ue:new c.LineSegments(ue.geometry,ue.material)),i.zoom&&i.drawany&&Z[o].add(W("z",this.size_z3d,i.use_y_for_z)),Z[o].zid=o+2,F.add(Z[o]),Z[o].painter=this.z_handle}if(Z[0].position.set(t,f,0),Z[0].rotation.z=3/4*Math.PI,Z[1].position.set(n,f,0),Z[1].rotation.z=1/4*Math.PI,Z[2].position.set(n,d,0),Z[2].rotation.z=-1/4*Math.PI,Z[3].position.set(t,d,0),Z[3].rotation.z=-3/4*Math.PI,!i.drawany)return;let N=T(this.x_handle),se=ee([t,0,0,n,0,0],N,null,!0);for(let o=0;o<2;++o){let l=new c.LineSegments(se,N);l.position.set(0,d,o===0?s:a),l.xyboxid=2,l.bottom=o===0,F.add(l),l=new c.LineSegments(se,N),l.position.set(0,f,o===0?s:a),l.xyboxid=4,l.bottom=o===0,F.add(l)}let te=T(this.y_handle),K=ee([0,d,0,0,f,0],te,null,!0);for(let o=0;o<2;++o){let l=new c.LineSegments(K,te);l.position.set(t,0,o===0?s:a),l.xyboxid=3,l.bottom=o===0,F.add(l),l=new c.LineSegments(K,te),l.position.set(n,0,o===0?s:a),l.xyboxid=1,l.bottom=o===0,F.add(l)}let U=T(this.z_handle),le=ee([0,0,s,0,0,a],U,null,!0);for(let o=0;o<4;++o){let l=new c.LineSegments(le,U);l.zboxid=Z[o].zid,l.position.copy(Z[o].position),F.add(l)}}function _t(e,h,i){e=this.x_handle.gr(e),h=this.y_handle.gr(h),i=this.z_handle.gr(i);let r=new c.Vector3().set(e,h,i);r.project(this.camera),r.x=(r.x+1)/2,r.y=(r.y+1)/2;let t=this.getPadPainter(),n=t?.getPadWidth(),d=t?.getPadHeight();return n&&d&&(r.x=(this.scene_x+r.x*this.scene_width)/n,r.y=(this.scene_y+r.y*this.scene_height)/d),r}function kt(e){Object.assign(e,{create3DScene:ht,add3DMesh:dt,remove3DMeshes:ct,render3D:mt,resize3D:ft,change3DCamera:lt,highlightBin3D:xt,set3DOptions:gt,drawXYZ:ut,convert3DtoPadNDC:_t})}function it(e){if(e.faceIndex<0||e.faceIndex>=this.face_to_bins_index.length)return null;let h=this.painter,i=this.handle,r=h.getFramePainter(),t=h.getHisto(),n=h.get3DToolTip(this.face_to_bins_index[e.faceIndex]),d=Math.min(r.size_x3d,Math.max(-r.size_x3d,i.grx[n.ix-1]+i.xbar1*(i.grx[n.ix]-i.grx[n.ix-1]))),f=Math.min(r.size_x3d,Math.max(-r.size_x3d,i.grx[n.ix-1]+i.xbar2*(i.grx[n.ix]-i.grx[n.ix-1]))),s=Math.min(r.size_y3d,Math.max(-r.size_y3d,i.gry[n.iy-1]+i.ybar1*(i.gry[n.iy]-i.gry[n.iy-1]))),a=Math.min(r.size_y3d,Math.max(-r.size_y3d,i.gry[n.iy-1]+i.ybar2*(i.gry[n.iy]-i.gry[n.iy-1])));n.x1=Math.min(d,f),n.x2=Math.max(d,f),n.y1=Math.min(s,a),n.y2=Math.max(s,a);let u=this.baseline,P=n.value;return t.$baseh&&(u=t.$baseh.getBinContent(n.ix,n.iy)),P<u&&([u,P]=[P,u]),n.z1=r.grz(Math.max(this.zmin,u)),n.z2=r.grz(Math.min(this.zmax,P)),n.color=this.tip_color,n.$painter=h,n.$projection=h.is_projection&&h.getDimension()===2,n}function Lt(e,h=!1){if(!e.draw_content)return;let i=xe.Vertices,r=xe.Indexes,t=xe.Normals,n=xe.Segments,d=[0,1,1,2,2,3,3,0],f=[new c.Vector3(0,0,0),new c.Vector3(0,1,0),new c.Vector3(1,1,0),new c.Vector3(1,0,0)],s=e.getFramePainter(),a=e.prepareDraw({rounding:!1,use3d:!0,extra:1}),u=e.options.cutg,P=a.i1,M=a.i2,A=a.j1,v=a.j2,S=e.getHisto(),w=S.$baseh,z=e.options.Lego===11||e.options.Lego===13,R=S.getBin(M,v)<65535;if(P>=M||A>=v)return;let j,y,_,x,D,B,T,p,F,E,L,G=s.z_handle.getScaleMin(),H=s.z_handle.getScaleMax(),oe=(N,se,te)=>(p=S.getBinContent(N+1,se+1),w?T=w.getBinContent(N+1,se+1):e.options.BaseLine!==!1?T=e.options.BaseLine:T=e.options.Zero?G:0,p<T&&([T,p]=[p,T]),T>=y||p<j||u&&!u.IsInside(S.fXaxis.GetBinCoord(N+.5),S.fYaxis.GetBinCoord(se+.5))?!1:(F=p===j||T>=p,!F||te>0?!0:w?!1:e.options.Zero||G>0?!0:e.options.ShowEmpty)),J=[G,H],W=null;(e.options.Lego===12||e.options.Lego===14)&&(h?(W=s.getHistPalette(),e.createContour(s,W,{full_z_range:!0}),J=W.getContour(),G=J.at(0),H=J.at(-1)):(J=e.createContour(S.fContour?S.fContour.length:20,s.lego_zmin,s.lego_zmax).arr,W=e.getHistPalette()));for(let N=0;N<J.length-1;++N){j=J[N],y=J[N+1],W&&N===J.length-2&&y<H&&(y=H);let se=s.grz(j),te=s.grz(y),K=0,U=0;for(_=P;_<M;++_)for(x=A;x<v;++x)oe(_,x,N)&&(E=!F&&N>0,L=!F&&p>y&&N<J.length-2,K+=F?12:r.length,E&&(K-=6),L&&(K-=6),z&&!F&&(K-=12,U+=12));let le=new Float32Array(K*3),o=new Float32Array(K*3),l=R?new Uint16Array(K/3):new Uint32Array(K/3),m=U===0?null:new Float32Array(U*3),C=U===0?null:new Float32Array(U*3),g=U===0?null:R?new Uint16Array(U/3):new Uint32Array(U/3),k=0,I=0,b;for(_=P;_<M;++_){let X=a.grx[_]+a.xbar1*(a.grx[_+1]-a.grx[_]),fe=a.grx[_]+a.xbar2*(a.grx[_+1]-a.grx[_]);for(x=A;x<v;++x){if(!oe(_,x,N))continue;E=!F&&N>0,L=!F&&p>y&&N<J.length-2;let _e=a.gry[x]+a.ybar1*(a.gry[x+1]-a.gry[x]),ie=a.gry[x]+a.ybar2*(a.gry[x+1]-a.gry[x]),be=T<=j?se:s.grz(T),pe=p>y?te:s.grz(p);b=0,D=0,F&&(b+=12,D+=24);let Fe=S.getBin(_+1,x+1),Te=r.length;for(E&&(Te-=6);D<Te;)B=i[r[D]],z&&D<12?(m[I]=X+B.x*(fe-X),m[I+1]=_e+B.y*(ie-_e),m[I+2]=be+B.z*(pe-be),C[I]=t[b],C[I+1]=t[b+1],C[I+2]=t[b+2],I%9===0&&(g[I/9]=Fe),I+=3):(le[k]=X+B.x*(fe-X),le[k+1]=_e+B.y*(ie-_e),le[k+2]=be+B.z*(pe-be),o[k]=t[b],o[k+1]=t[b+1],o[k+2]=t[b+2],k%9===0&&(l[k/9]=Fe),k+=3),++D,D%6===0&&(b+=3,L&&D===r.length-12&&(D+=6,b+=3))}}let q=ve(e,le,o),V=h?3:S.fFillColor,Y=e.getColor(V);W?Y=h?W.getColor(N):W.calcColor(N,J.length):(e.options.Lego===1||V<2)&&(V=1,Y="white");let re=new c.MeshBasicMaterial(ne(Y,{vertexColors:!1})),O=new c.Mesh(q,re);if(O.face_to_bins_index=l,O.painter=e,O.zmin=G,O.zmax=H,O.baseline=e.options.BaseLine!==!1?e.options.BaseLine:e.options.Zero?G:0,O.tip_color=V===3?16711680:65280,O.handle=a,O.tooltip=it,s.add3DMesh(O),U>0){let X=ve(e,m,C),fe=new c.Color(V<2?16711680:Oe(Y).darker(.5).toString()),_e=new c.MeshBasicMaterial({color:fe,vertexColors:!1}),ie=new c.Mesh(X,_e);ie.face_to_bins_index=g,ie.painter=e,ie.handle=O.handle,ie.tooltip=it,ie.zmin=O.zmin,ie.zmax=O.zmax,ie.baseline=O.baseline,ie.tip_color=O.tip_color,s.add3DMesh(ie)}}if(e.options.Lego>12)return;let $=0,ce=0;for(y=H,j=G,_=P;_<M;++_)for(x=A;x<v;++x)oe(_,x,0)&&($+=F?f.length:i.length,ce+=F?d.length:n.length);let ge=$<=65520;ge||($=ce*3);let ae=new Float32Array($*3),he=ge?new Uint16Array(ce):null,me=s.grz(G),we=s.grz(H),Q=0,Me=0;for(_=P;_<M;++_){let N=a.grx[_]+a.xbar1*(a.grx[_+1]-a.grx[_]),se=a.grx[_]+a.xbar2*(a.grx[_+1]-a.grx[_]);for(x=A;x<v;++x){if(!oe(_,x,0))continue;let te=a.gry[x]+a.ybar1*(a.gry[x+1]-a.gry[x]),K=a.gry[x]+a.ybar2*(a.gry[x+1]-a.gry[x]),U=T<=G?me:s.grz(T),le=p>H?we:s.grz(p),o=F?d:n,l=F?f:i;if(ge){for(D=0;D<o.length;++D)he[Me++]=Q/3+o[D];for(D=0;D<l.length;++D)B=l[D],ae[Q]=N+B.x*(se-N),ae[Q+1]=te+B.y*(K-te),ae[Q+2]=U+B.z*(le-U),Q+=3}else for(D=0;D<o.length;++D)B=l[o[D]],ae[Q]=N+B.x*(se-N),ae[Q+1]=te+B.y*(K-te),ae[Q+2]=U+B.z*(le-U),Q+=3}}let ke=h?e.v7EvalColor("line_color","lightblue"):e.getColor(S.fLineColor),Z=new c.LineBasicMaterial(ne(ke,{linewidth:h?e.v7EvalAttr("line_width",1):S.fLineWidth})),ue=ee(Ce(e,ae),Z,ge?he:null);s.add3DMesh(ue)}function zt(e){let h=Math.floor(e.index/6);if(h<0||h>=this.intersect_index.length)return null;let i=this.painter,r=i.getHisto(),t=i.getFramePainter(),n=i.get3DToolTip(this.intersect_index[h]),d=Math.min(t.size_x3d,Math.max(-t.size_x3d,t.grx(r.fXaxis.GetBinLowEdge(n.ix)))),f=Math.min(t.size_x3d,Math.max(-t.size_x3d,t.grx(r.fXaxis.GetBinLowEdge(n.ix+1)))),s=Math.min(t.size_y3d,Math.max(-t.size_y3d,t.gry(r.fYaxis.GetBinLowEdge(n.iy)))),a=Math.min(t.size_y3d,Math.max(-t.size_y3d,t.gry(r.fYaxis.GetBinLowEdge(n.iy+1))));return n.x1=Math.min(d,f),n.x2=Math.max(d,f),n.y1=Math.min(s,a),n.y2=Math.max(s,a),n.z1=t.grz(n.value-n.error<this.zmin?this.zmin:n.value-n.error),n.z2=t.grz(n.value+n.error>this.zmax?this.zmax:n.value+n.error),n.color=this.tip_color,n}function Pt(e,h=!1){let i=e.getFramePainter(),r=e.getHisto(),t=e.prepareDraw({rounding:!1,use3d:!0,extra:1}),n=i.z_handle.getScaleMin(),d=i.z_handle.getScaleMax(),f=e.options.cutg,s,a,u,P,M,A,v,S,w,z,R,j=0,y=null,_=null,x=0,D=()=>e.options.Zero||n>0?!1:!e.options.ShowEmpty;for(let F=0;F<2;++F){for(s=t.i1;s<t.i2;++s)for(A=t.grx[s],S=t.grx[s+1],a=t.j1;a<t.j2;++a)if(P=r.getBinContent(s+1,a+1),!(P<n||P>d)&&!(P===n&&D())&&!(f&&!f.IsInside(r.fXaxis.GetBinCoord(s+.5),r.fYaxis.GetBinCoord(a+.5)))){if(F===0){j+=3;continue}u=r.getBin(s+1,a+1),M=e.getBinErrors(r,u,P),_[x/18]=u,v=t.gry[a],w=t.gry[a+1],z=i.grz(P-M.low<n?n:P-M.low),R=i.grz(P+M.up>d?d:P+M.up),y[x]=A,y[x+3]=S,y[x+1]=y[x+4]=(v+w)/2,y[x+2]=y[x+5]=(z+R)/2,x+=6,y[x]=y[x+3]=(A+S)/2,y[x+1]=v,y[x+4]=w,y[x+2]=y[x+5]=(z+R)/2,x+=6,y[x]=y[x+3]=(A+S)/2,y[x+1]=y[x+4]=(v+w)/2,y[x+2]=z,y[x+5]=R,x+=6}if(F===0){if(j===0)return;y=new Float32Array(j*6),_=new Int32Array(j/3)}}let B=h?e.v7EvalColor("line_color","lightblue"):e.getColor(r.fLineColor),T=new c.LineBasicMaterial(ne(B,{linewidth:h?e.v7EvalAttr("line_width",1):r.fLineWidth})),p=ee(y,T);p.painter=e,p.intersect_index=_,p.zmin=n,p.zmax=d,p.tip_color=r.fLineColor===3?16711680:65280,p.tooltip=zt,i.add3DMesh(p)}function yt(e,h=!1,i=!1){let r=e.getFramePainter(),t=e.prepareDraw({rounding:!1,use3d:!0,extra:100,middle:0}),n=e.getHisto(),d=e.getContourLevels(),f=e.getHistPalette(),s=[],a=2*r.size_z3d;Se(n,t,d,f,(P,M,A,v,S,w)=>{if(!(S-v<3)&&!(h&&(a=r.grz(d[w]),a<0||a>2*r.size_z3d)))for(let z=v;z<S;++z)s.push(M[z],A[z],a),s.push(M[z+1],A[z+1],a)});let u=ee(s,Ke(e,i?"line_":n));r.add3DMesh(u)}function St(e,h=!1){let i=e.getHisto(),r=e.getFramePainter(),t=r.z_handle.getScaleMin(),n=r.logz?M=>M<t?-.1:r.grz(M):r.grz,d=0,f=2*r.size_z3d,s=e.prepareDraw({rounding:!1,use3d:!0,extra:1,middle:.5,cutg:de(e.options?.cutg?.IsInside)?e.options?.cutg:null});if(s.i2-s.i1<2||s.j2-s.j1<2)return;let a=null,u=null,P=null;if(s.dolines=!0,h){let M=0;switch(e.options.Surf){case 11:M=2;break;case 12:case 15:case 17:M=2,s.dolines=!1;break;case 14:s.dolines=!1,s.donormals=!0;break;case 16:M=1,s.dogrid=!0,s.dolines=!1;break;default:a=r.z_handle.createTicks(!0),s.dogrid=!0;break}M>0&&(P=r.getHistPalette(),M===2&&e.createContour(r,P,{full_z_range:!0}),a=P.getContour())}else switch(e.options.Surf){case 11:a=e.getContourLevels(),P=e.getHistPalette();break;case 12:case 15:case 17:a=e.getContourLevels(),P=e.getHistPalette(),s.dolines=!1;break;case 14:s.dolines=!1,s.donormals=!0;break;case 16:a=e.getContourLevels(),s.dogrid=!0,s.dolines=!1;break;default:a=r.z_handle.createTicks(!0),s.dogrid=!0;break}if(a){u=new Float32Array(a.length);for(let M=0;M<a.length;++M)u[M]=n(a[M])}else u=[d,f];if(s.grz=n,s.grz_min=d,s.grz_max=f,tt(i,s,a,(M,A,v)=>{let S=ve(e,A,null,s.i2-s.i1,s.j2-s.j1),w=S.getAttribute("normal").array;if(s.donormals&&M===1)for(let y=s.i1;y<s.i2;++y)for(let _=s.j1;_<s.j2;++_){let x=((y-s.i1)*(s.j2-s.j1)+(_-s.j1))*8;if(v[x]===-1)continue;let D=v[x]>=0?x:x+9+v[x],B=x+8,T=0,p=0,F=0;for(let E=D;E<B;++E){let L=v[E];if(L<0)return console.error("FAILURE in NORMALS RECALCULATIONS");T+=w[L],p+=w[L+1],F+=w[L+2]}T/=B-D,p/=B-D,F/=B-D;for(let E=D;E<B;++E){let L=v[E];w[L]=T,w[L+1]=p,w[L+2]=F}}let z,R;if(h)z=P?.getColor(M-1)??e.getColor(5);else if(P)z=P.calcColor(M,u.length);else{let y=e.options.histoFillColor||i.fFillColor;e.options.Surf===13?z="white":e.options.Surf===14?z=y>1?e.getColor(y):"grey":z=y>1?e.getColor(y):"white"}z||(z="white"),e.options.Surf===14?R=new c.MeshLambertMaterial(ne(z,{side:c.DoubleSide,vertexColors:!1})):R=new c.MeshBasicMaterial(ne(z,{side:c.DoubleSide,vertexColors:!1}));let j=new c.Mesh(S,R);r.add3DMesh(j),j.painter=e},(M,A)=>{let v=e.getColor(i.fLineColor)??"white",S;M?S=e.options.Surf===1?new c.LineDashedMaterial({color:0,dashSize:2,gapSize:2}):new c.LineBasicMaterial(ne(v)):S=new c.LineBasicMaterial(ne(v,{linewidth:i.fLineWidth}));let w=ee(Ce(e,A,s.i2-s.i1,s.j2-s.j1),S);w.painter=e,r.add3DMesh(w)}),e.options.Surf===17&&yt(e,!1,h),e.options.Surf===13){s=e.prepareDraw({rounding:!1,use3d:!0,extra:100,middle:0});let M=e.getContourLevels(),A=e.getHistPalette(),v=-1,S=f;Se(i,s,M,A,(w,z,R,j,y)=>{if(z[y]===z[j]&&R[y]===R[j]&&y--,y-j<3)return;let _=[];for(let L=j;L<=y;++L)(L===j||z[L]!==z[L-1]||R[L]!==R[L-1])&&_.push(new c.Vector2(z[L],R[L]));if(_.length<3)return;let x=c.ShapeUtils.triangulateShape(_,[]);if(!x||x.length===0)return;(v<0||v!==w)&&(v=w,S+=5e-5*f);let D=new Float32Array(x.length*9),B=new Float32Array(x.length*9),T=0;for(let L=0;L<x.length;++L){let G=x[L];for(let H=0;H<3;++H){let oe=_[G[H]];D[T]=oe.x,D[T+1]=oe.y,D[T+2]=S,B[T]=0,B[T+1]=0,B[T+2]=1,T+=3}}let p=ve(e,D,B,s.i2-s.i1,s.j2-s.j1),F=new c.MeshBasicMaterial(ne(A.getColor(w),{side:c.DoubleSide,opacity:.5,vertexColors:!1})),E=new c.Mesh(p,F);E.painter=e,r.add3DMesh(E)})}}export{Ce as a,ve as b,kt as c,Lt as d,Pt as e,yt as f,St as g};
