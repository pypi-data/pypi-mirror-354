import{a as gt,c as dt}from"./chunk-C4APR3G7.js";import{c as xt}from"./chunk-LGENSGLC.js";import{h as ht}from"./chunk-YC5SGHGH.js";import{a as v,n as rt,o as O,q as at}from"./chunk-FYXTN3X2.js";import{b as lt}from"./chunk-Z4ZYSIRC.js";import{c as ft}from"./chunk-3L3RRFVB.js";import{H as U,J as ot}from"./chunk-FVXVO67X.js";import{Ta as et,Wa as it,Za as nt,f as J,fb as st,t as Q,u as N,x as tt}from"./chunk-KYOHYQWH.js";import{k as V}from"./chunk-KYPE3LET.js";var mt=class ut extends ht{getDimension(){return 3}scanContent(t){if(t&&this.nbinsx&&this.nbinsy&&this.nbinsz)return;let i=this.getHisto();this.extractAxesProperties(3),this.gminbin=this.gmaxbin=i.getBinContent(1,1,1),this.gminposbin=null;for(let e=0;e<this.nbinsx;++e)for(let s=0;s<this.nbinsy;++s)for(let l=0;l<this.nbinsz;++l){let r=i.getBinContent(e+1,s+1,l+1);r<this.gminbin?this.gminbin=r:r>this.gmaxbin&&(this.gmaxbin=r),r>0&&(this.gminposbin===null||this.gminposbin>r)&&(this.gminposbin=r)}this.gminposbin===null&&this.gmaxbin>0&&(this.gminposbin=this.gmaxbin*1e-4),this.draw_content=this.gmaxbin!==0||this.gminbin!==0,this.transferFunc=this.findFunction(et,"TransferFunction"),this.transferFunc?.SetBit(tt(9),!0)}countStat(t,i){let e=this.getHisto(),s=e.fXaxis,l=e.fYaxis,r=e.fZaxis,c=this.getSelectIndex("x","left"),z=this.getSelectIndex("x","right"),h=this.getSelectIndex("y","left"),a=this.getSelectIndex("y","right"),o=this.getSelectIndex("z","left"),k=this.getSelectIndex("z","right"),I=this.getFramePainter(),n={name:e.fName,entries:0,eff_entries:0,integral:0,meanx:0,meany:0,meanz:0,rmsx:0,rmsy:0,rmsz:0,skewx:0,skewy:0,skewz:0,skewd:0,kurtx:0,kurty:0,kurtz:0,kurtd:0},G=Math.abs(e.fTsumw)>1e-300&&!I.isAxisZoomed("x")&&!I.isAxisZoomed("y")&&!I.isAxisZoomed("z"),p,w,S,L,A,T,D,P,F,_,M=0,C=0,R=0,H=0,K=0,q=0,f=0,x=0;for(J(t)||(t=null),p=0;p<this.nbinsx+2;++p)for(L=s.GetBinCoord(p-.5),A=p<c?0:p>z?2:1,w=0;w<this.nbinsy+2;++w)for(T=l.GetBinCoord(w-.5),D=w<h?0:w>a?2:1,S=0;S<this.nbinsz+2;++S)P=r.GetBinCoord(S-.5),F=S<o?0:S>k?2:1,!(t&&!t(L,T,P))&&(_=e.getBinContent(p,w,S),n.entries+=_,!G&&A===1&&D===1&&F===1&&(M+=_,C+=_*_,R+=L*_,H+=T*_,K+=P*_,q+=L**2*_,f+=T**2*_,x+=P**2*_));if(G&&(M=e.fTsumw,C=e.fTsumw2,R=e.fTsumwx,q=e.fTsumwx2,H=e.fTsumwy,f=e.fTsumwy2,K=e.fTsumwz,x=e.fTsumwz2),Math.abs(M)>1e-300&&(n.meanx=R/M,n.meany=H/M,n.meanz=K/M,n.rmsx=Math.sqrt(Math.abs(q/M-n.meanx*n.meanx)),n.rmsy=Math.sqrt(Math.abs(f/M-n.meany*n.meany)),n.rmsz=Math.sqrt(Math.abs(x/M-n.meanz*n.meanz))),n.integral=M,e.fEntries>0&&(n.entries=e.fEntries),n.eff_entries=C?M*M/C:Math.abs(M),i&&!this.isTH2Poly()){let B=0,b=0,g=0,m=0,u=0,y=0,d=0;for(p=c;p<z;++p)for(L=s.GetBinCoord(p+.5),w=h;w<a;++w)for(T=l.GetBinCoord(w+.5),S=o;S<k;++S){if(P=r.GetBinCoord(S+.5),t&&!t(L,T,P))continue;let Y=e.getBinContent(p+1,w+1,S+1);d+=Y,B+=Y*Math.pow(L-n.meanx,3),b+=Y*Math.pow(T-n.meany,3),g+=Y*Math.pow(P-n.meany,3),m+=Y*Math.pow(L-n.meanx,4),u+=Y*Math.pow(T-n.meany,4),y+=Y*Math.pow(T-n.meany,4)}let $=Math.pow(n.rmsx,3),j=Math.pow(n.rmsy,3),E=Math.pow(n.rmsz,3),Z=Math.pow(n.rmsx,4),X=Math.pow(n.rmsy,4),W=Math.pow(n.rmsz,4);d*$!==0&&(n.skewx=B/(d*$)),d*j!==0&&(n.skewy=b/(d*j)),d*E!==0&&(n.skewz=g/(d*E)),n.skewd=n.eff_entries>0?Math.sqrt(6/n.eff_entries):0,d*Z!==0&&(n.kurtx=m/(d*Z)-3),d*X!==0&&(n.kurty=u/(d*X)-3),d*W!==0&&(n.kurtz=y/(d*W)-3),n.kurtd=n.eff_entries>0?Math.sqrt(24/n.eff_entries):0}return n}fillStatistic(t,i,e){if(this.isIgnoreStatsFill())return!1;i===1&&(i=1111);let s=i%10,l=Math.floor(i/10)%10,r=Math.floor(i/100)%10,c=Math.floor(i/1e3)%10,z=Math.floor(i/1e6)%10,h=Math.floor(i/1e7)%10,a=Math.floor(i/1e8)%10,o=this.countStat(void 0,h>0||a>0);return t.clearPave(),s>0&&t.addText(o.name),l>0&&t.addText("Entries = "+t.format(o.entries,"entries")),r>0&&(t.addText("Mean x = "+t.format(o.meanx)),t.addText("Mean y = "+t.format(o.meany)),t.addText("Mean z = "+t.format(o.meanz))),c>0&&(t.addText("Std Dev x = "+t.format(o.rmsx)),t.addText("Std Dev y = "+t.format(o.rmsy)),t.addText("Std Dev z = "+t.format(o.rmsz))),z>0&&t.addText("Integral = "+t.format(o.integral,"entries")),h===2?(t.addText(`Skewness x = ${t.format(o.skewx)} #pm ${t.format(o.skewd)}`),t.addText(`Skewness y = ${t.format(o.skewy)} #pm ${t.format(o.skewd)}`),t.addText(`Skewness z = ${t.format(o.skewz)} #pm ${t.format(o.skewd)}`)):h>0&&(t.addText(`Skewness x = ${t.format(o.skewx)}`),t.addText(`Skewness y = ${t.format(o.skewy)}`),t.addText(`Skewness z = ${t.format(o.skewz)}`)),a===2?(t.addText(`Kurtosis x = ${t.format(o.kurtx)} #pm ${t.format(o.kurtd)}`),t.addText(`Kurtosis y = ${t.format(o.kurty)} #pm ${t.format(o.kurtd)}`),t.addText(`Kurtosis z = ${t.format(o.kurtz)} #pm ${t.format(o.kurtd)}`)):a>0&&(t.addText(`Kurtosis x = ${t.format(o.kurtx)}`),t.addText(`Kurtosis y = ${t.format(o.kurty)}`),t.addText(`Kurtosis z = ${t.format(o.kurtz)}`)),e&&t.fillFunctionStat(this.findFunction(it),e,3),!0}getBinTooltips(t,i,e){let s=[],l=this.getHisto();s.push(this.getObjectHint(),`x = ${this.getAxisBinTip("x",l.fXaxis,t)}  xbin=${t+1}`,`y = ${this.getAxisBinTip("y",l.fYaxis,i)}  ybin=${i+1}`,`z = ${this.getAxisBinTip("z",l.fZaxis,e)}  zbin=${e+1}`);let r=l.getBinContent(t+1,i+1,e+1);if(r===Math.round(r)?s.push(`entries = ${r}`):s.push(`entries = ${U(r,N.fStatFormat)}`),this.matchObjectType(nt)){let c=l.getBinError(l.getBin(t+1,i+1,e+1));s.push("error = "+(c===Math.round(c)?c.toString():U(c,N.fPaintTextFormat)))}return s}draw3DScatter(){let t=this.getObject(),i=this.getFramePainter(),e=this.getSelectIndex("x","left",.5),s=this.getSelectIndex("x","right",0),l=this.getSelectIndex("y","left",.5),r=this.getSelectIndex("y","right",0),c=this.getSelectIndex("z","left",.5),z=this.getSelectIndex("z","right",0),h,a,o,k;if(s<=e||r<=l||z<=c)return Promise.resolve(!0);let I=this.gmaxbin>1e3?1e3/this.gmaxbin:1,n=Math.max(0,this.gminbin),G=0,p=0;for(h=e;h<s;++h)for(a=l;a<r;++a)for(o=c;o<z;++o)k=t.getBinContent(h+1,a+1,o+1),p+=k,!(k<=n)&&(G+=Math.round(k*I));if(G>(i.webgl?1e5:3e4))return!1;let w=new at(G,i.webgl,i.size_x3d/200),S=new Int32Array(G),L=new ot(p),A=0;for(h=e;h<s;++h)for(a=l;a<r;++a)for(o=c;o<z;++o){if(k=t.getBinContent(h+1,a+1,o+1),k<=n)continue;let T=Math.round(k*I);for(let D=0;D<T;++D){let P=t.fXaxis.GetBinCoord(h+L.random()),F=t.fYaxis.GetBinCoord(a+L.random()),_=t.fZaxis.GetBinCoord(o+L.random());S[A++]=t.getBin(h+1,a+1,o+1),w.addPoint(i.grx(P),i.gry(F),i.grz(_))}}return w.createPoints({color:this.getColor(t.fMarkerColor)}).then(T=>(i.add3DMesh(T),T.bins=S,T.painter=this,T.tip_color=t.fMarkerColor===3?16711680:65280,T.tooltip=function(D){let P=Math.floor(D.index/this.nvertex);if(P<0||P>=this.bins.length)return null;let F=this.painter,_=F.getHisto(),M=F.getFramePainter(),C=F.get3DToolTip(this.bins[P]);return C.x1=M.grx(_.fXaxis.GetBinLowEdge(C.ix)),C.x2=M.grx(_.fXaxis.GetBinLowEdge(C.ix+1)),C.y1=M.gry(_.fYaxis.GetBinLowEdge(C.iy)),C.y2=M.gry(_.fYaxis.GetBinLowEdge(C.iy+1)),C.z1=M.grz(_.fZaxis.GetBinLowEdge(C.iz)),C.z2=M.grz(_.fZaxis.GetBinLowEdge(C.iz+1)),C.color=this.tip_color,C.opacity=.3,C},!0))}draw3DBins(){return V(this,null,function*(){if(!this.draw_content)return!1;let t=this.options.BoxStyle;if(!t&&this.options.Scat){let f=this.draw3DScatter();if(f!==!1)return f;t=12}else!t&&!this.options.GLBox&&!this.options.GLColor&&!this.options.Lego&&(t=12);let i=this.getHisto(),e=this.getFramePainter(),s=!1,l=!1,r=!1,c=1,z=-1,h=this.getPadPainter()?.getRootPad()?.fLogv,a=!0,o=0,k=this.getColor(i.fFillColor),I=.5,n;if(!t&&this.options.Lego&&(t=this.options.Lego===1?10:this.options.Lego),this.options.GLBox===11||this.options.GLBox===12)I=.4,s=!0,this.options.GLBox===12&&(r=!0),n=new v.SphereGeometry(.5,e.webgl?16:8,e.webgl?12:6),n.applyMatrix4(new v.Matrix4().makeRotationX(Math.PI/2)),n.computeVertexNormals();else{let f=O.Indexes,x=O.Normals,B=O.Vertices,b=f.length*3,g=new Float32Array(b),m=new Float32Array(b);for(let u=0,y=-3;u<f.length;++u){let d=B[f[u]];g[u*3]=d.x-.5,g[u*3+1]=d.y-.5,g[u*3+2]=d.z-.5,u%6===0&&(y+=3),m[u*3]=x[y],m[u*3+1]=x[y+1],m[u*3+2]=x[y+2]}l=!0,t===12?r=!0:t===13?(r=!0,l=!1):this.options.GLColor&&(r=!0,c=.5,a=!1,l=!1,z=0,s=!0),n=new v.BufferGeometry,n.setAttribute("position",new v.BufferAttribute(g,3)),n.setAttribute("normal",new v.BufferAttribute(m,3))}this._box_option=t,a&&h?this.gminposbin&&this.gmaxbin>this.gminposbin?(o=Math.log(this.gminposbin)-.1,a=1/(Math.log(this.gmaxbin)-o)):(h=0,a=1):a&&(a=this.gminbin||this.gmaxbin?1/Math.max(Math.abs(this.gminbin),Math.abs(this.gmaxbin)):1);let G=f=>{if(z>=0&&f<z)return 0;if(!a)return 1;if(h){if(f<=0)return 0;f=Math.log(f)-o}return Math.pow(Math.abs(f*a),.3333)},p=this.getSelectIndex("x","left",.5),w=this.getSelectIndex("x","right",0),S=this.getSelectIndex("y","left",.5),L=this.getSelectIndex("y","right",0),A=this.getSelectIndex("z","left",.5),T=this.getSelectIndex("z","right",0);if(w<=p||L<=S||T<=A)return!1;let D=r?this.getContour():null,P=r?this.getHistPalette():null,F=[],_=[],M=[],C=[],R=[],H=this.transferFunc&&gt(this.transferFunc,!0)?this.transferFunc:null;for(let f=p;f<w;++f){let x=e.grx(i.fXaxis.GetBinLowEdge(f+1)),B=e.grx(i.fXaxis.GetBinLowEdge(f+2));for(let b=S;b<L;++b){let g=e.gry(i.fYaxis.GetBinLowEdge(b+1)),m=e.gry(i.fYaxis.GetBinLowEdge(b+2));for(let u=A;u<T;++u){let y=i.getBinContent(f+1,b+1,u+1);if(!this.options.GLColor&&(y===0||y<this.gminbin))continue;let d=G(y);if(d<.001)continue;if(r){let Z=D.getPaletteIndex(P,y);if(Z===null)continue;if(_.push(this._color_palette.getColor(Z)),H){let X=dt(H,y,!1)*3;R.push(!X||X<0?0:X>1?1:X)}}let $=e.grz(i.fZaxis.GetBinLowEdge(u+1)),j=e.grz(i.fZaxis.GetBinLowEdge(u+2));M.push(i.getBin(f+1,b+1,u+1));let E=new v.Matrix4;E.scale(new v.Vector3((B-x)*d,(m-g)*d,(j-$)*d)),E.setPosition((B+x)/2,(m+g)/2,(j+$)/2),F.push(E),y<0&&C.push(E)}}}function K(f){let x=this.binid;if(x===void 0){if(f.instanceId===void 0||f.instanceId>=this.bins.length)return;x=this.bins[f.instanceId]}let B=this.painter,b=B.getHisto(),g=B.getFramePainter(),m=B.get3DToolTip(x),u=g.grx(b.fXaxis.GetBinCoord(m.ix-1)),y=g.grx(b.fXaxis.GetBinCoord(m.ix)),d=g.gry(b.fYaxis.GetBinCoord(m.iy-1)),$=g.gry(b.fYaxis.GetBinCoord(m.iy)),j=g.grz(b.fZaxis.GetBinCoord(m.iz-1)),E=g.grz(b.fZaxis.GetBinCoord(m.iz)),Z=this.get_weight(m.value)*this.tipscale;return m.x1=(y+u)/2-(y-u)*Z,m.x2=(y+u)/2+(y-u)*Z,m.y1=($+d)/2-($-d)*Z,m.y2=($+d)/2+($-d)*Z,m.z1=(E+j)/2-(E-j)*Z,m.z2=(E+j)/2+(E-j)*Z,m.color=this.tip_color,m}if(r&&(H||c!==1))for(let f=0;f<F.length;++f){let x=H?R[f]:c,B=new v.Color(_[f]),b=s?new v.MeshLambertMaterial({color:B,opacity:x,transparent:x<1,vertexColors:!1}):new v.MeshBasicMaterial({color:B,opacity:x,transparent:x<1,vertexColors:!1}),g=new v.Mesh(n,b);g.applyMatrix4(F[f]),g.painter=this,g.binid=M[f],g.tipscale=I,g.tip_color=i.fFillColor===3?16711680:65280,g.get_weight=G,g.tooltip=K,e.add3DMesh(g)}else{r&&(k=new v.Color(1,1,1));let f=s?new v.MeshLambertMaterial({color:k,vertexColors:!1}):new v.MeshBasicMaterial({color:k,vertexColors:!1}),x=new v.InstancedMesh(n,f,F.length);for(let B=0;B<F.length;++B)x.setMatrixAt(B,F[B]),r&&x.setColorAt(B,new v.Color(_[B]));x.painter=this,x.bins=M,x.tipscale=I,x.tip_color=i.fFillColor===3?16711680:65280,x.get_weight=G,x.tooltip=K,e.add3DMesh(x)}if(l){let x=function(B,b){if(!b)return;let g=new Float32Array(b.length*B.length*3);for(let m=0,u=0;m<b.length;++m){let y=b[m].elements;for(let d=0;d<B.length;++d,u+=3){let $=O.Vertices[B[d]];g[u]=y[12]+($.x-.5)*y[0],g[u+1]=y[13]+($.y-.5)*y[5],g[u+2]=y[14]+($.z-.5)*y[10]}}e.add3DMesh(rt(g,f))};var q=x;let f=new v.LineBasicMaterial({color:this.getColor(i.fLineColor)});x(O.Segments,F),x(O.Crosses,C)}return!0})}redraw(t){return V(this,null,function*(){let i=this.getFramePainter(),e=this.getHisto(),s=Promise.resolve(!0),l=!0;if(t==="resize"){let r=i.resize3D();r!==1&&(l=!1,r&&i.render3D())}return l&&(xt(i),s=i.create3DScene(this.options.Render3D,this.options.x3dscale,this.options.y3dscale,this.options.Ortho).then(()=>(i.setAxesRanges(e.fXaxis,this.xmin,this.xmax,e.fYaxis,this.ymin,this.ymax,e.fZaxis,this.zmin,this.zmax,this),i.set3DOptions(this.options),i.drawXYZ(i.toplevel,ft,{ndim:3,hist_painter:this,zoom:Q.Zooming,draw:this.options.Axis!==-1,drawany:this.options.isCartesian()}),this.draw3DBins())).then(()=>{i.render3D(),this.updateStatWebCanvas(),i.addKeysHandler()})),this.isMainPainter()&&(s=s.then(()=>this.drawColorPalette(this.options.Zscale&&(this._box_option===12||this._box_option===13||this.options.GLBox===12)))),s.then(()=>this.updateFunctions()).then(()=>this.updateHistTitle()).then(()=>this)})}fillToolbar(){let t=this.getPadPainter();t&&(t.addPadButton("auto_zoom","Unzoom all axes","ToggleZoom","Ctrl *"),this.draw_content&&t.addPadButton("statbox","Toggle stat box","ToggleStatBox"),t.addPadButton("th2colorz","Toggle color palette","ToggleColorZ"),t.showPadButtons())}canZoomInside(t,i,e){let s=this.getHisto();return s&&(s=s[`f${t.toUpperCase()}axis`]),!s||s.FindBin(e,.5)-s.FindBin(i,0)>1}autoZoom(){let t=this.getSelectIndex("x","left"),i=this.getSelectIndex("x","right"),e=this.getSelectIndex("y","left"),s=this.getSelectIndex("y","right"),l=this.getSelectIndex("z","left"),r=this.getSelectIndex("z","right"),c=this.getObject(),z,h,a;if(t===i||e===s||l===r)return;let o=c.getBinContent(t+1,e+1,l+1);for(z=t;z<i;++z)for(h=e;h<s;++h)for(a=l;a<r;++a)o=Math.min(o,c.getBinContent(z+1,h+1,a+1));if(o>0)return;let k=i,I=t,n=s,G=e,p=r,w=l;for(z=t;z<i;++z)for(h=e;h<s;++h)for(a=l;a<r;++a)c.getBinContent(z+1,h+1,a+1)>o&&(z<k&&(k=z),z>=I&&(I=z+1),h<n&&(n=h),h>=G&&(G=h+1),a<p&&(p=a),a>=w&&(w=a+1));let S,L,A,T,D,P,F=!1;if(k===I-1&&k>t+1&&I<i-1&&(k--,I++),n===G-1&&n>e+1&&G<s-1&&(n--,G++),p===w-1&&p>l+1&&w<r-1&&(p--,w++),(k>t||I<i)&&k<I-1&&(S=c.fXaxis.GetBinLowEdge(k+1),L=c.fXaxis.GetBinLowEdge(I+1),F=!0),(n>e||G<s)&&n<G-1&&(A=c.fYaxis.GetBinLowEdge(n+1),T=c.fYaxis.GetBinLowEdge(G+1),F=!0),(p>l||w<r)&&p<w-1&&(D=c.fZaxis.GetBinLowEdge(p+1),P=c.fZaxis.GetBinLowEdge(w+1),F=!0),F)return this.getFramePainter().zoom(S,L,A,T,D,P)}fillHistContextMenu(t){let i=this.getSupportedDrawOptions();t.addDrawMenu("Draw with",i,e=>{if(e.indexOf(st)===0)return this.showInspector(e);this.decodeOptions(e),this.interactiveRedraw(!0,"drawopt")})}static draw(t,i,e){return V(this,null,function*(){let s=new ut(t,i);return s.mode3d=!0,lt(s,"3d").then(()=>(s.setAsMainPainter(),s.decodeOptions(e),s.checkPadRange(),s.scanContent(),s.createStat(),s.redraw())).then(()=>s.drawFunctions()).then(()=>(s.fillToolbar(),s))})}};export{mt as a};
