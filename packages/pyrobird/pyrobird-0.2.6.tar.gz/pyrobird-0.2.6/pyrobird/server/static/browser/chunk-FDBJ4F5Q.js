import{a as R}from"./chunk-TDJROOWO.js";import{b as I}from"./chunk-O2YOIZWS.js";import"./chunk-C4APR3G7.js";import{a as F}from"./chunk-4U5XXNS7.js";import"./chunk-LGENSGLC.js";import{d as z}from"./chunk-LWQ6XHU3.js";import"./chunk-YC5SGHGH.js";import"./chunk-FYXTN3X2.js";import"./chunk-D3GAWKNQ.js";import"./chunk-K2P6CES6.js";import{b as E}from"./chunk-Z4ZYSIRC.js";import"./chunk-3L3RRFVB.js";import{I as $,ha as D,pa as T}from"./chunk-FVXVO67X.js";import{Ma as S,Oa as b,Qa as Y,U as P,db as c,eb as _,ib as L,jb as N,kb as B,u as v,x as C,y as X}from"./chunk-KYOHYQWH.js";import{k as l}from"./chunk-KYPE3LET.js";var W=C(16),H=class k extends D{constructor(r,i,e){super(r,i,e),this.firstpainter=null,this.painters=[]}cleanup(){this.getPadPainter()?.cleanPrimitives(r=>r===this.firstpainter||this.painters.indexOf(r)>=0),delete this.firstpainter,delete this.painters,super.cleanup()}buildStack(r,i){if(this.fStack=null,!r.fHists)return!1;let e=r.fHists.arr.length;if(e<=0)return!1;let n=i?.findInPrimitives(void 0,P);if(n?.arr.length===e&&n?.name===r.fName)return this.fStack=n,!0;n=L(P);let t=X(r.fHists.arr[0]);n.arr.push(t);for(let s=1;s<e;++s){let a=X(r.fHists.arr[s]),f=a.fXaxis,o=t.fXaxis,m=f.fNbins===o.fNbins&&f.fXmin===o.fXmin&&f.fXmax===o.fXmax;if(!m&&f.fNbins>0&&f.fNbins<o.fNbins&&f.fXmin===o.fXmin&&Math.abs((f.fXmax-f.fXmin)/f.fNbins-(o.fXmax-o.fXmin)/o.fNbins)<1e-4){let h=new Array(t.fNcells).fill(0);for(let p=1;p<=f.fNbins;++p)h[p]=a.fArray[p];a.fNcells=t.fNcells,Object.assign(f,o),a.fArray=h,m=!0}if(!m)return console.warn(`When drawing THStack, cannot sum-up histograms ${a.fName} and ${t.fName}`),!1;for(let h=0;h<a.fArray.length;++h)a.fArray[h]+=t.fArray[h];n.arr.push(a),t=a}return this.fStack=n,!0}getMinMax(r){let i=this.getObject(),e=this.getPadPainter()?.getRootPad(!0),n=e?.fLogv??(this.options.ndim===1?e?.fLogy:e?.fLogz),t=0,s=0,a=(o,m)=>{let h={min:0,max:0},p=!0,w=!0;if(o.fMinimum!==c&&(h.min=o.fMinimum,p=!1),o.fMaximum!==c&&(h.max=o.fMaximum,w=!1),!p&&!w)return h;let y=1,A=o.fXaxis.fNbins,j=1,M=1,O=!0;o.fXaxis.TestBit(T.kAxisRange)&&(y=o.fXaxis.fFirst,A=o.fXaxis.fLast),o._typename.indexOf(b)===0&&(M=o.fYaxis.fNbins,o.fYaxis.TestBit(T.kAxisRange)&&(j=o.fYaxis.fFirst,M=o.fYaxis.fLast));let d=0;for(let x=j;x<=M;++x)for(let g=y;g<=A;++g){let u=o.getBinContent(g,x);m&&(d=o.getBinError(o.getBin(g,x))),!(n&&u-d<=0)&&(p&&(O||u-d<h.min)&&(h.min=u-d),w&&(O||u+d>h.max)&&(h.max=u+d),O=!1)}return h};if(this.options.nostack)for(let o=0;o<i.fHists.arr.length;++o){let m=a(i.fHists.arr[o],r);o===0?(t=m.min,s=m.max):(t=Math.min(t,m.min),s=Math.max(s,m.max))}else t=a(this.fStack.arr.at(0),r).min,s=a(this.fStack.arr.at(-1),r).max;n?t=t>0?t*.9:s*.001:t>0&&(t=0),i.fMaximum!==c&&(s=i.fMaximum),i.fMinimum!==c&&(t=i.fMinimum),(!this.options.nostack||i.fMaximum===c)&&(n?t>0&&(s*=1+.2*Math.log10(s/t)):i.fMaximum===c&&(s*=1+v.fHistTopMargin)),(!this.options.nostack||i.fMinimum===c)&&n&&(t=t>0?t/(1+.5*Math.log10(s/t)):.001*s);let f={min:t,max:s,hopt:`;hmin:${t};hmax:${s}`};return i.fHistogram?.TestBit(W)&&(f.hopt+=";zoom_min_max"),f}getHistDrawOption(r,i){let e=i||r.fOption||this.options.hopt;if(e.toUpperCase().indexOf(this.options.hopt)<0&&(e+=" "+this.options.hopt),this.options.draw_errors&&!e&&(e="E"),this.options.zscale){let n=e.toUpperCase().indexOf("COLZ");n>=0&&(e=e.slice(0,n+3)+e.slice(n+4))}return this.options.pads||(e+=" same nostat"+this.options.auto),e}drawNextHisto(r,i){return l(this,null,function*(){let e=this.getObject(),n=this.options.nostack?e.fHists:this.fStack,t=n?.arr?.length||0;if(r>=t)return this;let s=this.options.horder?r:t-r-1,a=this.options.nostack?`hists_${s}`:`stack_${s}`,f=n.arr[s],o=this.getHistDrawOption(f,e.fHists.opt[s]);if(i){let m=i.getSubPadPainter(r+1);return m?(m.cleanPrimitives(!0),this.drawHist(m,f,o).then(h=>(h&&(h.setSecondaryId(this,a),this.painters.push(h)),this.drawNextHisto(r+1,i)))):this}return s>0&&!this.options.nostack&&(f.$baseh=n.arr[s-1]),this.options.auto&&(f.$num_histos=t),this.drawHist(this.getPadPainter(),f,o).then(m=>(m.setSecondaryId(this,a),this.painters.push(m),this.drawNextHisto(r+1,i)))})}decodeOptions(r){this.options||(this.options={}),Object.assign(this.options,{ndim:1,nostack:!1,same:!1,horder:!0,has_errors:!1,draw_errors:!1,hopt:"",auto:""});let i=this.getObject(),e=i.fHistogram||(i.fHists?i.fHists.arr[0]:null)||(this.fStack?this.fStack.arr[0]:null),n=a=>{let f=a.fSumw2?.length??0;for(let o=0;o<f;++o)if(a.fSumw2[o]>0)return!0;return!1};if(e?._typename.indexOf(b)===0&&(this.options.ndim=2),this.options.ndim===2&&!r&&(r="lego1"),i.fHists&&!this.options.nostack)for(let a=0;a<i.fHists.arr.length;++a)this.options.has_errors=this.options.has_errors||n(i.fHists.arr[a]);this.options.nhist=i.fHists?.arr?.length??1;let t=new $(r);this.options.nostack=t.check("NOSTACK"),t.check("STACK")&&(this.options.nostack=!1),this.options.same=t.check("SAME"),t.check("NOCLEAR"),["PFC","PLC","PMC"].forEach(a=>{t.check(a)&&(this.options.auto+=" "+a)}),this.options.pads=t.check("PADS"),this.options.pads&&(this.options.nostack=!0),this.options.hopt=t.remain().trim();let s=t.check("LEGO");this.options.errors=t.check("E"),this.options.zscale=t.check("COLZ"),!this.options.nostack&&this.options.has_errors&&!s&&!t.check("HIST")&&this.options.hopt.indexOf("E")<0&&(this.options.draw_errors=!0),this.options.horder=this.options.nostack||s}createHistogram(r){let i=r.fHists,e=i?i.arr.length:0;if(!e){let s=N(S,100);return B(s,r.fTitle),s.fBits|=_,s}let n=i.arr[0],t=N(this.options.ndim===1?S:Y,n.fXaxis.fNbins,n.fYaxis.fNbins);t.fName="axis_hist",t.fBits|=_,Object.assign(t.fXaxis,n.fXaxis),this.options.ndim===2&&Object.assign(t.fYaxis,n.fYaxis);for(let s=1;s<e;++s){let a=i.arr[s];t.fXaxis.fLabels||(t.fXaxis.fXmin=Math.min(t.fXaxis.fXmin,a.fXaxis.fXmin),t.fXaxis.fXmax=Math.max(t.fXaxis.fXmax,a.fXaxis.fXmax)),this.options.ndim===2&&!t.fYaxis.fLabels&&(t.fYaxis.fXmin=Math.min(t.fYaxis.fXmin,a.fYaxis.fXmin),t.fYaxis.fXmax=Math.max(t.fYaxis.fXmax,a.fYaxis.fXmax))}return t.fTitle=r.fTitle,t}updateObject(r){if(!this.matchObjectType(r))return!1;let i=this.getObject(),e=this.getPadPainter();if(i.fHists=r.fHists,i.fTitle=r.fTitle,i.fMinimum=r.fMinimum,i.fMaximum=r.fMaximum,this.options.nostack||(this.options.nostack=!this.buildStack(i,e)),this.firstpainter){let s=r.fHistogram;s||(s=i.fHistogram=this.createHistogram(i));let a=this.getMinMax(this.options.errors||this.options.draw_errors);this.firstpainter.options.hmin=a.min,this.firstpainter.options.hmax=a.max,this.firstpainter._checked_zooming=!1,this.options.ndim===1?(this.firstpainter.ymin=a.min,this.firstpainter.ymax=a.max):(this.firstpainter.zmin=a.min,this.firstpainter.zmax=a.max),this.firstpainter.updateObject(s),this.firstpainter.options.zoom_min_max=s.TestBit(W)}let n=this.options.nostack?i.fHists:this.fStack,t=n?.arr?.length??0;if(t!==this.painters.length)this.did_update=1,e?.cleanPrimitives(s=>this.painters.indexOf(s)>=0),this.painters=[];else{this.did_update=2;for(let s=0;s<t;++s){let a=this.options.horder?s:t-s-1,f=n.arr[a];this.painters[s].updateObject(f,this.getHistDrawOption(f,i.fHists.opt[a]))}}return!0}redraw(r){if(!this.did_update)return;let i=this.did_update===1;delete this.did_update;let e=Promise.resolve(this);if(this.firstpainter){let n=this.getMinMax(this.options.errors||this.options.draw_errors);this.firstpainter.decodeOptions(this.options.hopt+n.hopt),e=this.firstpainter.redraw(r)}return e.then(()=>{if(i)return this.drawNextHisto(0,this.options.pads?this.getPadPainter():null);let n=t=>t>=this.painters.length?this:this.painters[t].redraw(r).then(()=>n(t+1));return n(0)})}fillContextMenuItems(r){r.addRedrawMenu(this),this.options.pads||r.addchk(this.options.draw_errors,"Draw errors",i=>{this.options.draw_errors=i;let e=this.getObject(),n=this.options.nostack?e.fHists:this.fStack,t=n?.arr?.length??0;for(let s=0;s<t;++s){let a=this.options.horder?s:t-s-1,f=n.arr[a];this.painters[s].decodeOptions(this.getHistDrawOption(f,e.fHists.opt[a]))}this.redrawPad()},"Change draw erros in the stack")}drawHist(r,i,e){return(this.options.ndim===1?I.draw:z.draw)(r,i,e)}accessMM(r,i){let e=r?"fMinimum":"fMaximum",n=this.getObject();if(i===void 0)return n[e];this.did_update=2,n[e]=i,this.interactiveRedraw("pad",r?`exec:SetMinimum(${i})`:`exec:SetMaximum(${i})`)}redrawWith(r,i){return l(this,null,function*(){let e=this.getPadPainter();!i&&e&&(this.firstpainter=null,this.painters=[],this.options.pads&&e.divide(0,0),e.removePrimitive(this,!0)),this.decodeOptions(r);let n=this.getObject(),t=Promise.resolve(this),s=null;if(this.options.pads)t=E(this,!1).then(()=>(s=this.getPadPainter(),s.divide(this.options.nhist,0,!0)));else if(this.options.nostack||(this.options.nostack=!this.buildStack(n,e)),!this.options.same&&n.fHists?.arr.length){n.fHistogram||(n.fHistogram=this.createHistogram(n));let a=this.getMinMax(this.options.errors||this.options.draw_errors);t=this.drawHist(this.getDrawDom(),n.fHistogram,this.options.hopt+a.hopt).then(f=>{this.firstpainter=f,f.$stack_hist=!0,f.setSecondaryId(this,"hist")})}return t.then(()=>this.drawNextHisto(0,s)).then(()=>(this.options.pads||this.addToPadPrimitives(),this))})}static draw(r,i,e){return l(this,null,function*(){return!i.fHists||!i.fHists.arr?null:new k(r,i,e).redrawWith(e,!0)})}};var Z=class k extends H{drawHist(r,i,e){return(this.options.ndim===1?R.draw:F.draw)(r,i,e)}static draw(r,i,e){return l(this,null,function*(){return!i.fHists||!i.fHists.arr?null:new k(r,i,e).redrawWith(e,!0)})}};export{Z as THStackPainter};
