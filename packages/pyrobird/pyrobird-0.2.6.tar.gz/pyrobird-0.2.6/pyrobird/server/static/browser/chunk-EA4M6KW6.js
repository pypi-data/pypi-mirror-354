import{a as st}from"./chunk-IUDBKFPS.js";import{a as rt}from"./chunk-IHC2TKNY.js";import{a as nt}from"./chunk-7MTENYBP.js";import{b as et,f as it}from"./chunk-MGNYDHM4.js";import{c as tt}from"./chunk-LGENSGLC.js";import"./chunk-LWQ6XHU3.js";import"./chunk-YC5SGHGH.js";import{a as C,n as Q,o as Z,q as W}from"./chunk-FYXTN3X2.js";import"./chunk-D3GAWKNQ.js";import"./chunk-K2P6CES6.js";import"./chunk-Z4ZYSIRC.js";import"./chunk-3L3RRFVB.js";import{H as Y,J}from"./chunk-FVXVO67X.js";import{db as N,fb as K,t as U,u as X}from"./chunk-KYOHYQWH.js";import{k as O}from"./chunk-KYPE3LET.js";var V=class $ extends nt{getDimension(){return 3}scanContent(t){if(t&&this.nbinsx&&this.nbinsy&&this.nbinsz)return;let e=this.getHisto();if(e){if(this.extractAxesProperties(3),this.isDisplayItem())this.gminbin=e.fContMin,this.gminposbin=e.fContMinPos>0?e.fContMinPos:null,this.gmaxbin=e.fContMax;else{this.gminbin=this.gmaxbin=e.getBinContent(1,1,1);for(let i=0;i<this.nbinsx;++i)for(let r=0;r<this.nbinsy;++r)for(let l=0;l<this.nbinsz;++l){let s=e.getBinContent(i+1,r+1,l+1);s<this.gminbin?this.gminbin=s:s>this.gmaxbin&&(this.gmaxbin=s)}}this.draw_content=this.gmaxbin!==0||this.gminbin!==0}}countStat(){let t=this.getHisto(),e=this.getAxis("x"),i=this.getAxis("y"),r=this.getAxis("z"),l=this.getSelectIndex("x","left"),s=this.getSelectIndex("x","right"),B=this.getSelectIndex("y","left"),h=this.getSelectIndex("y","right"),d=this.getSelectIndex("z","left"),g=this.getSelectIndex("z","right"),b={name:t.fName,entries:0,integral:0,meanx:0,meany:0,meanz:0,rmsx:0,rmsy:0,rmsz:0},c=0,A=0,k=0,u=0,p=0,y=0,D=0,M,v,w,E,T,I,F,P,j,z;for(M=1;M<=this.nbinsx;++M)for(E=e.GetBinCoord(M-.5),T=M<=l+1?0:M>s+1?2:1,v=1;v<=this.nbinsy;++v)for(I=i.GetBinCoord(v-.5),F=v<=B+1?0:v>h+1?2:1,w=1;w<=this.nbinsz;++w)P=r.GetBinCoord(w-.5),j=w<=d+1?0:w>g+1?2:1,z=t.getBinContent(M,v,w),b.entries+=z,T===1&&F===1&&j===1&&(c+=z,A+=E*z,k+=I*z,u+=P*z,p+=E**2*z,y+=I**2*z,D+=P**2*z);return Math.abs(c)>1e-300&&(b.meanx=A/c,b.meany=k/c,b.meanz=u/c,b.rmsx=Math.sqrt(Math.abs(p/c-b.meanx**2)),b.rmsy=Math.sqrt(Math.abs(y/c-b.meany**2)),b.rmsz=Math.sqrt(Math.abs(D/c-b.meanz**2))),b.integral=c,b}fillStatistic(t,e){let i=this.countStat(),r=e%10,l=Math.floor(e/10)%10,s=Math.floor(e/100)%10,B=Math.floor(e/1e3)%10,h=Math.floor(e/1e6)%10;return t.clearStat(),r>0&&t.addText(i.name),l>0&&t.addText("Entries = "+t.format(i.entries,"entries")),s>0&&(t.addText("Mean x = "+t.format(i.meanx)),t.addText("Mean y = "+t.format(i.meany)),t.addText("Mean z = "+t.format(i.meanz))),B>0&&(t.addText("Std Dev x = "+t.format(i.rmsx)),t.addText("Std Dev y = "+t.format(i.rmsy)),t.addText("Std Dev z = "+t.format(i.rmsz))),h>0&&t.addText("Integral = "+t.format(i.integral,"entries")),!0}getBinTooltips(t,e,i){let r=[],l=this.getHisto(),s=1,B=1,h=1;this.isDisplayItem()&&(s=l.stepx||1,B=l.stepy||1,h=l.stepz||1),r.push(this.getObjectHint(),`x = ${this.getAxisBinTip("x",t,s)}  xbin=${t+1}`,`y = ${this.getAxisBinTip("y",e,B)}  ybin=${e+1}`,`z = ${this.getAxisBinTip("z",i,h)}  zbin=${i+1}`);let d=l.getBinContent(t+1,e+1,i+1),g="entries = "+(s>1||B>1||h>1?"~":"");return d===Math.round(d)?r.push(g+d):r.push(g+Y(d,X.fStatFormat)),r}draw3DScatter(t){return O(this,null,function*(){let e=this.getHisto(),i=this.getFramePainter(),r=t.i1,l=t.i2,s=t.stepi,B=t.j1,h=t.j2,d=t.stepj,g=t.k1,b=t.k2,c=t.stepk;if(l<=r||h<=B||b<=g)return!0;let A=this.gmaxbin>1e3?1e3/this.gmaxbin:1,k=Math.max(0,this.gminbin),u,p,y,D,M=0,v=0;for(u=r;u<l;u+=s)for(p=B;p<h;p+=d)for(y=g;y<b;y+=c)D=e.getBinContent(u+1,p+1,y+1),v+=D,!(D<=k)&&(M+=Math.round(D*A));if(M>(i.webgl?1e5:3e4))return!1;let w=new W(M,i.webgl,i.size_x3d/200),E=new Int32Array(M),T=this.getAxis("x"),I=this.getAxis("y"),F=this.getAxis("z"),P=new J(v),j=0;for(u=r;u<l;u+=s)for(p=B;p<h;p+=d)for(y=g;y<b;y+=c){if(D=e.getBinContent(u+1,p+1,y+1),D<=k)continue;let z=Math.round(D*A);for(let x=0;x<z;++x){let o=T.GetBinCoord(u+P.random()),a=I.GetBinCoord(p+P.random()),f=F.GetBinCoord(y+P.random());E[j++]=e.getBin(u+1,p+1,y+1),w.addPoint(i.grx(o),i.gry(a),i.grz(f))}}return w.createPoints({color:this.v7EvalColor("fill_color","red")}).then(z=>(i.add3DMesh(z),z.bins=E,z.painter=this,z.tip_color=65280,z.tooltip=function(x){let o=Math.floor(x.index/this.nvertex);if(o<0||o>=this.bins.length)return null;let a=this.painter,f=a.getFramePainter(),n=a.get3DToolTip(this.bins[o]);return n.x1=f.grx(a.getAxis("x").GetBinLowEdge(n.ix)),n.x2=f.grx(a.getAxis("x").GetBinLowEdge(n.ix+s)),n.y1=f.gry(a.getAxis("y").GetBinLowEdge(n.iy)),n.y2=f.gry(a.getAxis("y").GetBinLowEdge(n.iy+d)),n.z1=f.grz(a.getAxis("z").GetBinLowEdge(n.iz)),n.z2=f.grz(a.getAxis("z").GetBinLowEdge(n.iz+c)),n.color=this.tip_color,n.opacity=.3,n},!0))})}draw3DBins(t){let e=this.getFramePainter(),i=this.v7EvalColor("fill_color","red"),r=!1,l=!1,s=!1,B=1,h=!0,d=.5,g;if(this.options.Sphere)d=.4,r=!0,this.options.Sphere===11&&(s=!0),g=new C.SphereGeometry(.5,e.webgl?16:8,e.webgl?12:6),g.applyMatrix4(new C.Matrix4().makeRotationX(Math.PI/2)),g.computeVertexNormals();else{let x=Z.Indexes,o=Z.Normals,a=Z.Vertices,f=x.length*3,n=new Float32Array(f),G=new Float32Array(f);for(let m=0,_=-3;m<x.length;++m){let S=a[x[m]];n[m*3]=S.x-.5,n[m*3+1]=S.y-.5,n[m*3+2]=S.z-.5,m%6===0&&(_+=3),G[m*3]=o[_],G[m*3+1]=o[_+1],G[m*3+2]=o[_+2]}l=!0,this.options.Box===11?s=!0:this.options.Box===12?(s=!0,l=!1):this.options.Color&&(s=!0,B=.5,h=!1,l=!1,r=!0),g=new C.BufferGeometry,g.setAttribute("position",new C.BufferAttribute(n,3)),g.setAttribute("normal",new C.BufferAttribute(G,3))}h&&(h=this.gminbin||this.gmaxbin?1/Math.max(Math.abs(this.gminbin),Math.abs(this.gmaxbin)):1);let b=this.getHisto(),c=t.i1,A=t.i2,k=t.stepi,u=t.j1,p=t.j2,y=t.stepj,D=t.k1,M=t.k2,v=t.stepk,w=[],E=[],T=[],I=null;if(s&&(I=e.getHistPalette(),this.createContour(e,I)),A<=c||p<=u||M<=D)return!0;let F=this.getAxis("x"),P=this.getAxis("y"),j=this.getAxis("z");for(let x=c;x<A;x+=k){let o=e.grx(F.GetBinLowEdge(x+1)),a=e.grx(F.GetBinLowEdge(x+2));for(let f=u;f<p;f+=y){let n=e.gry(P.GetBinLowEdge(f+1)),G=e.gry(P.GetBinLowEdge(f+2));for(let m=D;m<M;m+=v){let _=b.getBinContent(x+1,f+1,m+1);if(!this.options.Color&&(_===0||_<this.gminbin))continue;let S=h?Math.pow(Math.abs(_*h),.3333):1;if(S<.001)continue;if(s){let q=I.getContourIndex(_);if(q<0)continue;E.push(I.getColor(q))}let H=e.grz(j.GetBinLowEdge(m+1)),R=e.grz(j.GetBinLowEdge(m+2));T.push(b.getBin(x+1,f+1,m+1));let L=new C.Matrix4;L.scale(new C.Vector3((a-o)*S,(G-n)*S,(R-H)*S)),L.setPosition((a+o)/2,(G+n)/2,(R+H)/2),w.push(L)}}}function z(x){let o=this.binid;if(o===void 0){if(x.instanceId===void 0||x.instanceId>=this.bins.length)return;o=this.bins[x.instanceId]}let a=this.painter,f=a.getFramePainter(),n=a.get3DToolTip(o),G=f.grx(F.GetBinCoord(n.ix-1)),m=f.grx(F.GetBinCoord(n.ix)),_=f.gry(P.GetBinCoord(n.iy-1)),S=f.gry(P.GetBinCoord(n.iy)),H=f.grz(j.GetBinCoord(n.iz-1)),R=f.grz(j.GetBinCoord(n.iz)),L=(this.use_scale?Math.pow(Math.abs(n.value*this.use_scale),.3333):1)*this.tipscale;return n.x1=(m+G)/2-(m-G)*L,n.x2=(m+G)/2+(m-G)*L,n.y1=(S+_)/2-(S-_)*L,n.y2=(S+_)/2+(S-_)*L,n.z1=(R+H)/2-(R-H)*L,n.z2=(R+H)/2+(R-H)*L,n.color=this.tip_color,n}if(s&&B!==1)for(let x=0;x<w.length;++x){let o=B,a=new C.Color(E[x]),f=r?new C.MeshLambertMaterial({color:a,opacity:o,transparent:o<1,vertexColors:!1}):new C.MeshBasicMaterial({color:a,opacity:o,transparent:o<1,vertexColors:!1}),n=new C.Mesh(g,f);n.applyMatrix4(w[x]),n.painter=this,n.binid=T[x],n.tipscale=d,n.tip_color=65280,n.use_scale=h,n.tooltip=z,e.add3DMesh(n)}else{s&&(i=new C.Color(1,1,1));let x=r?new C.MeshLambertMaterial({color:i,vertexColors:!1}):new C.MeshBasicMaterial({color:i,vertexColors:!1}),o=new C.InstancedMesh(g,x,w.length);for(let a=0;a<w.length;++a)o.setMatrixAt(a,w[a]),s&&o.setColorAt(a,new C.Color(E[a]));o.painter=this,o.bins=T,o.tipscale=d,o.tip_color=65280,o.use_scale=h,o.tooltip=z,e.add3DMesh(o)}if(l){let x=Z.Segments,o=new Float32Array(w.length*Z.Segments.length*3),a=0;for(let G=0;G<w.length;++G){let m=w[G].elements;for(let _=0;_<x.length;++_,a+=3){let S=Z.Vertices[x[_]];o[a]=m[12]+(S.x-.5)*m[0],o[a+1]=m[13]+(S.y-.5)*m[5],o[a+2]=m[14]+(S.z-.5)*m[10]}}let f=new C.LineBasicMaterial({color:this.v7EvalColor("line_color","lightblue")}),n=Q(o,f);e.add3DMesh(n)}return s&&this.updatePaletteDraw(),!0}draw3D(){if(!this.draw_content)return!1;let t=this.prepareDraw({only_indexes:!0,extra:-.5,right_extra:-1});return(this.options.Scatter?this.draw3DScatter(t):Promise.resolve(!1)).then(i=>i||this.draw3DBins(t))}redraw(t){let e=this.getFramePainter();return t==="resize"?(e.resize3D()&&e.render3D(),this):(tt(e),e.create3DScene(this.options.Render3D).then(()=>(e.setAxesRanges(this.getAxis("x"),this.xmin,this.xmax,this.getAxis("y"),this.ymin,this.ymax,this.getAxis("z"),this.zmin,this.zmax),e.set3DOptions(this.options),e.drawXYZ(e.toplevel,et,{zoom:U.Zooming,ndim:3,draw:!0,v7:!0}),this.drawingBins(t))).then(()=>this.draw3D()).then(()=>(e.render3D(),e.addKeysHandler(),this)))}fillToolbar(){let t=this.getPadPainter();t&&(t.addPadButton("auto_zoom","Unzoom all axes","ToggleZoom","Ctrl *"),this.draw_content&&t.addPadButton("statbox","Toggle stat box","ToggleStatBox"),t.showPadButtons())}canZoomInside(t,e,i){let r=this.getHisto();return r&&(r=r["f"+t.toUpperCase()+"axis"]),!r||r.FindBin(i,.5)-r.FindBin(e,0)>1}autoZoom(){let t=this.getSelectIndex("x","left"),e=this.getSelectIndex("x","right"),i=this.getSelectIndex("y","left"),r=this.getSelectIndex("y","right"),l=this.getSelectIndex("z","left"),s=this.getSelectIndex("z","right"),B=this.getHisto(),h,d,g;if(t===e||i===r||l===s)return;let b=B.getBinContent(t+1,i+1,l+1);for(h=t;h<e;++h)for(d=i;d<r;++d)for(g=l;g<s;++g)b=Math.min(b,B.getBinContent(h+1,d+1,g+1));if(b>0)return;let c=e,A=t,k=r,u=i,p=s,y=l;for(h=t;h<e;++h)for(d=i;d<r;++d)for(g=l;g<s;++g)B.getBinContent(h+1,d+1,g+1)>b&&(h<c&&(c=h),h>=A&&(A=h+1),d<k&&(k=d),d>=u&&(u=d+1),g<p&&(p=g),g>=y&&(y=g+1));let D,M,v,w,E,T,I=!1;if(c===A-1&&c>t+1&&A<e-1&&(c--,A++),k===u-1&&k>i+1&&u<r-1&&(k--,u++),p===y-1&&p>l+1&&y<s-1&&(p--,y++),(c>t||A<e)&&c<A-1&&(D=this.getAxis("x").GetBinLowEdge(c+1),M=this.getAxis("x").GetBinLowEdge(A+1),I=!0),(k>i||u<r)&&k<u-1&&(v=this.getAxis("y").GetBinLowEdge(k+1),w=this.getAxis("y").GetBinLowEdge(u+1),I=!0),(p>l||y<s)&&p<y-1&&(E=this.getAxis("z").GetBinLowEdge(p+1),T=this.getAxis("z").GetBinLowEdge(y+1),I=!0),I)return this.getFramePainter().zoom(D,M,v,w,E,T)}fillHistContextMenu(t){let e=this.getSupportedDrawOptions();t.addDrawMenu("Draw with",e,i=>{if(i.indexOf(K)===0)return this.showInspector(i);this.decodeOptions(i),this.interactiveRedraw(!0,"drawopt")})}static draw(t,e){return O(this,null,function*(){let i=new $(t,e);return i.mode3d=!0,it(i,"3d").then(()=>{i.setAsMainPainter(),i.options={Box:0,Scatter:!1,Sphere:0,Color:!1,minimum:N,maximum:N,FrontBox:!1,BackBox:!1};let r=i.v7EvalAttr("kind",""),l=i.v7EvalAttr("sub",0),s=i.options;switch(r){case"box":s.Box=10+l;break;case"sphere":s.Sphere=10+l;break;case"col":s.Color=!0;break;case"scat":s.Scatter=!0;break;default:s.Box=10}return i.scanContent(),i.redraw()})})}};function ct($,t,e){return t?t.fAxes.length===1?st.draw($,t,e):t.fAxes.length===2?rt.draw($,t,e):t.fAxes.length===3?V.draw($,t,e):null:null}export{V as RH3Painter,ct as drawHistDisplayItem};
