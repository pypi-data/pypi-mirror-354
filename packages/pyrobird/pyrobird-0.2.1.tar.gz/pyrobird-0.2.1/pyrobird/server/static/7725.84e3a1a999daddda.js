"use strict";(self.webpackChunkfirebird=self.webpackChunkfirebird||[]).push([[7725],{7725:($,O,d)=>{d.r(O),d.d(O,{THStackPainter:()=>w});var x=d(467),h=d(6998),A=d(9041),k=d(675),y=d(2953),j=d(4571),C=d(9025);const T=(0,h.BIT)(16);class M extends k.JW{constructor(r,s,t){super(r,s,t),this.firstpainter=null,this.painters=[]}cleanup(){this.getPadPainter()?.cleanPrimitives(r=>r===this.firstpainter||this.painters.indexOf(r)>=0),delete this.firstpainter,delete this.painters,super.cleanup()}buildStack(r,s){if(this.fStack=null,!r.fHists)return!1;const t=r.fHists.arr.length;if(t<=0)return!1;let a=s?.findInPrimitives(void 0,h.clTObjArray);if(a?.arr.length===t&&a?.name===r.fName)return this.fStack=a,!0;a=(0,h.create)(h.clTObjArray);let i=(0,h.clone)(r.fHists.arr[0]);a.arr.push(i);for(let n=1;n<t;++n){const e=(0,h.clone)(r.fHists.arr[n]),f=e.fXaxis,o=i.fXaxis;let c=f.fNbins===o.fNbins&&f.fXmin===o.fXmin&&f.fXmax===o.fXmax;if(!c&&f.fNbins>0&&f.fNbins<o.fNbins&&f.fXmin===o.fXmin&&Math.abs((f.fXmax-f.fXmin)/f.fNbins-(o.fXmax-o.fXmin)/o.fNbins)<1e-4){const m=new Array(i.fNcells).fill(0);for(let p=1;p<=f.fNbins;++p)m[p]=e.fArray[p];e.fNcells=i.fNcells,Object.assign(f,o),e.fArray=m,c=!0}if(!c)return console.warn(`When drawing THStack, cannot sum-up histograms ${e.fName} and ${i.fName}`),!1;for(let m=0;m<e.fArray.length;++m)e.fArray[m]+=i.fArray[m];a.arr.push(e),i=e}return this.fStack=a,!0}getMinMax(r){const s=this.getObject(),t=this.getPadPainter()?.getRootPad(!0),a=t?.fLogv??(1===this.options.ndim?t?.fLogy:t?.fLogz);let i=0,n=0;const e=(o,c)=>{const m={min:0,max:0};let p=!0,P=!0;if(o.fMinimum!==h.kNoZoom&&(m.min=o.fMinimum,p=!1),o.fMaximum!==h.kNoZoom&&(m.max=o.fMaximum,P=!1),!p&&!P)return m;let S=1,b=o.fXaxis.fNbins,v=1,X=1,N=!0;o.fXaxis.TestBit(k.rb.kAxisRange)&&(S=o.fXaxis.fFirst,b=o.fXaxis.fLast),0===o._typename.indexOf(h.clTH2)&&(X=o.fYaxis.fNbins,o.fYaxis.TestBit(k.rb.kAxisRange)&&(v=o.fYaxis.fFirst,X=o.fYaxis.fLast));let l=0;for(let g=v;g<=X;++g)for(let H=S;H<=b;++H){const u=o.getBinContent(H,g);c&&(l=o.getBinError(o.getBin(H,g))),!(a&&u-l<=0)&&(p&&(N||u-l<m.min)&&(m.min=u-l),P&&(N||u+l>m.max)&&(m.max=u+l),N=!1)}return m};if(this.options.nostack)for(let o=0;o<s.fHists.arr.length;++o){const c=e(s.fHists.arr[o],r);0===o?(i=c.min,n=c.max):(i=Math.min(i,c.min),n=Math.max(n,c.max))}else i=e(this.fStack.arr.at(0),r).min,n=e(this.fStack.arr.at(-1),r).max;a?i=i>0?.9*i:.001*n:i>0&&(i=0),s.fMaximum!==h.kNoZoom&&(n=s.fMaximum),s.fMinimum!==h.kNoZoom&&(i=s.fMinimum),(!this.options.nostack||s.fMaximum===h.kNoZoom)&&(a?i>0&&(n*=1+.2*Math.log10(n/i)):s.fMaximum===h.kNoZoom&&(n*=1+h.gStyle.fHistTopMargin)),(!this.options.nostack||s.fMinimum===h.kNoZoom)&&a&&(i=i>0?i/(1+.5*Math.log10(n/i)):.001*n);const f={min:i,max:n,hopt:`;hmin:${i};hmax:${n}`};return s.fHistogram?.TestBit(T)&&(f.hopt+=";zoom_min_max"),f}getHistDrawOption(r,s){let t=s||r.fOption||this.options.hopt;return t.toUpperCase().indexOf(this.options.hopt)<0&&(t+=" "+this.options.hopt),this.options.draw_errors&&!t&&(t="E"),this.options.pads||(t+=" same nostat"+this.options.auto),t}drawNextHisto(r,s){var t=this;return(0,x.A)(function*(){const a=t.getObject(),i=t.options.nostack?a.fHists:t.fStack,n=i?.arr?.length||0;if(r>=n)return t;const e=t.options.horder?r:n-r-1,f=t.options.nostack?`hists_${e}`:`stack_${e}`,o=i.arr[e],c=t.getHistDrawOption(o,a.fHists.opt[e]);if(s){const m=s.getSubPadPainter(r+1);return m?(m.cleanPrimitives(!0),t.drawHist(m,o,c).then(p=>(p&&(p.setSecondaryId(t,f),t.painters.push(p)),t.drawNextHisto(r+1,s)))):t}return e>0&&!t.options.nostack&&(o.$baseh=i.arr[e-1]),t.options.auto&&(o.$num_histos=n),t.drawHist(t.getPadPainter(),o,c).then(m=>(m.setSecondaryId(t,f),t.painters.push(m),t.drawNextHisto(r+1,s)))})()}decodeOptions(r){this.options||(this.options={}),Object.assign(this.options,{ndim:1,nostack:!1,same:!1,horder:!0,has_errors:!1,draw_errors:!1,hopt:"",auto:""});const s=this.getObject(),t=s.fHistogram||(s.fHists?s.fHists.arr[0]:null)||(this.fStack?this.fStack.arr[0]:null),a=e=>{const f=e.fSumw2?.length??0;for(let o=0;o<f;++o)if(e.fSumw2[o]>0)return!0;return!1};if(0===t?._typename.indexOf(h.clTH2)&&(this.options.ndim=2),2===this.options.ndim&&!r&&(r="lego1"),s.fHists&&!this.options.nostack)for(let e=0;e<s.fHists.arr.length;++e)this.options.has_errors=this.options.has_errors||a(s.fHists.arr[e]);this.options.nhist=s.fHists?.arr?.length??1;const i=new A.nC(r);this.options.nostack=i.check("NOSTACK"),i.check("STACK")&&(this.options.nostack=!1),this.options.same=i.check("SAME"),i.check("NOCLEAR"),["PFC","PLC","PMC"].forEach(e=>{i.check(e)&&(this.options.auto+=" "+e)}),this.options.pads=i.check("PADS"),this.options.pads&&(this.options.nostack=!0),this.options.hopt=i.remain();const n=i.check("LEGO");this.options.errors=i.check("E"),!this.options.nostack&&this.options.has_errors&&!n&&!i.check("HIST")&&this.options.hopt.indexOf("E")<0&&(this.options.draw_errors=!0),this.options.horder=this.options.nostack||n}createHistogram(r){const s=r.fHists,t=s?s.arr.length:0;if(!t){const n=(0,h.createHistogram)(h.clTH1F,100);return(0,h.setHistogramTitle)(n,r.fTitle),n.fBits|=h.kNoStats,n}const a=s.arr[0],i=(0,h.createHistogram)(1===this.options.ndim?h.clTH1F:h.clTH2F,a.fXaxis.fNbins,a.fYaxis.fNbins);i.fName="axis_hist",i.fBits|=h.kNoStats,Object.assign(i.fXaxis,a.fXaxis),2===this.options.ndim&&Object.assign(i.fYaxis,a.fYaxis);for(let n=1;n<t;++n){const e=s.arr[n];i.fXaxis.fLabels||(i.fXaxis.fXmin=Math.min(i.fXaxis.fXmin,e.fXaxis.fXmin),i.fXaxis.fXmax=Math.max(i.fXaxis.fXmax,e.fXaxis.fXmax)),2===this.options.ndim&&!i.fYaxis.fLabels&&(i.fYaxis.fXmin=Math.min(i.fYaxis.fXmin,e.fYaxis.fXmin),i.fYaxis.fXmax=Math.max(i.fYaxis.fXmax,e.fYaxis.fXmax))}return i.fTitle=r.fTitle,i}updateObject(r){if(!this.matchObjectType(r))return!1;const s=this.getObject(),t=this.getPadPainter();if(s.fHists=r.fHists,s.fTitle=r.fTitle,s.fMinimum=r.fMinimum,s.fMaximum=r.fMaximum,this.options.nostack||(this.options.nostack=!this.buildStack(s,t)),this.firstpainter){let n=r.fHistogram;n||(n=s.fHistogram=this.createHistogram(s));const e=this.getMinMax(this.options.errors||this.options.draw_errors);this.firstpainter.options.hmin=e.min,this.firstpainter.options.hmax=e.max,this.firstpainter._checked_zooming=!1,1===this.options.ndim?(this.firstpainter.ymin=e.min,this.firstpainter.ymax=e.max):(this.firstpainter.zmin=e.min,this.firstpainter.zmax=e.max),this.firstpainter.updateObject(n),this.firstpainter.options.zoom_min_max=n.TestBit(T)}const a=this.options.nostack?s.fHists:this.fStack,i=a?.arr?.length??0;if(i!==this.painters.length)this.did_update=1,t?.cleanPrimitives(n=>this.painters.indexOf(n)>=0),this.painters=[];else{this.did_update=2;for(let n=0;n<i;++n){const e=this.options.horder?n:i-n-1,f=a.arr[e];this.painters[n].updateObject(f,this.getHistDrawOption(f,s.fHists.opt[e]))}}return!0}redraw(r){if(!this.did_update)return;const s=1===this.did_update;delete this.did_update;let t=Promise.resolve(this);if(this.firstpainter){const a=this.getMinMax(this.options.errors||this.options.draw_errors);this.firstpainter.decodeOptions(this.options.hopt+a.hopt),t=this.firstpainter.redraw(r)}return t.then(()=>{if(s)return this.drawNextHisto(0,this.options.pads?this.getPadPainter():null);const a=i=>i>=this.painters.length?this:this.painters[i].redraw(r).then(()=>a(i+1));return a(0)})}fillContextMenuItems(r){r.addRedrawMenu(this),this.options.pads||r.addchk(this.options.draw_errors,"Draw errors",s=>{this.options.draw_errors=s;const t=this.getObject(),a=this.options.nostack?t.fHists:this.fStack,i=a?.arr?.length??0;for(let n=0;n<i;++n){const e=this.options.horder?n:i-n-1;this.painters[n].decodeOptions(this.getHistDrawOption(a.arr[e],t.fHists.opt[e]))}this.redrawPad()},"Change draw erros in the stack")}drawHist(r,s,t){return(1===this.options.ndim?y.N.draw:j.AJ.draw)(r,s,t)}accessMM(r,s){const t=r?"fMinimum":"fMaximum",a=this.getObject();if(void 0===s)return a[t];this.did_update=2,a[t]=s,this.interactiveRedraw("pad",r?`exec:SetMinimum(${s})`:`exec:SetMaximum(${s})`)}redrawWith(r,s){var t=this;return(0,x.A)(function*(){const a=t.getPadPainter();!s&&a&&(t.firstpainter=null,t.painters=[],t.options.pads&&a.divide(0,0),a.removePrimitive(t,!0)),t.decodeOptions(r);const i=t.getObject();let n=Promise.resolve(t),e=null;if(t.options.pads)n=(0,C.ensureTCanvas)(t,!1).then(()=>(e=t.getPadPainter(),e.divide(t.options.nhist,0,!0)));else if(t.options.nostack||(t.options.nostack=!t.buildStack(i,a)),!t.options.same&&i.fHists?.arr.length){i.fHistogram||(i.fHistogram=t.createHistogram(i));const f=t.getMinMax(t.options.errors||t.options.draw_errors);n=t.drawHist(t.getDrawDom(),i.fHistogram,t.options.hopt+f.hopt).then(o=>{t.firstpainter=o,o.$stack_hist=!0,o.setSecondaryId(t,"hist")})}return n.then(()=>t.drawNextHisto(0,e)).then(()=>(t.options.pads||t.addToPadPrimitives(),t))})()}static draw(r,s,t){return(0,x.A)(function*(){return s.fHists&&s.fHists.arr?new M(r,s,t).redrawWith(t,!0):null})()}}var Y=d(1516),B=d(4149);class w extends M{drawHist(r,s,t){return(1===this.options.ndim?Y.TH1Painter.draw:B.TH2Painter.draw)(r,s,t)}static draw(r,s,t){return(0,x.A)(function*(){return s.fHists&&s.fHists.arr?new w(r,s,t).redrawWith(t,!0):null})()}}}}]);