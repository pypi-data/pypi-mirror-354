import{h as O,i as S,k as N,p as A,s as R,t as E}from"./chunk-3L3RRFVB.js";import{Da as G,e as y,la as z,na as L,oa as k,pa as B,ua as W,va as F,wa as U,xa as p}from"./chunk-FVXVO67X.js";import{A as m,C as b,Ea as P,J as j,d as M,f as d,g as x,ib as _,q as D,t as I,x as w}from"./chunk-KYOHYQWH.js";import{k as f}from"./chunk-KYPE3LET.js";var $=w(15),K=w(17),V=w(18),X=w(19),Y=w(23);function J(l,t,e){let s=new O(l,t);return s.addToPadPrimitives(),e==="3d"&&(s.mode3d=!0),s.redraw()}var v=class l extends E{constructor(t,e){super(t,e,!0),this._websocket=null,this.tooltip_allowed=I.Tooltip}cleanup(){this._changed_layout&&this.setLayoutKind("simple"),delete this._changed_layout,super.cleanup()}getCanvasName(){return this.getObjectName()}getLayoutKind(){let t=this.selectDom("origin");return(t.empty()?"":t.property("layout"))||"simple"}setLayoutKind(t,e){let s=this.selectDom("origin");s.empty()||(t||(t="simple"),s.property("layout",t),s.property("layout_selector",t!=="simple"&&e?e:null),this._changed_layout=t!=="simple")}changeLayout(t,e){return f(this,null,function*(){if(this.getLayoutKind()===t)return!0;let n=this.selectDom("origin"),i=n.select(".side_panel2"),r=[],o=n.select(".side_panel"),a=this.selectDom(),h;for(;a.node().firstChild;)r.push(a.node().removeChild(a.node().firstChild));if(o.empty()||k(o.node()),i.empty()||k(i.node()),this.setLayoutKind("simple"),n.html(""),t==="simple"){a=n;for(let c=0;c<r.length;++c)a.node().appendChild(r[c]);this.setLayoutKind(t),h=!0}else{let c=new N(n.node(),t);e===void 0&&(e=t.indexOf("vert")===0?0:1),a=y(c.getGridFrame(e)),a.classed("central_panel",!0).style("position","relative"),e===2?(o=y(c.getGridFrame(0)),o.classed("side_panel2",!0).style("position","relative"),o=y(c.getGridFrame(3)),o.classed("side_panel",!0).style("position","relative")):(o=y(c.getGridFrame(1-e)),o.classed("side_panel",!0).style("position","relative"));for(let g=0;g<r.length;++g)a.node().appendChild(r[g]);this.setLayoutKind(t,".central_panel"),n.property("mdi",null)}return L(a.node(),h),!0})}toggleProjection(t){return f(this,null,function*(){if(delete this.proj_painter,t&&(this.proj_painter={X:!1,Y:!1}),d(this.showUI5ProjectionArea))return this.showUI5ProjectionArea(t);let e="simple",s;switch(t){case"XY":e="projxy",s=2;break;case"X":case"bottom":e="vert2_31",s=0;break;case"Y":case"left":e="horiz2_13",s=1;break;case"top":e="vert2_13",s=1;break;case"right":e="horiz2_31",s=0;break}return this.changeLayout(e,s)})}drawProjection(t,e,s){return f(this,null,function*(){if(!this.proj_painter)return!1;if(s===void 0&&(s="hist"),t||(t="X"),this.proj_painter[t]){if(x(this.proj_painter[t]))return console.log("Not ready with first painting",t),!0}else{this.proj_painter[t]="init";let n=_(P),i=this.pad,r=this.getFramePainter(),o;return t==="X"?(n.fLeftMargin=i.fLeftMargin,n.fRightMargin=i.fRightMargin,n.fLogx=r.logx,n.fUxmin=r.logx?Math.log10(r.scale_xmin):r.scale_xmin,n.fUxmax=r.logx?Math.log10(r.scale_xmax):r.scale_xmax,o="fixframe"):t==="Y"&&(n.fBottomMargin=i.fBottomMargin,n.fTopMargin=i.fTopMargin,n.fLogx=r.logy,n.fUxmin=r.logy?Math.log10(r.scale_ymin):r.scale_ymin,n.fUxmax=r.logy?Math.log10(r.scale_ymax):r.scale_ymax,o="rotate"),n.fPrimitives.Add(e,s),(d(this.drawInUI5ProjectionArea)?this.drawInUI5ProjectionArea(n,o,t):this.drawInSidePanel(n,o,t)).then(h=>(this.proj_painter[t]=h,h))}return this.proj_painter[t].getMainPainter()?.updateObject(e,s),this.proj_painter[t].redrawPad()})}testUI5(){return this.use_openui??!1}drawInSidePanel(t,e,s){return f(this,null,function*(){let n=this.getLayoutKind()==="projxy"&&s==="Y"?".side_panel2":".side_panel",i=this.selectDom("origin").select(n);return i.empty()?null:this.drawObject(i.node(),t,e)})}showMessage(t){this.testUI5()||W(t,7e3)}saveCanvasAsFile(t){let e=t.indexOf(".");this.createImage(t.slice(e+1)).then(s=>this.sendWebsocket(`SAVE:${t}:${s}`))}sendSaveCommand(t){this.sendWebsocket("PRODUCE:"+t)}submitMenuRequest(t,e,s){return f(this,null,function*(){return new Promise(n=>{this._getmenu_callback=n,this.sendWebsocket("GETMENU:"+s)})})}submitExec(t,e,s){if(!(this._readonly||!t)&&(s||(s=t.snapid),s&&x(s)&&e))return this.sendWebsocket(`OBJEXEC:${s}:${e}`)}canSendWebSocket(){return this._websocket?.canSend()}sendWebsocket(t){return this._websocket?.canSend()?(this._websocket.send(t),!0):(console.warn(`DROP SEND: ${t}`),!1)}closeWebsocket(t){this._websocket&&(this._websocket.close(t),this._websocket.cleanup(),delete this._websocket)}useWebsocket(t){this.closeWebsocket(),this._websocket=t,this._websocket.setReceiver(this),this._websocket.connect()}websocketTimeout(t,e){if(!this._websocket)return;this._websocket._tmouts||(this._websocket._tmouts={});let s=this._websocket._tmouts[t];if(e===void 0)return s!==void 0;e==="reset"?s&&(clearTimeout(s),delete this._websocket._tmouts[t]):!s&&Number.isInteger(e)&&(this._websocket._tmouts[t]=setTimeout(()=>{delete this._websocket._tmouts[t]},e))}onWebsocketOpened(){}onWebsocketClosed(){this.embed_canvas||F()}onWebsocketMsg(t,e){if(e==="CLOSE")this.onWebsocketClosed(),this.closeWebsocket(!0);else if(e.slice(0,6)==="SNAP6:"){let s=e.indexOf(":",6),n=e.slice(6,s),i=m(e.slice(s+1));this.syncDraw(!0).then(()=>{this.snapid||this.resizeBrowser(i.fSnapshot.fWindowWidth,i.fSnapshot.fWindowHeight),!this.snapid&&d(this.setFixedCanvasSize)&&(this._online_fixed_size=this.setFixedCanvasSize(i.fSnapshot.fCw,i.fSnapshot.fCh,i.fFixedSize))}).then(()=>this.redrawPadSnap(i)).then(()=>{this.completeCanvasSnapDrawing();let r=this.getWebPadOptions();r&&(r=":"+r),t.send(`READY6:${n}${r}`),this.confirmDraw()}).catch(r=>{d(this.showConsoleError)?this.showConsoleError(r):console.log(r)})}else if(e.slice(0,5)==="MENU:"){let s=m(e.slice(5));d(this._getmenu_callback)&&(this._getmenu_callback(s),delete this._getmenu_callback)}else if(e.slice(0,4)==="CMD:"){e=e.slice(4);let s=e.indexOf(":"),n=e.slice(0,s),i=e.slice(s+1),r=`REPLY:${n}:`;i==="SVG"||i==="PNG"||i==="JPEG"||i==="WEBP"||i==="PDF"?this.createImage(i.toLowerCase()).then(o=>t.send(r+o)):(console.log(`Unrecognized command ${i}`),t.send(r))}else if(e.slice(0,7)==="DXPROJ:"||e.slice(0,7)==="DYPROJ:"){let s=e[1],n=m(e.slice(7));this.websocketTimeout(`proj${s}`,"reset"),this.drawProjection(s,n)}else if(e.slice(0,5)==="CTRL:"){let s=m(e.slice(5))||{},n=!1;if(s.title!==void 0&&typeof document<"u"&&(document.title=s.title),s.x&&s.y&&typeof window<"u"&&(window.moveTo(s.x,s.y),n=!0),s.w&&s.h&&(this.resizeBrowser(Number.parseInt(s.w),Number.parseInt(s.h)),n=!0),s.cw&&s.ch&&d(this.setFixedCanvasSize)&&(this._online_fixed_size=this.setFixedCanvasSize(Number.parseInt(s.cw),Number.parseInt(s.ch),!0),n=!0),["Menu","StatusBar","Editor","ToolBar","ToolTips"].forEach(r=>{s[r]!==void 0&&this.showSection(r,s[r]==="1")}),s.edit){let r=this.findSnap(s.edit);r&&this.showSection("Editor",!0).then(()=>this.producePadEvent("select",r.getPadPainter(),r))}s.winstate&&typeof window<"u"&&(s.winstate==="iconify"?window.blur():window.focus()),n&&this.sendResized(!0)}else console.log(`unrecognized msg ${e}`)}sendResized(t){if(!this.pad||typeof window>"u")return;let e=this.getPadWidth(),s=this.getPadHeight(),n=window.screenLeft,i=window.screenTop,r=window.outerWidth,o=window.outerHeight,a=this._online_fixed_size?1:0;t||(t=e>0&&s>0&&(this.pad.fCw!==e||this.pad.fCh!==s),t&&(this.pad.fCw=e,this.pad.fCh=s)),t&&this.sendWebsocket(`RESIZED:${JSON.stringify([n,i,r,o,e,s,a])}`)}clickPadButton(t,e){return t==="ToggleGed"?this.activateGed(this,null,"toggle"):t==="ToggleStatus"?this.activateStatusBar("toggle"):super.clickPadButton(t,e)}hasEventStatus(){return this.testUI5()?!1:this.brlayout?this.brlayout.hasStatus():S()?.hasStatusLine()??!1}canStatusBar(){return this.testUI5()||this.brlayout||S()}activateStatusBar(t){this.testUI5()||(this.brlayout?this.brlayout.createStatusLine(23,t):S()?.createStatusLine(23,t),this.processChanges("sbits",this))}showCanvasStatus(...t){if(this.testUI5())return;(this.brlayout||S()?.brlayout)?.showStatus(...t)}hasGed(){return this.testUI5()?!1:this.brlayout?.hasContent()??!1}removeGed(){this.testUI5()||(this.registerForPadEvents(null),this.ged_view&&(this.ged_view.getController().cleanupGed(),this.ged_view.destroy(),delete this.ged_view),this.brlayout?.deleteContent(!0),this.processChanges("sbits",this))}getUi5PanelData(){return{jsroot:{settings:I,create:_,parse:m,toJSON:b,loadScript:j,EAxisBits:B,getColorExec:G}}}activateGed(t,e,s){return f(this,null,function*(){if(this.testUI5()||!this.brlayout)return!1;if(this.brlayout.hasContent())return s==="toggle"||s===!1?this.removeGed():t?.getPadPainter()?.selectObjectPainter(t),!0;if(s===!1)return!1;let n=this.brlayout.createBrowserBtns();return p.createSVG(n,p.diamand,15,"toggle fix-pos mode","browser").style("margin","3px").on("click",()=>this.brlayout.toggleKind("fix")),p.createSVG(n,p.circle,15,"toggle float mode","browser").style("margin","3px").on("click",()=>this.brlayout.toggleKind("float")),p.createSVG(n,p.cross,15,"delete GED","browser").style("margin","3px").on("click",()=>this.removeGed()),this.brlayout.setBrowserContent("<div class='jsroot_browser_hierarchy' id='ged_placeholder'>Loading GED ...</div>"),this.brlayout.setBrowserTitle("GED"),this.brlayout.toggleBrowserKind(e||"float"),new Promise(i=>{U().then(r=>{y("#ged_placeholder").text(""),r.ui.require(["sap/ui/model/json/JSONModel","sap/ui/core/mvc/XMLView"],(o,a)=>{let h=new o({handle:null});a.create({viewName:"rootui5.canv.view.Ged",viewData:this.getUi5PanelData("Ged")}).then(c=>{c.setModel(h),c.placeAt("ged_placeholder"),this.ged_view=c,this.registerForPadEvents(c.getController().padEventsReceiver.bind(c.getController())),t?.getPadPainter()?.selectObjectPainter(t),this.processChanges("sbits",this),i(!0)})})})})})}showSection(t,e){return f(this,null,function*(){if(this.testUI5())return!1;switch(t){case"Menu":break;case"StatusBar":this.activateStatusBar(e);break;case"Editor":return this.activateGed(this,null,e);case"ToolBar":break;case"ToolTips":this.setTooltipAllowed(e);break}return!0})}startFitPanel(t){if(!this._websocket)return!1;let e=t?null:this._websocket.createChannel();return this.sendWebsocket("FITPANEL:"+(t?"standalone":e.getChannelId())),e}completeCanvasSnapDrawing(){this.pad&&(this.addPadInteractive(),typeof document<"u"&&!this.embed_canvas&&this._websocket&&(document.title=this.pad.fTitle),!this._all_sections_showed&&(this._all_sections_showed=!0,this._ignore_section_resize=!0,this.showSection("Menu",this.pad.TestBit(K)),this.showSection("StatusBar",this.pad.TestBit($)),this.showSection("ToolBar",this.pad.TestBit(V)),this.showSection("Editor",this.pad.TestBit(X)),this.showSection("ToolTips",this.pad.TestBit(Y)||this._highlight_connect),this._ignore_section_resize=!1))}processHighlightConnect(t){if(!t||t.length===0||!this._highlight_connect||!this._websocket||this.doingDraw()||!this._websocket.canSend(2))return;let e=t[0]||t[1];if(!e||!e.painter||!e.painter.snapid||!e.user_info)return;let s=e.painter.getPadPainter()||this;if(!s.snapid)return;let n=[s.snapid,e.painter.snapid,"0","0"];e.user_info.binx!==void 0&&e.user_info.biny!==void 0?(n[2]=e.user_info.binx.toString(),n[3]=e.user_info.biny.toString()):e.user_info.bin!==void 0&&(n[2]=e.user_info.bin.toString());let i=JSON.stringify(n);this._last_highlight_msg!==i&&(this._last_highlight_msg=i,this.sendWebsocket(`HIGHLIGHT:${i}`))}processChanges(t,e,s){if(!this._websocket||this._readonly||!this._websocket.canSend(2)||!x(t))return;let n="";switch(e||(e=this),t){case"sbits":n="STATUSBITS:"+this.getStatusBits();break;case"frame":case"zoom":d(e.getWebPadOptions)||(e=e.getPadPainter()),d(e.getWebPadOptions)&&(n="OPTIONS6:"+e.getWebPadOptions("only_this"));break;case"padpos":n="OPTIONS6:"+e.getWebPadOptions("with_subpads");break;case"drawopt":e.snapid&&(n="DRAWOPT:"+JSON.stringify([e.snapid.toString(),e.getDrawOpt()||""]));break;case"pave_moved":{let i=R(e);i&&(n="PRIMIT6:"+b(i));break}case"logx":case"logy":case"logz":{let i=e.getPadPainter();if(i?.snapid&&i?.pad){let r="SetLog"+t[3],o=i.pad["fLog"+t[3]];e=i,t=`exec:${r}(${o})`}break}}if(!n&&d(e?.getSnapId)&&t.slice(0,5)==="exec:"){let i=e.getSnapId(s);i&&(n="PRIMIT6:"+b({_typename:"TWebObjectOptions",snapid:i,opt:t.slice(5),fcust:"exec",fopt:[]}))}n?this._websocket.send(n):console.log(`Unprocessed changes ${t} for painter of ${e?.getObject()?._typename} subelem ${s}`)}selectActivePad(t,e,s){if(!this.snapid||!t)return;let n=null,i=!1,r=t.matchObjectType(A);t.snapid&&this._websocket&&(n={_typename:"TWebPadClick",padid:t.snapid.toString(),objid:"",x:-1,y:-1,dbl:!1}),!t.is_active_pad&&!r&&(i=!0,this.forEachPainterInPad(o=>o.drawActiveBorder(null,o===t),"pads")),e?.snapid!==void 0&&n&&(i=!0,n.objid=e.snapid.toString()),s&&n&&(i=!0,n.x=Math.round(s.x||0),n.y=Math.round(s.y||0),s.dbl&&(n.dbl=!0)),n&&(i||r)&&this.sendWebsocket("PADCLICKED:"+b(n))}getStatusBits(){let t=0;return this.hasEventStatus()&&(t|=$),this.hasGed()&&(t|=X),this.isTooltipAllowed()&&(t|=Y),this.use_openui&&(t|=K),t}produceJSON(t){let e=this.getObject(),s=e.fFillStyle===0,n=[],i=[];s&&(e.fFillStyle=1001),this.forEachPainterInPad(o=>{let a=o.getMainPainter(),h=o.getFramePainter();if(!d(a?.getHisto)||!d(a?.getDimension))return;let c=a.getHisto(),g=a.getDimension();if(!c?.fXaxis)return;let C=(T,u)=>{h?.zoomChangedInteractive(T)&&(n.push({axis:u,f:u.fFirst,l:u.fLast,b:u.fBits}),u.fFirst=a.getSelectIndex(T,"left",1),u.fLast=a.getSelectIndex(T,"right"),u.SetBit(B.kAxisRange,u.fFirst>0||u.fLast<u.fNbins))};C("x",c.fXaxis),g>1&&C("y",c.fYaxis),g>2&&C("z",c.fZaxis),g===2&&h?.zoomChangedInteractive("z")&&(i.push({hist:c,min:c.fMinimum,max:c.fMaximum}),c.fMinimum=h.zoom_zmin??h.zmin,c.fMaximum=h.zoom_zmax??h.zmax)},"pads"),this.normal_canvas||this.forEachPainterInPad(o=>{if(o.isSecondary())return;let a=o.getObject();a?._typename&&e.fPrimitives.Add(a,o.getDrawOpt())},"objects");let r=b(e,t);return s&&(e.fFillStyle=0),n.forEach(o=>{o.axis.fFirst=o.f,o.axis.fLast=o.l,o.axis.fBits=o.b}),i.forEach(o=>{o.hist.fMinimum=o.min,o.hist.fMaximum=o.max}),this.normal_canvas||e.fPrimitives.Clear(),r}resizeBrowser(t,e){!t||!e||this.isBatchMode()||this.embed_canvas||this.batch_mode||(D.qt6&&t>100&&e>60&&(t-=3,e-=30),this._websocket?.resizeWindow(t,e))}static draw(t,e,s){return f(this,null,function*(){let n=!e;n&&(e=_(P));let i=new l(t,e);if(i.checkSpecialsInPrimitives(e,!0),!n&&e.fCw&&e.fCh){let r=i.selectDom(),o;if(i.isBatchMode()){let a=r.property("_batch_use_canvsize");o=a||a===void 0}else{let a=r.node().getBoundingClientRect();o=!a.height&&a.width>.1*e.fCw}o&&(r.style("width",e.fCw+"px").style("height",e.fCh+"px").attr("width",e.fCw).attr("height",e.fCh),i._fixed_size=!0)}return i.decodeOptions(s),i.normal_canvas=!n,i.createCanvasSvg(0),i.addPadButtons(),n&&s.indexOf("noframe")<0&&J(i,null),z({pp:i,active:!0}),i.drawPrimitives().then(()=>(i.addPadInteractive(),i.showPadButtons(),i))})}};function H(l,t){return f(this,null,function*(){if(!l)return Promise.reject(Error("Painter not provided in ensureTCanvas"));let e=t===!1||t==="3d"?"noframe":"",s=()=>{if(e!=="noframe"||!d(l.getUserRanges))return null;let i=l.getUserRanges();if(!i)return null;let r=_(P),o=i.maxx-i.minx||1,a=i.maxy-i.miny||1;return r.fX1=i.minx-o*.1,r.fX2=i.maxx+o*.1,r.fY1=i.miny-a*.1,r.fY2=i.maxy+a*.1,r};return(l.getCanvSvg().empty()?v.draw(l.getDom(),s(),e):Promise.resolve(!0)).then(()=>(t!==!1&&l.getFrameSvg().selectChild(".main_layer").empty()&&!l.getFramePainter()&&J(l.getPadPainter(),null,t),l.addToPadPrimitives(),l))})}function ne(l,t){return f(this,null,function*(){let e=_(P),s=new v(l,e);return s.normal_canvas=!1,s.addPadButtons(),s.syncDraw(!0).then(()=>s.redrawPadSnap(t)).then(()=>(s.confirmDraw(),s.showPadButtons(),s))})}function re(l,t,e){return f(this,null,function*(){let s=new O(l,t);return s.mode3d=e==="3d",H(s,!1).then(()=>s.redraw())})}Object.assign(M.jsroot,{ensureTCanvas:H,TPadPainter:E,TCanvasPainter:v});export{v as a,H as b,ne as c,re as d};
