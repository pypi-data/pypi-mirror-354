import warnings

import numpy as np
import numpy.testing as npt
import pytest

import pynbody

results = {'v1':
               {'v': [-8.4318334, -8.53512723, -8.55756858, -8.57511408,
                      -8.58371421, -8.5901894, -8.59562547, -8.60183233,
                      -8.60873816, -8.61576714, -8.55612593, -8.6283355,
                      -8.63343331, -8.63761234, -8.64137716, -8.6478213,
                      -8.65455944, -8.66089945, -8.66683495, -8.67218406,
                      -8.6787931, -8.6859712, -8.69524977, -8.70577303,
                      -8.71720799, -8.7204877, -8.72185976, -8.72333649,
                      -8.72486276, -8.72648694, -8.72831905, -8.73036659,
                      -8.73255252, -8.73495712, -8.74607575, -8.76827435,
                      -8.79966459, -8.83563646, -8.87852575, -8.91488172,
                      -8.95398634, -8.99733218, -9.04262116, -9.09644248,
                      -9.12678031, -9.13415701, -9.11505472, -9.13137087,
                      -9.24140905, -9.42141794, -9.65949329, -10.02804599,
                      -10.59088623, -11.70415984],
                'i': [-9.37239259, -9.49326855, -9.51952974, -9.54006174,
                      -9.55072974, -9.55877876, -9.5655361, -9.57325155,
                      -9.58183588, -9.59057329, -9.53248631, -9.60619646,
                      -9.61253331, -9.61772807, -9.62240795, -9.63041837,
                      -9.63879424, -9.64667523, -9.65405338, -9.66070262,
                      -9.66891802, -9.67784079, -9.68937457, -9.70245555,
                      -9.71666983, -9.71929678, -9.71913538, -9.71896166,
                      -9.71878212, -9.71859106, -9.71837554, -9.71813468,
                      -9.71787754, -9.71759468, -9.7277067, -9.75135622,
                      -9.78479816, -9.82312117, -9.86881375, -9.90672349,
                      -9.94712072, -9.99189937, -10.03876089, -10.09448749,
                      -10.11662235, -10.10388037, -10.00348487, -9.93271987,
                      -9.99919269, -10.15850442, -10.36796682, -10.72379125,
                      -11.12270991, -11.56999736],
                'I': [
                    -9.37239259, -9.49326855, -9.51952974, -9.54006174,  # tests case-insensitivity of old tables
                    -9.55072974, -9.55877876, -9.5655361, -9.57325155,
                    -9.58183588, -9.59057329, -9.53248631, -9.60619646,
                    -9.61253331, -9.61772807, -9.62240795, -9.63041837,
                    -9.63879424, -9.64667523, -9.65405338, -9.66070262,
                    -9.66891802, -9.67784079, -9.68937457, -9.70245555,
                    -9.71666983, -9.71929678, -9.71913538, -9.71896166,
                    -9.71878212, -9.71859106, -9.71837554, -9.71813468,
                    -9.71787754, -9.71759468, -9.7277067, -9.75135622,
                    -9.78479816, -9.82312117, -9.86881375, -9.90672349,
                    -9.94712072, -9.99189937, -10.03876089, -10.09448749,
                    -10.11662235, -10.10388037, -10.00348487, -9.93271987,
                    -9.99919269, -10.15850442, -10.36796682, -10.72379125,
                    -11.12270991, -11.56999736]
                },
           'default':
               {'V': [-8.07044055, -7.6684716, -8.11050623, -7.43036633,
                      -7.98558086, -8.12423676, -7.48891951, -7.82376719,
                      -7.4640934, -7.85963566, -7.54598952, -7.52076613,
                      -7.60114124, -7.65311891, -8.04710357, -7.65567522,
                      -7.59460436, -7.5412884, -7.42537524, -7.46917349,
                      -7.42764587, -7.53253068, -7.51636797, -7.51673231,
                      -7.81325786, -7.97850874, -7.88096198, -7.5336551,
                      -7.42924344, -7.72160449, -7.970906, -7.46681441,
                      -7.47444665, -7.63403888, -7.48756181, -7.56878366,
                      -7.53123368, -7.84128388, -7.63290055, -7.71007244,
                      -7.67678585, -7.71653685, -7.94830949, -7.80630891,
                      -8.15887015, -8.01573481, -8.06250937, -8.33939463,
                      -8.43180135, -8.70001321, -9.02997435, -9.20667608,
                      -10.05955829, -12.43626795],
                'i': [
                    -8.53842232, -8.29436497, -8.53842232, -8.13442232,  # <-- SDSS i-band (AB-calibrated)
                    -8.45912228, -8.54547781, -8.17561435, -8.38269271,
                    -8.16617511, -8.40224103, -8.1880548, -8.20541502,
                    -8.25116274, -8.28462338, -8.52311999, -8.28818846,
                    -8.25405965, -8.22849056, -8.20219366, -8.20620194,
                    -8.21115431, -8.23412176, -8.23026229, -8.23521501,
                    -8.40386869, -8.49747786, -8.44806814, -8.26550475,
                    -8.27482598, -8.35335944, -8.50586758, -8.30843885,
                    -8.32178871, -8.34264223, -8.35098734, -8.36378443,
                    -8.38188033, -8.46537776, -8.42734233, -8.45215822,
                    -8.48062601, -8.51218138, -8.59112634, -8.58806429,
                    -8.74969508, -8.69431225, -8.78952554, -8.9488792,
                    -9.05295059, -9.26942307, -9.50410826, -9.78108974,
                    -10.26182162, -12.73000575],
                'I': [-8.92671817, -8.77598268, -8.96539026, -8.65203951,  # <-- Vega-calibrated
                      -8.91344608, -8.97864322, -8.68837508, -8.85991075,
                      -8.6762603, -8.87751396, -8.69698988, -8.71168924,
                      -8.75873397, -8.78691322, -8.96511813, -8.79045389,
                      -8.7585043, -8.72856189, -8.65401488, -8.68560753,
                      -8.65613441, -8.72716479, -8.71898895, -8.72065071,
                      -8.88291062, -8.9554383, -8.92133141, -8.7368417,
                      -8.66236188, -8.85230259, -8.97663062, -8.69341899,
                      -8.70055413, -8.81333585, -8.71390741, -8.77301384,
                      -8.74976204, -8.95069591, -8.82794887, -8.88493295,
                      -8.86764611, -8.90054536, -9.05370243, -8.98209003,
                      -9.20401939, -9.13786686, -9.19498955, -9.38920772,
                      -9.50019643, -9.7336607, -10.02028179, -10.16524934,
                      -10.7032577, -13.14923625]
                }
           }


@pytest.fixture
def testfile():
    f = pynbody.load("testdata/gasoline_ahf/g15784.lr.01024.gz")

    with warnings.catch_warnings(record=True) as w:
        warnings.filterwarnings('ignore')
        f.st['massform']  # noqa - trigger starlog load and ignore any warnings

    return f


def test_luminosity(testfile):
    for ssp_name, tests in results.items():
        with pynbody.analysis.luminosity.use_custom_ssp_table(ssp_name):
            for band, result in tests.items():
                mag = pynbody.analysis.luminosity.calc_mags(testfile.st, band=band)
                print(repr(mag[::5000]))
                npt.assert_allclose(mag[::5000], result, rtol=1e-5)


@pytest.mark.filterwarnings('ignore::RuntimeWarning')
def test_halo_magnitude(testfile):
    expected_results = {'V': -21.89507, 'U': -21.413841, 'u': -20.937146}
    h = testfile.halos()
    for band, expected in expected_results.items():
        print(h[0].st[band + "_mag"])
        npt.assert_allclose(pynbody.analysis.luminosity.halo_mag(h[0], band), expected)


@pytest.mark.filterwarnings('ignore::RuntimeWarning')
def test_halo_half_light(testfile):
    expected_results = {('V', False): 3.830666, ('i', False): 3.414289,
                        ('i', True): 3.123489}
    testfile.physical_units()
    h = testfile.halos()
    pynbody.analysis.faceon(h[0])
    for (band, cylindrical), expected in expected_results.items():
        npt.assert_allclose(pynbody.analysis.luminosity.half_light_r(h[0], band, cylindrical=cylindrical), expected,
                            rtol=1e-5)


def test_ssp_table_recovers_input_from_file():
    # Define a controlled snapshot and fill it up with first numbers from default_ssp file
    ssp_tester = pynbody.new(stars=1)
    default_ssp_file = np.loadtxt("../../pynbody/pynbody/analysis/default_ssp.txt")

    ssp_tester.st['age'] = pynbody.array.SimArray(default_ssp_file[0, 0], units="yr")
    ssp_tester.st['metals'] = pynbody.array.SimArray(default_ssp_file[0, 1], units="1")
    ssp_tester.st['mass'] = pynbody.array.SimArray(1.0, units="Msol")

    # Check that the pynbody-defined table actually recovers the magnitude number from the same row
    # See Issue #900
    table = pynbody.analysis.luminosity.get_current_ssp_table()
    npt.assert_allclose(default_ssp_file[0, 5], table(ssp_tester, 'V'))
    npt.assert_allclose(default_ssp_file[0, 6], table(ssp_tester, 'R'))
